<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RePlugin集成ARouter | FSA全栈行动</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-3568502583266202" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script src="/js/global.js"></script>
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?885476c2eae58d4aee1ab7fcfb548adb";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
      </script>
    <meta name="description" content="分享Android、iOS、Python、Vue等技术资讯、学习笔记，成功有梦想的全栈工程师，欢迎关注。">
    <meta name="keywords" content="FSA全栈行动,LinXunFeng,GitLqr,全栈技术博客,移动端,web前端,后端开发,前端框架,web前端,Android框架,iOS框架,Flutter框架,Python框架,Vue框架,技术文档,学习,面试,Java,Kotlin,object-c,Swift,Kotlin,Dart,JavaScript,js,ES6,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="code-Cyx4xlZmzI">
    <meta name="google-site-verification" content="_0KO4KbxdSwB-TPRQ8bRqmML8dnrx5G82GhQNZlR4HU">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.f24a96ee.css" as="style"><link rel="preload" href="/assets/js/app.89dd8fe9.js" as="script"><link rel="preload" href="/assets/js/2.d8b68cf2.js" as="script"><link rel="preload" href="/assets/js/70.94bc99f2.js" as="script"><link rel="prefetch" href="/assets/js/10.d73c7d01.js"><link rel="prefetch" href="/assets/js/100.9ebeff21.js"><link rel="prefetch" href="/assets/js/101.692c940a.js"><link rel="prefetch" href="/assets/js/102.e2f371dd.js"><link rel="prefetch" href="/assets/js/103.915d0f88.js"><link rel="prefetch" href="/assets/js/104.28cfb05a.js"><link rel="prefetch" href="/assets/js/105.093417ac.js"><link rel="prefetch" href="/assets/js/106.3cbd2542.js"><link rel="prefetch" href="/assets/js/107.64783dba.js"><link rel="prefetch" href="/assets/js/108.743f1185.js"><link rel="prefetch" href="/assets/js/109.f19942bd.js"><link rel="prefetch" href="/assets/js/11.1bcda3a0.js"><link rel="prefetch" href="/assets/js/110.8af5f48d.js"><link rel="prefetch" href="/assets/js/111.8bd3a603.js"><link rel="prefetch" href="/assets/js/112.561e95e5.js"><link rel="prefetch" href="/assets/js/113.42ab2dec.js"><link rel="prefetch" href="/assets/js/114.da490007.js"><link rel="prefetch" href="/assets/js/115.d0fa7982.js"><link rel="prefetch" href="/assets/js/116.d400f75b.js"><link rel="prefetch" href="/assets/js/117.33c3b92f.js"><link rel="prefetch" href="/assets/js/118.df140fae.js"><link rel="prefetch" href="/assets/js/119.33296c42.js"><link rel="prefetch" href="/assets/js/12.9d9f5ba0.js"><link rel="prefetch" href="/assets/js/120.93d74e02.js"><link rel="prefetch" href="/assets/js/121.d5a2cac0.js"><link rel="prefetch" href="/assets/js/122.efe277e1.js"><link rel="prefetch" href="/assets/js/123.3b157fe3.js"><link rel="prefetch" href="/assets/js/124.2e29e0b5.js"><link rel="prefetch" href="/assets/js/125.30306635.js"><link rel="prefetch" href="/assets/js/126.939778b2.js"><link rel="prefetch" href="/assets/js/127.0002e811.js"><link rel="prefetch" href="/assets/js/128.693e08d4.js"><link rel="prefetch" href="/assets/js/129.e6b34ba6.js"><link rel="prefetch" href="/assets/js/13.2af8a90e.js"><link rel="prefetch" href="/assets/js/130.a5c99ad8.js"><link rel="prefetch" href="/assets/js/131.b076989a.js"><link rel="prefetch" href="/assets/js/132.a7a08de6.js"><link rel="prefetch" href="/assets/js/133.d8849bbf.js"><link rel="prefetch" href="/assets/js/134.97755c83.js"><link rel="prefetch" href="/assets/js/135.106ce0b9.js"><link rel="prefetch" href="/assets/js/136.52554b90.js"><link rel="prefetch" href="/assets/js/137.33299b33.js"><link rel="prefetch" href="/assets/js/138.9ff58cd6.js"><link rel="prefetch" href="/assets/js/139.7cee0069.js"><link rel="prefetch" href="/assets/js/14.dfac8018.js"><link rel="prefetch" href="/assets/js/140.8871658b.js"><link rel="prefetch" href="/assets/js/141.8ebeb156.js"><link rel="prefetch" href="/assets/js/142.a63d6162.js"><link rel="prefetch" href="/assets/js/143.98b3a651.js"><link rel="prefetch" href="/assets/js/144.7349ca77.js"><link rel="prefetch" href="/assets/js/145.858d9452.js"><link rel="prefetch" href="/assets/js/146.a032b581.js"><link rel="prefetch" href="/assets/js/147.db1005fb.js"><link rel="prefetch" href="/assets/js/148.20fde4db.js"><link rel="prefetch" href="/assets/js/149.79e591ff.js"><link rel="prefetch" href="/assets/js/15.525d5dfe.js"><link rel="prefetch" href="/assets/js/150.9969db2c.js"><link rel="prefetch" href="/assets/js/151.84e062f1.js"><link rel="prefetch" href="/assets/js/152.fca6b962.js"><link rel="prefetch" href="/assets/js/153.e362f89c.js"><link rel="prefetch" href="/assets/js/154.fcadffca.js"><link rel="prefetch" href="/assets/js/155.51be41cc.js"><link rel="prefetch" href="/assets/js/156.670b7225.js"><link rel="prefetch" href="/assets/js/157.c170060f.js"><link rel="prefetch" href="/assets/js/158.79568bb0.js"><link rel="prefetch" href="/assets/js/159.7ba75b76.js"><link rel="prefetch" href="/assets/js/16.d8737ba6.js"><link rel="prefetch" href="/assets/js/160.46fcebf3.js"><link rel="prefetch" href="/assets/js/161.91a91f56.js"><link rel="prefetch" href="/assets/js/162.9a4236bd.js"><link rel="prefetch" href="/assets/js/163.0e3f3436.js"><link rel="prefetch" href="/assets/js/164.e23d14e9.js"><link rel="prefetch" href="/assets/js/165.a4a8a42e.js"><link rel="prefetch" href="/assets/js/166.cc250455.js"><link rel="prefetch" href="/assets/js/167.d295272b.js"><link rel="prefetch" href="/assets/js/168.c6919fcc.js"><link rel="prefetch" href="/assets/js/169.26db219c.js"><link rel="prefetch" href="/assets/js/17.a33331a9.js"><link rel="prefetch" href="/assets/js/170.ef03e7ee.js"><link rel="prefetch" href="/assets/js/171.39efa101.js"><link rel="prefetch" href="/assets/js/172.79693a1c.js"><link rel="prefetch" href="/assets/js/173.76c28bf5.js"><link rel="prefetch" href="/assets/js/174.11305f41.js"><link rel="prefetch" href="/assets/js/175.280b1336.js"><link rel="prefetch" href="/assets/js/176.a3389684.js"><link rel="prefetch" href="/assets/js/177.d281dbdd.js"><link rel="prefetch" href="/assets/js/178.18bcec8c.js"><link rel="prefetch" href="/assets/js/179.53f26880.js"><link rel="prefetch" href="/assets/js/18.33037d59.js"><link rel="prefetch" href="/assets/js/180.444a244e.js"><link rel="prefetch" href="/assets/js/181.255a3b9b.js"><link rel="prefetch" href="/assets/js/182.27de39cd.js"><link rel="prefetch" href="/assets/js/183.1c6eb065.js"><link rel="prefetch" href="/assets/js/184.9fbd7ef7.js"><link rel="prefetch" href="/assets/js/185.92d0c99d.js"><link rel="prefetch" href="/assets/js/186.451a3696.js"><link rel="prefetch" href="/assets/js/187.85e6045f.js"><link rel="prefetch" href="/assets/js/188.cc053993.js"><link rel="prefetch" href="/assets/js/189.4d003779.js"><link rel="prefetch" href="/assets/js/19.c55f5d6a.js"><link rel="prefetch" href="/assets/js/190.1c2e71d8.js"><link rel="prefetch" href="/assets/js/191.634043a1.js"><link rel="prefetch" href="/assets/js/192.dbc67b6d.js"><link rel="prefetch" href="/assets/js/193.2d74c614.js"><link rel="prefetch" href="/assets/js/194.3aeb89a1.js"><link rel="prefetch" href="/assets/js/195.233df07d.js"><link rel="prefetch" href="/assets/js/196.9d599622.js"><link rel="prefetch" href="/assets/js/197.632b3abd.js"><link rel="prefetch" href="/assets/js/198.cac18f06.js"><link rel="prefetch" href="/assets/js/199.78027fe7.js"><link rel="prefetch" href="/assets/js/20.8ca01468.js"><link rel="prefetch" href="/assets/js/200.33fa29d5.js"><link rel="prefetch" href="/assets/js/201.e33bc32b.js"><link rel="prefetch" href="/assets/js/202.25cc481b.js"><link rel="prefetch" href="/assets/js/203.ed78dff9.js"><link rel="prefetch" href="/assets/js/204.fcca47fe.js"><link rel="prefetch" href="/assets/js/205.792301d2.js"><link rel="prefetch" href="/assets/js/206.5a52012e.js"><link rel="prefetch" href="/assets/js/207.cf3cf2b6.js"><link rel="prefetch" href="/assets/js/208.5af0e40a.js"><link rel="prefetch" href="/assets/js/209.c8a2fe43.js"><link rel="prefetch" href="/assets/js/21.1f7af77b.js"><link rel="prefetch" href="/assets/js/210.7bfaf237.js"><link rel="prefetch" href="/assets/js/211.247dd9b5.js"><link rel="prefetch" href="/assets/js/212.ae89e157.js"><link rel="prefetch" href="/assets/js/213.9fad0ea5.js"><link rel="prefetch" href="/assets/js/214.815c7524.js"><link rel="prefetch" href="/assets/js/215.4b2f613c.js"><link rel="prefetch" href="/assets/js/216.121e0d19.js"><link rel="prefetch" href="/assets/js/217.1dc60254.js"><link rel="prefetch" href="/assets/js/218.0dcf1036.js"><link rel="prefetch" href="/assets/js/219.7deb69da.js"><link rel="prefetch" href="/assets/js/22.ec455aec.js"><link rel="prefetch" href="/assets/js/220.54a1abd8.js"><link rel="prefetch" href="/assets/js/221.af145d30.js"><link rel="prefetch" href="/assets/js/222.5a651d9c.js"><link rel="prefetch" href="/assets/js/223.974de0a4.js"><link rel="prefetch" href="/assets/js/224.3ed07145.js"><link rel="prefetch" href="/assets/js/225.101bfb1e.js"><link rel="prefetch" href="/assets/js/226.626f0a86.js"><link rel="prefetch" href="/assets/js/227.946eb7f2.js"><link rel="prefetch" href="/assets/js/228.ae716b8b.js"><link rel="prefetch" href="/assets/js/229.cc7fd76a.js"><link rel="prefetch" href="/assets/js/23.d3a842bc.js"><link rel="prefetch" href="/assets/js/230.d07aee3e.js"><link rel="prefetch" href="/assets/js/231.57777b4f.js"><link rel="prefetch" href="/assets/js/232.f2c944e6.js"><link rel="prefetch" href="/assets/js/233.5a4875bb.js"><link rel="prefetch" href="/assets/js/234.46ba90ac.js"><link rel="prefetch" href="/assets/js/235.2bfb122a.js"><link rel="prefetch" href="/assets/js/236.eeaacc06.js"><link rel="prefetch" href="/assets/js/237.de37d18d.js"><link rel="prefetch" href="/assets/js/238.42364597.js"><link rel="prefetch" href="/assets/js/239.9db374c8.js"><link rel="prefetch" href="/assets/js/24.39bed4a8.js"><link rel="prefetch" href="/assets/js/240.89c3ee2e.js"><link rel="prefetch" href="/assets/js/241.0f4c8ed2.js"><link rel="prefetch" href="/assets/js/242.c734055a.js"><link rel="prefetch" href="/assets/js/243.66ec11cc.js"><link rel="prefetch" href="/assets/js/244.daf09ac0.js"><link rel="prefetch" href="/assets/js/245.bf462b4f.js"><link rel="prefetch" href="/assets/js/246.0c37691b.js"><link rel="prefetch" href="/assets/js/247.69ce578e.js"><link rel="prefetch" href="/assets/js/248.93884cf4.js"><link rel="prefetch" href="/assets/js/249.d8650d04.js"><link rel="prefetch" href="/assets/js/25.ffefd3d8.js"><link rel="prefetch" href="/assets/js/250.d86c0daf.js"><link rel="prefetch" href="/assets/js/251.cade1ebd.js"><link rel="prefetch" href="/assets/js/252.c0f15462.js"><link rel="prefetch" href="/assets/js/253.8ffc4efe.js"><link rel="prefetch" href="/assets/js/254.ec539fae.js"><link rel="prefetch" href="/assets/js/255.46092c1b.js"><link rel="prefetch" href="/assets/js/256.ba5f95e7.js"><link rel="prefetch" href="/assets/js/257.d09940c6.js"><link rel="prefetch" href="/assets/js/26.ad30bb86.js"><link rel="prefetch" href="/assets/js/27.dbb4126e.js"><link rel="prefetch" href="/assets/js/28.8bd9d307.js"><link rel="prefetch" href="/assets/js/29.1a71e08e.js"><link rel="prefetch" href="/assets/js/3.5382cf65.js"><link rel="prefetch" href="/assets/js/30.42d97bb2.js"><link rel="prefetch" href="/assets/js/31.30f900c9.js"><link rel="prefetch" href="/assets/js/32.a5df6c36.js"><link rel="prefetch" href="/assets/js/33.87e6227d.js"><link rel="prefetch" href="/assets/js/34.bf2570c3.js"><link rel="prefetch" href="/assets/js/35.e5a1aa99.js"><link rel="prefetch" href="/assets/js/36.b797468c.js"><link rel="prefetch" href="/assets/js/37.f30f1cbb.js"><link rel="prefetch" href="/assets/js/38.9ff8e9d7.js"><link rel="prefetch" href="/assets/js/39.bae582ef.js"><link rel="prefetch" href="/assets/js/4.f21084fd.js"><link rel="prefetch" href="/assets/js/40.5a3d5763.js"><link rel="prefetch" href="/assets/js/41.98bc5820.js"><link rel="prefetch" href="/assets/js/42.f99b3098.js"><link rel="prefetch" href="/assets/js/43.71c556d1.js"><link rel="prefetch" href="/assets/js/44.8620cf19.js"><link rel="prefetch" href="/assets/js/45.5f6a052b.js"><link rel="prefetch" href="/assets/js/46.e92d277b.js"><link rel="prefetch" href="/assets/js/47.692c8c2f.js"><link rel="prefetch" href="/assets/js/48.6021bd70.js"><link rel="prefetch" href="/assets/js/49.01f4c638.js"><link rel="prefetch" href="/assets/js/5.fb735bd1.js"><link rel="prefetch" href="/assets/js/50.0638776b.js"><link rel="prefetch" href="/assets/js/51.32974ba1.js"><link rel="prefetch" href="/assets/js/52.df18a9eb.js"><link rel="prefetch" href="/assets/js/53.8a345ed9.js"><link rel="prefetch" href="/assets/js/54.6cb485b7.js"><link rel="prefetch" href="/assets/js/55.122f6f8f.js"><link rel="prefetch" href="/assets/js/56.df4b0bc5.js"><link rel="prefetch" href="/assets/js/57.4b1ccf3a.js"><link rel="prefetch" href="/assets/js/58.14f76c64.js"><link rel="prefetch" href="/assets/js/59.0b24f777.js"><link rel="prefetch" href="/assets/js/6.95ba2307.js"><link rel="prefetch" href="/assets/js/60.ac9296c1.js"><link rel="prefetch" href="/assets/js/61.ecdd48ba.js"><link rel="prefetch" href="/assets/js/62.db6f90d9.js"><link rel="prefetch" href="/assets/js/63.f15fa795.js"><link rel="prefetch" href="/assets/js/64.a054754c.js"><link rel="prefetch" href="/assets/js/65.67152915.js"><link rel="prefetch" href="/assets/js/66.41247740.js"><link rel="prefetch" href="/assets/js/67.8b05d7e5.js"><link rel="prefetch" href="/assets/js/68.f0fb2148.js"><link rel="prefetch" href="/assets/js/69.84d33152.js"><link rel="prefetch" href="/assets/js/7.4ea2a7cb.js"><link rel="prefetch" href="/assets/js/71.eb93165f.js"><link rel="prefetch" href="/assets/js/72.544b7f42.js"><link rel="prefetch" href="/assets/js/73.233ea30b.js"><link rel="prefetch" href="/assets/js/74.74193aec.js"><link rel="prefetch" href="/assets/js/75.58090f19.js"><link rel="prefetch" href="/assets/js/76.70d46d82.js"><link rel="prefetch" href="/assets/js/77.ab758303.js"><link rel="prefetch" href="/assets/js/78.ba683fe1.js"><link rel="prefetch" href="/assets/js/79.08d16d3a.js"><link rel="prefetch" href="/assets/js/8.ade06460.js"><link rel="prefetch" href="/assets/js/80.3dfda944.js"><link rel="prefetch" href="/assets/js/81.b7dd192e.js"><link rel="prefetch" href="/assets/js/82.f3160b2d.js"><link rel="prefetch" href="/assets/js/83.5e7d0691.js"><link rel="prefetch" href="/assets/js/84.8141702f.js"><link rel="prefetch" href="/assets/js/85.132eb564.js"><link rel="prefetch" href="/assets/js/86.6d6d3f06.js"><link rel="prefetch" href="/assets/js/87.3c287970.js"><link rel="prefetch" href="/assets/js/88.ab381cae.js"><link rel="prefetch" href="/assets/js/89.3fc1949f.js"><link rel="prefetch" href="/assets/js/9.e286e9f3.js"><link rel="prefetch" href="/assets/js/90.95e4cac8.js"><link rel="prefetch" href="/assets/js/91.c5c18896.js"><link rel="prefetch" href="/assets/js/92.5883fb02.js"><link rel="prefetch" href="/assets/js/93.0a36ee68.js"><link rel="prefetch" href="/assets/js/94.71a7723b.js"><link rel="prefetch" href="/assets/js/95.48f02b92.js"><link rel="prefetch" href="/assets/js/96.6f336fcd.js"><link rel="prefetch" href="/assets/js/97.d6a61a44.js"><link rel="prefetch" href="/assets/js/98.8f3aeef7.js"><link rel="prefetch" href="/assets/js/99.76c3493b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f24a96ee.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131112211.jpg" alt="FSA全栈行动" class="logo"> <span class="site-name can-hide">FSA全栈行动</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="移动端" class="dropdown-title"><a href="/mobile/" class="link-title">移动端</a> <span class="title" style="display:none;">移动端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>移动端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/61d6a8/" class="nav-link">Android</a></li><li class="dropdown-subitem"><a href="/pages/cb27eb/" class="nav-link">iOS</a></li><li class="dropdown-subitem"><a href="/pages/61cc74/" class="nav-link">Flutter</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/kotlin/" class="nav-link">《Kotlin快速入门进阶》笔记</a></li><li class="dropdown-subitem"><a href="/note/flutter/" class="nav-link">《Flutter从入门到实战》笔记</a></li><li class="dropdown-subitem"><a href="/note/flutter/lxf/review/" class="nav-link">《Flutter复习》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><a href="/backend/" class="nav-link">后端</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="内功心法" class="dropdown-title"><a href="/power/" class="link-title">内功心法</a> <span class="title" style="display:none;">内功心法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/designpattern/" class="nav-link">《深入浅出设计模式Java版》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ea5b48/" class="nav-link">逆向</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="About" class="dropdown-title"><!----> <span class="title" style="display:;">About</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/LinXunFeng/" class="nav-link">LinXunFeng</a></li><li class="dropdown-item"><!----> <a href="/about/GitLqr/" class="nav-link">GitLqr</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131111432.png"> <div class="blogger-info"><h3>公众号：FSA全栈行动</h3> <span>记录学习过程中的知识</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="移动端" class="dropdown-title"><a href="/mobile/" class="link-title">移动端</a> <span class="title" style="display:none;">移动端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>移动端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/61d6a8/" class="nav-link">Android</a></li><li class="dropdown-subitem"><a href="/pages/cb27eb/" class="nav-link">iOS</a></li><li class="dropdown-subitem"><a href="/pages/61cc74/" class="nav-link">Flutter</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/kotlin/" class="nav-link">《Kotlin快速入门进阶》笔记</a></li><li class="dropdown-subitem"><a href="/note/flutter/" class="nav-link">《Flutter从入门到实战》笔记</a></li><li class="dropdown-subitem"><a href="/note/flutter/lxf/review/" class="nav-link">《Flutter复习》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><a href="/backend/" class="nav-link">后端</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="内功心法" class="dropdown-title"><a href="/power/" class="link-title">内功心法</a> <span class="title" style="display:none;">内功心法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/designpattern/" class="nav-link">《深入浅出设计模式Java版》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/ea5b48/" class="nav-link">逆向</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="About" class="dropdown-title"><!----> <span class="title" style="display:;">About</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/LinXunFeng/" class="nav-link">LinXunFeng</a></li><li class="dropdown-item"><!----> <a href="/about/GitLqr/" class="nav-link">GitLqr</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AndroidUI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android第三方SDK</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android混淆</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android仓库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android新闻</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android系统开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android源码</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android注解AOP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android脚本</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AndroidTv开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AndroidNDK</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android音视频</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android热修复</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android云游戏</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Android插件化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>DroidPlugin</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>RePlugin</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/399558/" class="sidebar-link">RePlugin集成Fresco</a></li><li><a href="/pages/4e6b65/" class="sidebar-link">RePlugin强制退出App</a></li><li><a href="/pages/f63a8b/" class="sidebar-link">RePlugin集成AndroidAutoSize</a></li><li><a href="/pages/cd4aeb/" aria-current="page" class="active sidebar-link">RePlugin集成ARouter</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/cd4aeb/#一、功能需求" class="sidebar-link">一、功能需求</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/cd4aeb/#_1、组件解耦-arouter" class="sidebar-link">1、组件解耦 (ARouter)</a></li><li class="sidebar-sub-header level3"><a href="/pages/cd4aeb/#_2、插件化-replugin" class="sidebar-link">2、插件化 (RePlugin)</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/cd4aeb/#二、问题与解决方案" class="sidebar-link">二、问题与解决方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/cd4aeb/#_1、arouter-初始化失败" class="sidebar-link">1、ARouter 初始化失败</a></li><li class="sidebar-sub-header level3"><a href="/pages/cd4aeb/#_2、activity-跳转失败" class="sidebar-link">2、Activity 跳转失败</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/cd4aeb/#三、litearouter" class="sidebar-link">三、LiteARouter</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/cd4aeb/#_1、arouter-compiler-分析" class="sidebar-link">1、arouter-compiler 分析</a></li><li class="sidebar-sub-header level3"><a href="/pages/cd4aeb/#_2、logisticscenter-分析" class="sidebar-link">2、LogisticsCenter 分析</a></li><li class="sidebar-sub-header level3"><a href="/pages/cd4aeb/#_3、logisticscenter-改造" class="sidebar-link">3、LogisticsCenter 改造</a></li><li class="sidebar-sub-header level3"><a href="/pages/cd4aeb/#_4、arouter-compiler-改造" class="sidebar-link">4、arouter-compiler 改造</a></li></ul></li></ul></li><li><a href="/pages/1195b1/" class="sidebar-link">RePluginX - 兼容AndroidX并加入新特性开发纪要</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOSUI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS底层原理与应用</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS组件化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS音视频</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS疑难杂症</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS之Swift</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS之RxSwift</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS开源项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>iOS逆向</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flutter开发</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/mobile/#移动端" data-v-06225672>移动端</a></li><li data-v-06225672><a href="/mobile/#Android插件化" data-v-06225672>Android插件化</a></li><li data-v-06225672><a href="/mobile/#RePlugin" data-v-06225672>RePlugin</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/GitLqr" target="_blank" title="作者" class="beLink" data-v-06225672>GitLqr</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-04-12</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">RePlugin集成ARouter<!----></h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <center>欢迎关注微信公众号：<a href="https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/FSA_QR_bottom.png">[FSA全栈行动 👋]</a><center>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h2 id="一、功能需求"><a href="#一、功能需求" class="header-anchor">#</a> 一、功能需求</h2> <h3 id="_1、组件解耦-arouter"><a href="#_1、组件解耦-arouter" class="header-anchor">#</a> 1、组件解耦 (ARouter)</h3> <p>阿里开源的 <a href="https://github.com/alibaba/ARouter/" target="_blank" rel="noopener noreferrer">ARouter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 在组件化开发中这个库相当有用，其核心功能就是组件解耦，比如以往要跳转另一个 Activity 时，会使用如下代码：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> OtherActivity<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
<span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span>
</code></pre></div><p>这样的代码意味着耦合性极强，当前的 Activity 代码层面上直接引用了 OtherActivity，当项目中应用了模块化开发（Module 之间不直接依赖）或多渠道变体（不同渠道指定不同的 src 目录）时，将会导致 OtherActivity 无法引用，这时工程就会报错了，而使用 ARouter 时，上述代码可以转变成如下代码：</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code>ARouter<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;/module2/other&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">navigation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token annotation builtin">@Route</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">&quot;/module2/other&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">class</span> OtherActivity <span class="token operator">:</span> <span class="token function">BaseActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>很显示，使用了 ARouter 之后，Activity 之间不再存在代码级引用，这就是组件解耦。ARouter 还支持 Fragment，更多使用方式请查看官方文档: <a href="https://github.com/alibaba/ARouter/blob/master/README_CN.md" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/ARouter/blob/master/README_CN.md<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_2、插件化-replugin"><a href="#_2、插件化-replugin" class="header-anchor">#</a> 2、插件化 (RePlugin)</h3> <p>项目的架构设计涉及到插件化，我们使用的是 <a href="https://github.com/Qihoo360/RePlugin/" target="_blank" rel="noopener noreferrer">RePlugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，当然，每个公司对 RePlugin 的使用方式可能是不一样的，大致分为以下两种：</p> <ul><li>方式一： 宿主是主 app，包含主要的业务功能，只一些小功能需要通过插件方式动态更新。</li> <li>方式二： 宿主是马甲包，插件才是主 app，宿主 apk 只管一件事：更新主 app 插件。</li></ul> <p>这里，我们基于方式二来使用 RePlugin，因为方式二中主 app 是插件，涉及大量业务逻辑，并且工程会用到多渠道变体（不同渠道指定不同的 src 目录），所以，我们需要在插件中使用 ARouter，而宿主的功能很简单，用不到 ARouter。</p> <p><strong>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;注意：以下所有的分析都以此为基础&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</strong></p> <h2 id="二、问题与解决方案"><a href="#二、问题与解决方案" class="header-anchor">#</a> 二、问题与解决方案</h2> <p>按照 ARouter 的官方文档，在插件工程中对 ARouter 进行了依赖，作为单品时，所有功能都正常使用，但作为插件时，就完全失效了~ 界面提示：<code>There's no route matched! Path = [/arouter/service/interceptor] Group = [arouter]</code></p> <h3 id="_1、arouter-初始化失败"><a href="#_1、arouter-初始化失败" class="header-anchor">#</a> 1、ARouter 初始化失败</h3> <p>在 ARouter 的 issue 中也有很多 issue 提到与插件化框架搭配时出了问题，官方的回应表示对 RePlugin 等插件化框架支持不好，相关 issue 有：</p> <ul><li><a href="https://github.com/alibaba/ARouter/issues/714" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/ARouter/issues/714<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/alibaba/ARouter/issues/281" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/ARouter/issues/281<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/alibaba/ARouter/issues/172" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/ARouter/issues/172<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>以下是 app 分别作为单品或插件时 ARouter 的日志输出：</p> <div class="language- extra-class"><pre class="language-text"><code>// &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 单品日志输出
I/ARouter::: ARouter openLog[ ]
I/ARouter::: ARouter openDebug[ ]
I/ARouter::: ARouter init start.[ ]
I/ARouter::: Run with debug mode or new install, rebuild router map.[ ]
I/ARouter::: VM with name 'Android' has multidex support
E/ARouter::: InstantRun support error, com.android.tools.fd.runtime.Paths
I/ARouter::: Thread production, name is [ARouter task pool No.1, thread No.1][ ]
D/ARouter::: Filter 6 classes by packageName &lt;com.alibaba.android.arouter.routes&gt;
I/ARouter::: Find router map finished, map size = 6, cost 43 ms.[ ]
I/ARouter::: Load root element finished, cost 4 ms.[ ]
D/ARouter::: LogisticsCenter has already been loaded, GroupIndex[2], InterceptorIndex[0], ProviderIndex[2][ ]
I/ARouter::: ARouter init success![ ]
D/ARouter::: The group [arouter] starts loading, trigger by [/arouter/service/interceptor][ ]
D/ARouter::: The group [arouter] has already been loaded, trigger by [/arouter/service/interceptor][ ]
I/ARouter::: Thread production, name is [ARouter task pool No.1, thread No.2][ ]
I/ARouter::: ARouter init over.[ ]

// &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 插件日志输出
I/ARouter::: ARouter openLog[ ]
I/ARouter::: ARouter openDebug[ ]
I/ARouter::: ARouter init start.[ ]
I/ARouter::: Run with debug mode or new install, rebuild router map.[ ]
I/ARouter::: VM with name 'Android' has multidex support
E/ARouter::: InstantRun support error, com.android.tools.fd.runtime.Paths
I/ARouter::: Thread production, name is [ARouter task pool No.1, thread No.1][ ]
D/ARouter::: Filter 0 classes by packageName &lt;com.alibaba.android.arouter.routes&gt;
I/ARouter::: Find router map finished, map size = 0, cost 14 ms.[ ]
I/ARouter::: Load root element finished, cost 0 ms.[ ]
E/ARouter::: No mapping files were found, check your configuration please![ ]
D/ARouter::: LogisticsCenter has already been loaded, GroupIndex[0], InterceptorIndex[0], ProviderIndex[0][ ]
I/ARouter::: ARouter init success![ ]
W/ARouter::: ARouter::There is no route match the path [/arouter/service/interceptor], in group [arouter][ ]
I/ARouter::: ARouter init over.[ ]
</code></pre></div><p>大致分析一下日志发现，当作为插件时，路由映射配置为 0（<code>Find router map finished, map size = 0</code>），为了找到 ARouter 初始化失败的原因，简单的跟踪了一下源码：</p> <blockquote><p>ARouter 初始化失败，那么一般要从初始化入口开始查起，即 <code>ARouter.init(application)</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ARouter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Application</span> application<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hasInit <span class="token operator">=</span> _ARouter<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> _ARouter <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Application</span> application<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LogisticsCenter</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到 <code>ARouter#init()</code> 最终会执行 <code>LogisticsCenter.init(mContext, executor)</code>，下面来看 <code>LogisticsCenter.init(mContext, executor)</code> 的源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogisticsCenter</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * LogisticsCenter init, load all metas in memory. Demand initialization
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> tpe<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">HandlerException</span> <span class="token punctuation">{</span>

        <span class="token comment">// Step1. 获取到 app 所有的 class</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> routerMap<span class="token punctuation">;</span>
        <span class="token comment">// It will rebuild router map every times when debuggable.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ARouter</span><span class="token punctuation">.</span><span class="token function">debuggable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">PackageUtils</span><span class="token punctuation">.</span><span class="token function">isNewVersion</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Run with debug mode or new install, rebuild router map.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// These class was generated by arouter-compiler.</span>
            routerMap <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getFileNameByPackageName</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token constant">ROUTE_ROOT_PAKCAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>routerMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                context<span class="token punctuation">.</span><span class="token function">getSharedPreferences</span><span class="token punctuation">(</span><span class="token constant">AROUTER_SP_CACHE_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">MODE_PRIVATE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putStringSet</span><span class="token punctuation">(</span><span class="token constant">AROUTER_SP_KEY_MAP</span><span class="token punctuation">,</span> routerMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">PackageUtils</span><span class="token punctuation">.</span><span class="token function">updateVersion</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Save new version name when router map update finishes.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Load router map from cache.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            routerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getSharedPreferences</span><span class="token punctuation">(</span><span class="token constant">AROUTER_SP_CACHE_KEY</span><span class="token punctuation">,</span> <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">MODE_PRIVATE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStringSet</span><span class="token punctuation">(</span><span class="token constant">AROUTER_SP_KEY_MAP</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Find router map finished, map size = &quot;</span> <span class="token operator">+</span> routerMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, cost &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startInit<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ms.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Step2. 加载 路由配置、拦截器 相关类</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> className <span class="token operator">:</span> routerMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">ROUTE_ROOT_PAKCAGE</span> <span class="token operator">+</span> <span class="token constant">DOT</span> <span class="token operator">+</span> <span class="token constant">SDK_NAME</span> <span class="token operator">+</span> <span class="token constant">SEPARATOR</span> <span class="token operator">+</span> <span class="token constant">SUFFIX_ROOT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// This one of root elements, load root.</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IRouteRoot</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>groupsIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">ROUTE_ROOT_PAKCAGE</span> <span class="token operator">+</span> <span class="token constant">DOT</span> <span class="token operator">+</span> <span class="token constant">SDK_NAME</span> <span class="token operator">+</span> <span class="token constant">SEPARATOR</span> <span class="token operator">+</span> <span class="token constant">SUFFIX_INTERCEPTORS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Load interceptorMeta</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IInterceptorGroup</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>interceptorsIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">ROUTE_ROOT_PAKCAGE</span> <span class="token operator">+</span> <span class="token constant">DOT</span> <span class="token operator">+</span> <span class="token constant">SDK_NAME</span> <span class="token operator">+</span> <span class="token constant">SEPARATOR</span> <span class="token operator">+</span> <span class="token constant">SUFFIX_PROVIDERS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Load providerIndex</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IProviderGroup</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>providersIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码的核心是最后的 for 循环，大致意思就是通过判断类名规则，过滤出 ARouter 相关的特定类，比如 <code>路由分组信息</code> 相关类、<code>拦截器</code> 相关类，并分别加载进 <code>Warehouse.groupsIndex</code> 和 <code>Warehouse.interceptorsIndex</code>，不过它不是出问题的关键。</p> <blockquote><p>补充：ARouter 的工程源码中有 <code>arouter-annotation</code> 和 <code>arouter-compiler</code> 这 2 个额外的 Module，这是使用 ARouter 能够进行 <code>依赖注入</code>、<code>组件解耦</code> 的技术核心： <code>编译时注解</code> + <code>JavaPoet</code>。就组件解耦而言，ARouter 通过编译时注解技术，可以在工程编译期间，获取到使用了 <code>@Route</code> 注解的类，结合 <code>JavaPoet</code> 生成特定的 class 文件，用来描述 path 与组件之间的对应关系（以及各个参数）。</p></blockquote> <p>根据输出日志信息，可以知道 <code>routerMap</code> 中的元素个数为 0，而 <code>routerMap</code> 是通过 <code>ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE)</code> 得到的，再来看 <code>ClassUtils</code> 源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassUtils</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 通过指定包名，扫描包下面包含的所有的ClassName
     *
     * @param context     U know
     * @param packageName 包名
     * @return 所有class的集合
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFileNameByPackageName</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> packageName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">PackageManager<span class="token punctuation">.</span>NameNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> classNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> paths <span class="token operator">=</span> <span class="token function">getSourcePaths</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> parserCtl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> path <span class="token operator">:</span> paths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DefaultPoolExecutor</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">DexFile</span> dexfile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token constant">EXTRACTED_SUFFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">//NOT use new DexFile(path), because it will throw &quot;permission error in /data/dalvik-cache&quot;</span>
                            dexfile <span class="token operator">=</span> <span class="token class-name">DexFile</span><span class="token punctuation">.</span><span class="token function">loadDex</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> path <span class="token operator">+</span> <span class="token string">&quot;.tmp&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            dexfile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexFile</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dexEntries <span class="token operator">=</span> dexfile<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>dexEntries<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">String</span> className <span class="token operator">=</span> dexEntries<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                classNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">&quot;ARouter&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Scan map file in dex files made error.&quot;</span><span class="token punctuation">,</span> ignore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> dexfile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                dexfile<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        parserCtl<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        parserCtl<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Filter &quot;</span> <span class="token operator">+</span> classNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; classes by packageName &lt;&quot;</span> <span class="token operator">+</span> packageName <span class="token operator">+</span> <span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> classNames<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * get all the dex path
     *
     * @param context the application context
     * @return all the dex path
     * @throws PackageManager.NameNotFoundException
     * @throws IOException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSourcePaths</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">PackageManager<span class="token punctuation">.</span>NameNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationInfo</span> applicationInfo <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> sourceApk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>applicationInfo<span class="token punctuation">.</span>sourceDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sourcePaths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sourcePaths<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>applicationInfo<span class="token punctuation">.</span>sourceDir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//add the default apk path</span>

        <span class="token comment">//the prefix of extracted file, ie: test.classes</span>
        <span class="token class-name">String</span> extractedFilePrefix <span class="token operator">=</span> sourceApk<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">EXTRACTED_NAME_EXT</span><span class="token punctuation">;</span>

<span class="token comment">//        如果VM已经支持了MultiDex，就不要去Secondary Folder加载 Classesx.zip了，那里已经么有了</span>
<span class="token comment">//        通过是否存在sp中的multidex.version是不准确的，因为从低版本升级上来的用户，是包含这个sp配置的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isVMMultidexCapable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//the total dex numbers</span>
            <span class="token keyword">int</span> totalDexNumber <span class="token operator">=</span> <span class="token function">getMultiDexPreferences</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token constant">KEY_DEX_NUMBER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span> dexDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>applicationInfo<span class="token punctuation">.</span>dataDir<span class="token punctuation">,</span> <span class="token constant">SECONDARY_FOLDER_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> secondaryNumber <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> secondaryNumber <span class="token operator">&lt;=</span> totalDexNumber<span class="token punctuation">;</span> secondaryNumber<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//for each dex file, ie: test.classes2.zip, test.classes3.zip...</span>
                <span class="token class-name">String</span> fileName <span class="token operator">=</span> extractedFilePrefix <span class="token operator">+</span> secondaryNumber <span class="token operator">+</span> <span class="token constant">EXTRACTED_SUFFIX</span><span class="token punctuation">;</span>
                <span class="token class-name">File</span> extractedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>dexDir<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>extractedFile<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sourcePaths<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>extractedFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//we ignore the verify zip part</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Missing extracted secondary dex file '&quot;</span> <span class="token operator">+</span> extractedFile<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ARouter</span><span class="token punctuation">.</span><span class="token function">debuggable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Search instant run support only debuggable</span>
            sourcePaths<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">tryLoadInstantRunDexFile</span><span class="token punctuation">(</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sourcePaths<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为 <code>ClassUtils</code> 的 <code>getFileNameByPackageName()</code> 和 <code>getSourcePaths()</code> 代码很关键，所以原封不动拷贝过来了，大致的逻辑是：通过包名获取到 apk 安装时解压出来的所有 dex 文件路径，再通过加载 dex 文件，提取出其中所有的 class，然后再回到 <code>LogisticsCenter.init(mContext, executor)</code> 中最后的那个 for 循环，加载出所有的路由和拦截器配置。那问题就来了：</p> <h4 id="q-为什么-routermap-中的元素个数为-0-或者说-为什么-dex-文件提取不出-class"><a href="#q-为什么-routermap-中的元素个数为-0-或者说-为什么-dex-文件提取不出-class" class="header-anchor">#</a> Q: 为什么 <code>routerMap</code> 中的元素个数为 0 ？或者说，为什么 dex 文件提取不出 class ？</h4> <p>A: 根据 RePlugin 官方 wiki 中，对插件的目录结构的介绍中，可以知道，插件的 dex 文件就不在常规目录下，所以 ARouter 压根就获取不到插件的 dex 文件，更别说加载插件中的路由及拦截器配置了。</p> <blockquote><p><a href="https://github.com/Qihoo360/RePlugin/wiki/%E6%8F%92%E4%BB%B6%E7%9A%84%E7%AE%A1%E7%90%86#%E6%8F%92%E4%BB%B6%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">https://github.com/Qihoo360/RePlugin/wiki/插件的管理#插件的目录结构<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h4 id="q-那要怎样才能让-arouter-加载到插件的-dex-文件呢"><a href="#q-那要怎样才能让-arouter-加载到插件的-dex-文件呢" class="header-anchor">#</a> Q: 那要怎样才能让 ARouter 加载到插件的 dex 文件呢？</h4> <p>A: 理论上可以在插件中，通过反射的方式给 ARouter 的 <code>Warehouse.groupsIndex</code> 追加路由配置信息。或者对 ARouter 进行代码改造，在 <code>LogisticsCenter.init(mContext, executor)</code> 中插入获取当前插件 dex 文件中所有 class 的代码。</p> <h4 id="q-这样就能让-arouter-在插件中正常工作了吗"><a href="#q-这样就能让-arouter-在插件中正常工作了吗" class="header-anchor">#</a> Q: 这样就能让 ARouter 在插件中正常工作了吗？</h4> <p>A: 理论上是的。不过 Activity 可能还是会跳转失败。</p> <h3 id="_2、activity-跳转失败"><a href="#_2、activity-跳转失败" class="header-anchor">#</a> 2、Activity 跳转失败</h3> <p>ARouter 组件路由的关键方法就是 <code>navigation()</code>，而所有重载的 <code>navigation()</code> 方法最终都会走向 <code>_ARouter#_navigation()</code> 方法，其源码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> _ARouter <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">_navigation</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Postcard</span> postcard<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">NavigationCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Context</span> currentContext <span class="token operator">=</span> postcard<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>postcard<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">ACTIVITY</span><span class="token operator">:</span>
                <span class="token comment">// Build intent</span>
                <span class="token keyword">final</span> <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>currentContext<span class="token punctuation">,</span> postcard<span class="token punctuation">.</span><span class="token function">getDestination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                intent<span class="token punctuation">.</span><span class="token function">putExtras</span><span class="token punctuation">(</span>postcard<span class="token punctuation">.</span><span class="token function">getExtras</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Set flags.</span>
                <span class="token keyword">int</span> flags <span class="token operator">=</span> postcard<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    intent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Non activity, need FLAG_ACTIVITY_NEW_TASK</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>currentContext <span class="token keyword">instanceof</span> <span class="token class-name">Activity</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_ACTIVITY_NEW_TASK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Set Actions</span>
                <span class="token class-name">String</span> action <span class="token operator">=</span> postcard<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    intent<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Navigation in main looper.</span>
                <span class="token function">runInMainThread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">startActivity</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> currentContext<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> postcard<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">PROVIDER</span><span class="token operator">:</span>
                <span class="token keyword">return</span> postcard<span class="token punctuation">.</span><span class="token function">getProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">BOARDCAST</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">CONTENT_PROVIDER</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">FRAGMENT</span><span class="token operator">:</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fragmentMeta <span class="token operator">=</span> postcard<span class="token punctuation">.</span><span class="token function">getDestination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Object</span> instance <span class="token operator">=</span> fragmentMeta<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Fragment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Fragment</span><span class="token punctuation">)</span> instance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setArguments</span><span class="token punctuation">(</span>postcard<span class="token punctuation">.</span><span class="token function">getExtras</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>Fragment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v4<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>Fragment</span><span class="token punctuation">)</span> instance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setArguments</span><span class="token punctuation">(</span>postcard<span class="token punctuation">.</span><span class="token function">getExtras</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Fetch fragment instance error, &quot;</span> <span class="token operator">+</span> <span class="token class-name">TextUtils</span><span class="token punctuation">.</span><span class="token function">formatStackTrace</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token constant">METHOD</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token constant">SERVICE</span><span class="token operator">:</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里主要看 <code>switch-case</code> 中 <code>ACTIVITY</code> 分支部分，在创建好 Intent 之后，就会调用 <code>_ARouter#startActivity()</code> 来启动 Activity，其源码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> _ARouter <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Start activity
     *
     * @see ActivityCompat
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Context</span> currentContext<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">Postcard</span> postcard<span class="token punctuation">,</span> <span class="token class-name">NavigationCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Need start for result</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentContext <span class="token keyword">instanceof</span> <span class="token class-name">Activity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ActivityCompat</span><span class="token punctuation">.</span><span class="token function">startActivityForResult</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Activity</span><span class="token punctuation">)</span> currentContext<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> postcard<span class="token punctuation">.</span><span class="token function">getOptionsBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">warning</span><span class="token punctuation">(</span><span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;Must use [navigation(activity, ...)] to support [startActivityForResult]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">ActivityCompat</span><span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>currentContext<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> postcard<span class="token punctuation">.</span><span class="token function">getOptionsBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">!=</span> postcard<span class="token punctuation">.</span><span class="token function">getEnterAnim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">!=</span> postcard<span class="token punctuation">.</span><span class="token function">getExitAnim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> currentContext <span class="token keyword">instanceof</span> <span class="token class-name">Activity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// Old version.</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Activity</span><span class="token punctuation">)</span> currentContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">overridePendingTransition</span><span class="token punctuation">(</span>postcard<span class="token punctuation">.</span><span class="token function">getEnterAnim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> postcard<span class="token punctuation">.</span><span class="token function">getExitAnim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Navigation over.</span>
            callback<span class="token punctuation">.</span><span class="token function">onArrival</span><span class="token punctuation">(</span>postcard<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到 <code>_ARouter#startActivity()</code> 是通过 <code>ActivityCompat.startActivity()</code> 来启动 Activity，有一点很关键，<strong><em>插件中的 Activity，必须由插件的 context 来启动</em></strong>，那么这里的 <code>currentContext</code> 是谁？通过 <code>Postcard#setContext()</code> 的调用可以定位到以下源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">class</span> _ARouter <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Context</span> mContext<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Application</span> application<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mContext <span class="token operator">=</span> application<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">navigation</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Postcard</span> postcard<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">NavigationCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Set context to postcard.</span>
        postcard<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> context <span class="token operator">?</span> mContext <span class="token operator">:</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>也就是说，在调用 <code>_ARouter#navigation()</code> 时，如果外部有传入 context 就使用外部的 context，否则使用 application，而 <code>_ARouter</code> 的 application 来自框架初始化时 <code>ARouter#init(application)</code> 传入的 application，好了，现在的问题就是，这个 application 是宿主的，还是插件的？</p> <blockquote><p>下面只考虑作为插件的情况，因为作为单品没有宿主插件之分。</p></blockquote> <h4 id="情景-1-在自定义-application-中初始化-arouter"><a href="#情景-1-在自定义-application-中初始化-arouter" class="header-anchor">#</a> 情景 1：在自定义 Application 中初始化 ARouter</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ARouter</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this是插件的application</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>自定义 Application 中的 this 就是【插件】的 application。</li></ul> <h4 id="情景-2-在-activity-中初始化-arouter"><a href="#情景-2-在-activity-中初始化-arouter" class="header-anchor">#</a> 情景 2：在 Activity 中初始化 ARouter</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ARouter</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 宿主application</span>
        <span class="token class-name">ARouter</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 插件application</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>activity.getApplication()</code>：拿到【宿主】的 application</li> <li><code>activity.getApplicationContext()</code>：拿到【插件】的 application</li></ul> <p>相关 issue：</p> <ul><li><a href="https://github.com/Qihoo360/RePlugin/issues/550" target="_blank" rel="noopener noreferrer">https://github.com/Qihoo360/RePlugin/issues/550<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/Qihoo360/RePlugin/issues/335" target="_blank" rel="noopener noreferrer">https://github.com/Qihoo360/RePlugin/issues/335<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>综上，出现 Activity 跳转失败的本质原因就是使用了宿主的 context，主要发生在非自定义 Application 中初始化 ARouter 的场景，现在解决这个问题就很简单了，有 2 种解决方案：</p> <blockquote><p>如果你是在自定义 Application 中初始化 ARouter 的话，下面就不用看了。</p></blockquote> <h4 id="方案-1-在非自定义-application-中使用-applicationcontext-初始化-arouter"><a href="#方案-1-在非自定义-application-中使用-applicationcontext-初始化-arouter" class="header-anchor">#</a> 方案 1：在非自定义 Application 中使用 <code>applicationContext</code> 初始化 ARouter：</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ARouter</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="方案-2-使用带-context-参数的-navigation-context-方法进行路由操作"><a href="#方案-2-使用带-context-参数的-navigation-context-方法进行路由操作" class="header-anchor">#</a> 方案 2：使用带 context 参数的 <code>navigation(Context)</code> 方法进行路由操作：</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token keyword">implements</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Button</span> button<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ARouter</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token string">&quot;/module2/other&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">navigation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="三、litearouter"><a href="#三、litearouter" class="header-anchor">#</a> 三、LiteARouter</h2> <p>通过以上分析得出，为了让 ARouter 能够在 RePlugin 中正常初始化，有两种方案：</p> <ul><li>反射：通过反射的方式给 ARouter 的追加路由配置信息 <code>Warehouse.groupsIndex</code> ，拦截器 <code>Warehouse.interceptorsIndex</code> 以及 IProvider 服务 <code>Warehouse.providersIndex</code>。</li> <li>改造：对 ARouter 进行代码改造，在 <code>LogisticsCenter.init(mContext, executor)</code> 中插入获取当前插件 dex 文件中所有 class 的代码。</li></ul> <p>以上两种方案各有利弊，个人觉得改造的方式应该比较好一点，不过呢，我并没有完全按上面的方式来处理，一方面是因为 ARouter 的设计思路是比较复杂的，除了路由，还有拦截器，依赖注入，以及 IProvider 等服务，并不能完全保证除了路由以外的其他功能是否能正常使用，另一方面是因为项目时间紧、任务重，开发时间严重不足，而且我们只需要用到路由功能。于是，我的做法是改造 ARouter，只保留路由功能，并命名为 <a href="https://github.com/GitLqr/LiteARouter" target="_blank" rel="noopener noreferrer">LiteARouter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <ul><li>LiteARouter 的 Git 仓库：<a href="https://github.com/GitLqr/LiteARouter" target="_blank" rel="noopener noreferrer">https://github.com/GitLqr/LiteARouter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="_1、arouter-compiler-分析"><a href="#_1、arouter-compiler-分析" class="header-anchor">#</a> 1、arouter-compiler 分析</h3> <p>通过分析 <code>arouter-compiler</code> 代码，结合 jadx 反编译，可以知道最终会在 <code>com.alibaba.android.arouter.routes</code> 包下生成 <code>ARouter$$Root$$XXX</code> 的类，比如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>android<span class="token punctuation">.</span>arouter<span class="token punctuation">.</span>routes</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>android<span class="token punctuation">.</span>arouter<span class="token punctuation">.</span>facade<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">IRouteGroup</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>android<span class="token punctuation">.</span>arouter<span class="token punctuation">.</span>facade<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">IRouteRoot</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ARouter</span>$$<span class="token class-name">Root</span>$$substance <span class="token keyword">implements</span> <span class="token class-name">IRouteRoot</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">IRouteGroup</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> routes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        routes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;substance&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ARouter</span>$$<span class="token class-name">Group</span>$$substance<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>substance 是我的主程序 Module 名，一般是 app，也就是 gradle 文件中 <code>AROUTER_MODULE_NAME</code> 参数对应的值。</p></blockquote> <p>可以知道 <code>ARouter$$Root$$XXX</code> 的 <code>loadInto(Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt; routes)</code> 方法会将路由的【分组信息】保存到 <code>routes</code> 中，而这个 <code>route</code> 正是 <code>Warehouse.groupsIndex</code> 。另外，真正的路由【映射信息】则是生成在了 <code>ARouter$$Group$$XXX</code> 类中，比如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>android<span class="token punctuation">.</span>arouter<span class="token punctuation">.</span>routes</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>android<span class="token punctuation">.</span>arouter<span class="token punctuation">.</span>facade<span class="token punctuation">.</span>enums<span class="token punctuation">.</span></span><span class="token class-name">RouteType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>android<span class="token punctuation">.</span>arouter<span class="token punctuation">.</span>facade<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RouteMeta</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>android<span class="token punctuation">.</span>arouter<span class="token punctuation">.</span>facade<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">IRouteGroup</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>charylin<span class="token punctuation">.</span>substance<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>main<span class="token punctuation">.</span></span><span class="token class-name">MainActivity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ARouter</span>$$<span class="token class-name">Group</span>$$substance <span class="token keyword">implements</span> <span class="token class-name">IRouteGroup</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RouteMeta</span><span class="token punctuation">&gt;</span></span> atlas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        atlas<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/substance/main&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RouteMeta</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">RouteType</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY</span><span class="token punctuation">,</span> <span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;/substance/main&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;substance&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>ARouter$$Group$$XXX</code> 的 <code>loadInto(Map&lt;String, RouteMeta&gt; atlas)</code> 会将路由【映射信息】保存到 <code>atlas</code> 中，而这个 <code>atlas</code> 正是 <code>Warehouse.routes</code> 。</p> <h3 id="_2、logisticscenter-分析"><a href="#_2、logisticscenter-分析" class="header-anchor">#</a> 2、LogisticsCenter 分析</h3> <p>现在回过头再来看 <code>LogisticsCenter.init(mContext, executor)</code> 中最后的那个 for 循环，就比较清楚它是怎么加载路由配置信息的了：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogisticsCenter</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * LogisticsCenter init, load all metas in memory. Demand initialization
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> tpe<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">HandlerException</span> <span class="token punctuation">{</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// Step2. 加载 路由配置、拦截器 相关类</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> className <span class="token operator">:</span> routerMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">ROUTE_ROOT_PAKCAGE</span> <span class="token operator">+</span> <span class="token constant">DOT</span> <span class="token operator">+</span> <span class="token constant">SDK_NAME</span> <span class="token operator">+</span> <span class="token constant">SEPARATOR</span> <span class="token operator">+</span> <span class="token constant">SUFFIX_ROOT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// This one of root elements, load root.</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IRouteRoot</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>groupsIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">ROUTE_ROOT_PAKCAGE</span> <span class="token operator">+</span> <span class="token constant">DOT</span> <span class="token operator">+</span> <span class="token constant">SDK_NAME</span> <span class="token operator">+</span> <span class="token constant">SEPARATOR</span> <span class="token operator">+</span> <span class="token constant">SUFFIX_INTERCEPTORS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Load interceptorMeta</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IInterceptorGroup</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>interceptorsIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">ROUTE_ROOT_PAKCAGE</span> <span class="token operator">+</span> <span class="token constant">DOT</span> <span class="token operator">+</span> <span class="token constant">SDK_NAME</span> <span class="token operator">+</span> <span class="token constant">SEPARATOR</span> <span class="token operator">+</span> <span class="token constant">SUFFIX_PROVIDERS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Load providerIndex</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IProviderGroup</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>providersIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其核心就是反射拿到 <code>ARouter$$Root$$XXX</code> 、 <code>ARouter$$Interceptors$$XXX</code> 、 <code>ARouter$$Providers$$XXX</code> 类并创建实例，最终丢到 <code>Warehouse</code> 中，细心的你可能发现了，这里怎么没有 <code>Warehouse.routes</code> ？其实 <code>LogisticsCenter</code> 有一个很重要的 <code>completion(Postcard)</code> 方法，主要是对 Postcard 中的信息进行完善填充，以下是 <code>completion(Postcard)</code> 方法源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogisticsCenter</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Completion the postcard by route metas
     *
     * @param postcard Incomplete postcard, should complete by this method.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">completion</span><span class="token punctuation">(</span><span class="token class-name">Postcard</span> postcard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RouteMeta</span> routeMeta <span class="token operator">=</span> <span class="token class-name">Warehouse</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>postcard<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> routeMeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Maybe its does't exist, or didn't load.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>groupsIndex<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>postcard<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoRouteFoundException</span><span class="token punctuation">(</span><span class="token constant">TAG</span> <span class="token operator">+</span> <span class="token string">&quot;There is no route match the path [&quot;</span> <span class="token operator">+</span> postcard<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;], in group [&quot;</span> <span class="token operator">+</span> postcard<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                <span class="token comment">// Load route and cache it into memory, then delete from metas.</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">addRouteGroupDynamic</span><span class="token punctuation">(</span>postcard<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HandlerException</span><span class="token punctuation">(</span><span class="token constant">TAG</span> <span class="token operator">+</span> <span class="token string">&quot;Fatal exception when loading group meta. [&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token function">completion</span><span class="token punctuation">(</span>postcard<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Reload</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addRouteGroupDynamic</span><span class="token punctuation">(</span><span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">IRouteGroup</span> group<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>groupsIndex<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>groupName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// If this group is included, but it has not been loaded</span>
            <span class="token comment">// load this group first, because dynamic route has high priority.</span>
            <span class="token class-name">Warehouse</span><span class="token punctuation">.</span>groupsIndex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>groupName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>routes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Warehouse</span><span class="token punctuation">.</span>groupsIndex<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>groupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// cover old group.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            group<span class="token punctuation">.</span><span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>routes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>LogisticsCenter#completion(Postcard)</code> 源码的大致逻辑是，当根据 Postcard 中的路由 path 从 <code>Warehouse.routes</code> 中获取不到 routeMeta 时，即为路由信息缺失，这时，会根据 Postcard 中的路由 group （分组信息）动态加载到具体的路由配置，并保存到 <code>Warehouse.routes</code> 中，所以说，其实 <code>Warehouse.routes</code> 中具体的 routeMeta 是按需加载的。</p> <h3 id="_3、logisticscenter-改造"><a href="#_3、logisticscenter-改造" class="header-anchor">#</a> 3、LogisticsCenter 改造</h3> <p>综上，因为 <code>Warehouse.routes</code> 会在 <code>LogisticsCenter#completion(Postcard)</code> 方法中动态加载填充，所以，我只需要通过反射把路由【分组信息】加载进 <code>Warehouse.groupsIndex</code> 即可，于是我改造了 <code>LogisticsCenter#loadRouterMap()</code> 方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogisticsCenter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Context</span> sContext<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> sExecutor<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">LogisticsCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ThreadPoolExecutor</span> tpe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">loadRouterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadRouterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> nameOfRouteRootClass <span class="token operator">=</span> <span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">NAME_OF_ROUTE_ROOT_CLASS</span><span class="token punctuation">;</span> <span class="token comment">// com.charylin.litearouter.routes.LiteARouter$$Root</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> routeRootClz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>nameOfRouteRootClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>routeRootClz <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">IRouteRoot</span> routeGroup <span class="token operator">=</span> routeRootClz<span class="token punctuation">.</span><span class="token function">asSubclass</span><span class="token punctuation">(</span><span class="token class-name">IRouteRoot</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>routeGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    routeGroup<span class="token punctuation">.</span><span class="token function">loadInto</span><span class="token punctuation">(</span><span class="token class-name">Warehouse</span><span class="token punctuation">.</span>groupsIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">LiteARouter</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">&quot;load router map error.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Consts</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SEPARATOR</span> <span class="token operator">=</span> <span class="token string">&quot;$$&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PROJECT</span> <span class="token operator">=</span> <span class="token string">&quot;LiteARouter&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token constant">PROJECT</span> <span class="token operator">+</span> <span class="token string">&quot;::&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NAME_OF_ROOT</span> <span class="token operator">=</span> <span class="token constant">PROJECT</span> <span class="token operator">+</span> <span class="token constant">SEPARATOR</span> <span class="token operator">+</span> <span class="token string">&quot;Root&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PACKAGE_OF_GENERATE_FILE</span> <span class="token operator">=</span> <span class="token string">&quot;com.charylin.litearouter.routes&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NAME_OF_ROUTE_ROOT_CLASS</span> <span class="token operator">=</span> <span class="token constant">PACKAGE_OF_GENERATE_FILE</span> <span class="token operator">+</span> <span class="token char">'.'</span> <span class="token operator">+</span> <span class="token constant">NAME_OF_ROOT</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为了反射足够简单，我把 <code>ARouter$$Root$$XXX</code> 类名改为 <code>LiteARouter$$Root</code> ，也就是说类名后面不追加模块名。即 gradle 文件中不需要配置 <code>AROUTER_MODULE_NAME</code> 参数了。</p> <h3 id="_4、arouter-compiler-改造"><a href="#_4、arouter-compiler-改造" class="header-anchor">#</a> 4、arouter-compiler 改造</h3> <p>既然记载了路由【分组信息】的类名（ <code>ARouter$$Root$$XXX</code> ）设计变化了，那么在 compiler 中也需要对生成的类名规则进行修改：</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token annotation punctuation">@AutoService</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SupportedAnnotationTypes</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token constant">ANNOTATION_TYPE_ROUTE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RouteProcessor</span> <span class="token keyword">extends</span> <span class="token class-name">BaseProcessor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseRoutes</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Element</span><span class="token punctuation">&gt;</span></span> routeElements<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// Write root meta into disk.</span>
        <span class="token class-name">String</span> rootFileName <span class="token operator">=</span> <span class="token constant">NAME_OF_ROOT</span><span class="token punctuation">;</span> <span class="token comment">// String rootFileName = NAME_OF_ROOT + SEPARATOR + moduleName;</span>
        <span class="token class-name">JavaFile</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token constant">PACKAGE_OF_GENERATE_FILE</span><span class="token punctuation">,</span>
                <span class="token class-name">TypeSpec</span><span class="token punctuation">.</span><span class="token function">classBuilder</span><span class="token punctuation">(</span>rootFileName<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">addJavadoc</span><span class="token punctuation">(</span><span class="token constant">WARNING_TIPS</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">addSuperinterface</span><span class="token punctuation">(</span><span class="token class-name">ClassName</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>elementUtils<span class="token punctuation">.</span><span class="token function">getTypeElement</span><span class="token punctuation">(</span><span class="token constant">ITROUTE_ROOT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">addModifiers</span><span class="token punctuation">(</span><span class="token constant">PUBLIC</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">addMethod</span><span class="token punctuation">(</span>loadIntoMethodOfRootBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>mFiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>因为只需要保留了路由功能，所以，把拦截器、依赖注入等不需要用到的功能对应的生成类逻辑一并精简掉了。</p></blockquote> <p>至此，便是我在处理 RePlugin+ARouter 搭配时发现的问题思考及解决方案，以上只是此次改造 ARouter 中最重要的部分，更多细节可通过对比 <a href="https://github.com/GitLqr/LiteARouter" target="_blank" rel="noopener noreferrer">LiteARouter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 与 ARouter 各个文件的差异来了解。</p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <center><img style="width:100%;" src="https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/FSA_QR_bottom.png"/></center>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E6%8F%92%E4%BB%B6%E5%8C%96" title="标签">#插件化</a><a href="/tags/?tag=RePlugin" title="标签">#RePlugin</a><a href="/tags/?tag=ARouter" title="标签">#ARouter</a><a href="/tags/?tag=LiteARouter" title="标签">#LiteARouter</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025/07/27, 05:33:39</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/f63a8b/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">RePlugin集成AndroidAutoSize</div></a> <a href="/pages/1195b1/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">RePluginX - 兼容AndroidX并加入新特性开发纪要</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/f63a8b/" class="prev">RePlugin集成AndroidAutoSize</a></span> <span class="next"><a href="/pages/1195b1/">RePluginX - 兼容AndroidX并加入新特性开发纪要</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/cfaaca/"><div>
            AI - Gemini CLI 摆脱终端限制
            <!----></div></a> <span class="date">07-27</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/305cd9/"><div>
            Flutter - 聊天面板库动画生硬？这次让你丝滑个够
            <!----></div></a> <span class="date">07-20</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/f903b2/"><div>
            Flutter - GetX Helper 如何应用于旧页面
            <!----></div></a> <span class="date">06-14</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/LinXunFeng" title="GitHub for LinXunFeng" target="_blank" class="iconfont icon-githubsquare"></a><a href="mailto:linxunfeng@yeah.net" title="email for LinXunFeng" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/GitLqr" title="GitHub for GitLqr" target="_blank" class="iconfont icon-github-circle"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2025
    <span><a href="/about" target="_blank">FSA全栈行动</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.89dd8fe9.js" defer></script><script src="/assets/js/2.d8b68cf2.js" defer></script><script src="/assets/js/70.94bc99f2.js" defer></script>
  </body>
</html>
