(window.webpackJsonp=window.webpackJsonp||[]).push([[162],{572:function(t,a,e){"use strict";e.r(a);var s=e(21),_=Object(s.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"一、前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、前言"}},[t._v("#")]),t._v(" 一、前言")]),t._v(" "),a("p",[t._v("为解决 App 代码臃肿、编译耗时的问题，我们进行了分包重构，核心思路如下：")]),t._v(" "),a("ol",[a("li",[a("strong",[t._v("业务分包")]),t._v("：将不同业务线的代码拆分成独立的包，开发者只需聚焦于各自包内的 "),a("code",[t._v("example")]),t._v(" 工程进行开发，从而提升编译和运行效率。")]),t._v(" "),a("li",[a("strong",[t._v("功能沉淀")]),t._v("：把跨业务复用的功能（包括基础业务和非业务功能）也抽离成独立的包，逐步让主 "),a("code",[t._v("App")]),t._v(" 轻量化为一个“空壳”，负责集成所有模块。")]),t._v(" "),a("li",[a("strong",[t._v("依赖管理")]),t._v("：业务包之间使用 "),a("code",[t._v("git")]),t._v(" 依赖，指向 "),a("code",[t._v("master")]),t._v(" 分支；而非业务的功能包则发布到自建的 "),a("code",[t._v("unpub")]),t._v(" 平台，通过版本号管理。")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('">=1.0.0 <2.0.0"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosted")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//unpub.lxf.dev/\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("package_a")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("git")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" git@code.gitlab.com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("lxf/package_a.git\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ref")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" master\n")])])]),a("p",[t._v("分包后虽然利于单个工程的独立开发，但一旦涉及跨包联调，就会变得非常低效。")]),t._v(" "),a("p",[t._v("开发者需要手动修改 "),a("code",[t._v("dependency_overrides")]),t._v(" 以 "),a("code",[t._v("path")]),t._v(" 方式指定本地依赖，在多个 "),a("code",[t._v("IDE")]),t._v(" 窗口间切换，并耗费大量时间处理依赖冲突，这在紧张的工期中尤其痛苦。")]),t._v(" "),a("p",[t._v("因此，在官方的 "),a("code",[t._v("Pub workspaces")]),t._v(" 方案出现之前，"),a("code",[t._v("Melos")]),t._v(" 的出现有效解决了这些痛点。")]),t._v(" "),a("h2",{attrs:{id:"二、melos"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、melos"}},[t._v("#")]),t._v(" 二、Melos")]),t._v(" "),a("p",[a("code",[t._v("Melos")]),t._v(" 是一个管理多个项目的 "),a("code",[t._v("CLI")]),t._v(" 工具，只需要在 "),a("code",[t._v("melos.yaml")]),t._v(" 中的 "),a("code",[t._v("packages")]),t._v(" 下声明各个包，如下所示")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# melos.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("packages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" packages/package_a\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" packages/package_a/example\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" packages/package_b\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" packages/package_b/example\n")])])]),a("p",[t._v("执行 "),a("code",[t._v("melos bs")]),t._v(" 即可自动在各个包中创建 "),a("code",[t._v("pubspec_overrides.yaml")]),t._v(" 并重写必要的包依赖，顺带执行 "),a("code",[t._v("flutter pub get")]),t._v("。")]),t._v(" "),a("p",[t._v("生成的 "),a("code",[t._v("pubspec_overrides.yaml")]),t._v(" 内容如下")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pubspec_overrides.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# melos_managed_dependency_overrides: package_a ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dependency_overrides")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 同步 pubspec.yaml 中的 dependency_overrides")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrollview_observer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ^1.26.2\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果只依赖了 package_a，则只重写 package_a 依赖")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("package_a")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ../../packages/package_a\n")])])]),a("p",[t._v("除此之外，它还提供了脚本功能，方便我们在各个包中去并发执行命令，如下所示")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# melos.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scripts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("fluttergen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 各个包都执行")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" fluttergen\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pod_install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pod install "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("directory=ios\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("packageFilters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 只在各个包的 example 中执行")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scope")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*example"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("iconfont")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sh ./run.sh\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("packageFilters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 只在 package_a 中执行")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scope")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" package_a\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pub_upgrade")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" flutter pub upgrade\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置并发数")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("concurrency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])]),a("p",[t._v("可配置执行范围，比如只在某个包或各个包的 "),a("code",[t._v("example")]),t._v(" 下执行命令；配置执行的并发数等。定义的脚本通过 "),a("code",[t._v("melos run")]),t._v(" 去执行，如 "),a("code",[t._v("melos run iconfont")]),t._v("。")]),t._v(" "),a("p",[t._v("还可以做到自动生成 "),a("code",[t._v("CHANGELOG")]),t._v(" 和发包到 "),a("code",[t._v("pub")]),t._v(" 等，有兴趣的小伙伴可自行到官网了解更多的功能。")]),t._v(" "),a("p",[t._v("尽管 "),a("code",[t._v("Melos")]),t._v(" 功能强大，但它仍有两个核心缺陷：")]),t._v(" "),a("ol",[a("li",[a("strong",[t._v("依赖冲突")]),t._v("：由于每个包都维护着独立的 "),a("code",[t._v("pubspec.lock")]),t._v(" 文件，"),a("code",[t._v("Melos")]),t._v(" 无法从根本上保证所有包的依赖版本一致。")]),t._v(" "),a("li",[a("strong",[t._v("内存占用")]),t._v("："),a("code",[t._v("Dart")]),t._v(" 分析器会为每个包创建独立的分析上下文，导致了额外的内存开销。")])]),t._v(" "),a("h2",{attrs:{id:"三、pub-workspaces"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、pub-workspaces"}},[t._v("#")]),t._v(" 三、Pub workspaces")]),t._v(" "),a("p",[t._v("在 "),a("code",[t._v("Dart 3.6.0")]),t._v(" 的时候，官方带来了 "),a("code",[t._v("Pub workspaces")]),t._v("，解决了上述问题，它的优缺点总结如下")]),t._v(" "),a("h3",{attrs:{id:"优点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优点"}},[t._v("#")]),t._v(" 优点")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("优点")]),t._v(" "),a("th",[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("统一依赖管理")]),t._v(" "),a("td",[t._v("所有工作区的包共享一个 "),a("code",[t._v("pubspec.lock")]),t._v(" 文件，确保依赖版本一致性，避免版本冲突。")])]),t._v(" "),a("tr",[a("td",[t._v("性能优化")]),t._v(" "),a("td",[a("code",[t._v("Dart")]),t._v(" 分析器为整个工作区创建单一分析上下文，减少内存占用，提升大型仓库的分析性能。")])]),t._v(" "),a("tr",[a("td",[t._v("简化操作")]),t._v(" "),a("td",[t._v("只需在仓库根目录运行一次 "),a("code",[t._v("dart pub get")]),t._v("，即可为所有工作区包获取依赖。")])]),t._v(" "),a("tr",[a("td",[t._v("自动本地解析")]),t._v(" "),a("td",[t._v("工作区内包之间的相互依赖会自动解析到本地版本，无需手动配置 "),a("code",[t._v("path")]),t._v(" 依赖。")])]),t._v(" "),a("tr",[a("td",[t._v("灵活的依赖覆盖")]),t._v(" "),a("td",[t._v("支持在根 "),a("code",[t._v("pubspec.yaml")]),t._v(" 或 "),a("code",[t._v("pubspec_overrides.yaml")]),t._v(" 中进行依赖覆盖。")])]),t._v(" "),a("tr",[a("td",[t._v("便捷的命令执行")]),t._v(" "),a("td",[t._v("可以使用 "),a("code",[t._v("-C")]),t._v(" 选项在特定工作区包中执行 "),a("code",[t._v("pub")]),t._v(" 命令，无需切换目录，如："),a("code",[t._v("flutter pub get -C apps/app_a")]),t._v("。")])]),t._v(" "),a("tr",[a("td",[t._v("清晰的包列表")]),t._v(" "),a("td",[a("code",[t._v("dart pub workspace list")]),t._v(" 命令可列出所有工作区包及其路径。")])])])]),t._v(" "),a("h3",{attrs:{id:"缺点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缺点"}},[t._v("#")]),t._v(" 缺点")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("缺点")]),t._v(" "),a("th",[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("迁移成本")]),t._v(" "),a("td",[t._v("现有 "),a("code",[t._v("Monorepo")]),t._v(" 迁移到 "),a("code",[t._v("Pub workspaces")]),t._v(" 需要修改 "),a("code",[t._v("pubspec.yaml")]),t._v(" 文件并确保 "),a("code",[t._v("SDK")]),t._v(" 约束（至少 "),a("code",[t._v("^3.6.0")]),t._v("）。")])]),t._v(" "),a("tr",[a("td",[t._v("“游离”的 "),a("code",[t._v("pubspec.yaml")]),t._v(" 文件")]),t._v(" "),a("td",[t._v("工作区根目录与工作区包之间存在非工作区成员的 "),a("code",[t._v("pubspec.yaml")]),t._v(" 文件会导致 "),a("code",[t._v("pub get")]),t._v(" 报错。")])]),t._v(" "),a("tr",[a("td",[t._v("依赖覆盖限制")]),t._v(" "),a("td",[t._v("一个包只能被覆盖一次。")])]),t._v(" "),a("tr",[a("td",[t._v("版本约束匹配")]),t._v(" "),a("td",[t._v("即使使用本地版本，包之间的依赖版本约束仍需匹配。")])]),t._v(" "),a("tr",[a("td",[t._v("发布行为差异")]),t._v(" "),a("td",[t._v("工作区包发布到 "),a("code",[t._v("pub.dev")]),t._v(" 时，将使用托管版本的依赖，而非工作区内的本地版本。")])])])]),t._v(" "),a("p",[a("code",[t._v("Pub Workspaces")]),t._v(" 的一个核心原则：整个工作区只有一个统一的依赖解析。")]),t._v(" "),a("p",[t._v("这意味着在工作区的根目录会有一个全局的 "),a("code",[t._v("pubspec.lock")]),t._v(" 和一个全局的 "),a("code",[t._v(".dart_tool/package_config.json")]),t._v(" 文件，所有工作区内的包都使用这两个文件来管理它们的依赖。")]),t._v(" "),a("h2",{attrs:{id:"四、迁移优化成效"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、迁移优化成效"}},[t._v("#")]),t._v(" 四、迁移优化成效")]),t._v(" "),a("p",[t._v("这是从 "),a("code",[t._v("Melos")]),t._v(" 迁移至 "),a("code",[t._v("Melos")]),t._v(" + "),a("code",[t._v("Pub Workspaces")]),t._v(" 后的提升数据")]),t._v(" "),a("ul",[a("li",[t._v("设备：M1 16G")]),t._v(" "),a("li",[t._v("方式：集成 "),a("code",[t._v("37")]),t._v(" 个包（包含 "),a("code",[t._v("example")]),t._v("）并等待代码分析完成")])]),t._v(" "),a("p",[t._v("优化前")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202510122257009.png",alt:""}})]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202510122258301.png",alt:""}})]),t._v(" "),a("p",[t._v("优化后")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202510122258470.png",alt:""}})]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202510122259010.png",alt:""}})]),t._v(" "),a("table",[a("thead",[a("tr",[a("th"),t._v(" "),a("th",[t._v("优化前")]),t._v(" "),a("th",[t._v("优化后")]),t._v(" "),a("th",[t._v("提升")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("CPU 时间")]),t._v(" "),a("td",[t._v("9:35.46")]),t._v(" "),a("td",[t._v("7:43.69")]),t._v(" "),a("td",[t._v("19.4%")])]),t._v(" "),a("tr",[a("td",[t._v("内存占用")]),t._v(" "),a("td",[t._v("12.23 GB")]),t._v(" "),a("td",[t._v("2.62 GB")]),t._v(" "),a("td",[t._v("78.6%")])])])]),t._v(" "),a("blockquote",[a("p",[t._v("这里说一点，基于 "),a("code",[t._v("Pub Workspaces")]),t._v(" 实现的 "),a("code",[t._v("Monorepo")]),t._v("，"),a("code",[t._v("Melos")]),t._v(" 并不是必要的，只是它提供的脚本功能和 "),a("code",[t._v("Hook")]),t._v(" 实在是太方便了，有助于提升效率，所以建议搭配使用！")])]),t._v(" "),a("p",[t._v("下面我们进入实战")]),t._v(" "),a("h2",{attrs:{id:"五、实战"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、实战"}},[t._v("#")]),t._v(" 五、实战")]),t._v(" "),a("h3",{attrs:{id:"环境要求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境要求"}},[t._v("#")]),t._v(" 环境要求")]),t._v(" "),a("p",[a("code",[t._v("Dart")]),t._v(" 版本需 "),a("code",[t._v(">=3.6.0")]),t._v("，对应 "),a("code",[t._v("Flutter")]),t._v(" 版本需 "),a("code",[t._v(">=3.27.0")])]),t._v(" "),a("p",[t._v("全局安装 "),a("code",[t._v("Melos")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("dart pub global activate melos "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"7.0.0-dev.8"')]),t._v("\n")])])]),a("p",[t._v("如果你之前有安装过 "),a("code",[t._v("Melos")]),t._v("，可以先卸载再安装")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("dart pub global deactivate melos\n")])])]),a("p",[t._v("那为什么要指定 "),a("code",[t._v("7.0.0-dev.8")]),t._v(" 这个版本？这是因为我们现在使用的 "),a("code",[t._v("Flutter")]),t._v(" 版本是 "),a("code",[t._v("3.29.3")]),t._v("，对应的 "),a("code",[t._v("Dart")]),t._v(" 版本是 "),a("code",[t._v("3.7.2")]),t._v("，结合 "),a("code",[t._v("Melos")]),t._v(" 的当前部分版本要求，如下所示")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Version")]),t._v(" "),a("th",[t._v("Min Dart SDK")]),t._v(" "),a("th",[t._v("Flutter 版本")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("7.1.1")]),t._v(" "),a("td",[t._v("3.9")]),t._v(" "),a("td",[t._v("3.35.0")])]),t._v(" "),a("tr",[a("td",[t._v("7.0.0")]),t._v(" "),a("td",[t._v("3.9")]),t._v(" "),a("td",[t._v("3.35.0")])]),t._v(" "),a("tr",[a("td",[t._v("7.0.0-dev.10")]),t._v(" "),a("td",[t._v("3.8")]),t._v(" "),a("td",[t._v("3.32.0")])]),t._v(" "),a("tr",[a("td",[t._v("7.0.0-dev.8")]),t._v(" "),a("td",[t._v("3.6")]),t._v(" "),a("td",[t._v("3.27.0")])])])]),t._v(" "),a("p",[t._v("所以只能挑个 "),a("code",[t._v("7.0.0-dev.8")]),t._v(" 先用用，如果你已经用上了 "),a("code",[t._v("Flutter 3.35.0")]),t._v("，则可使用当前最新正式版 "),a("code",[t._v("7.1.1")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"初始化仓库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始化仓库"}},[t._v("#")]),t._v(" 初始化仓库")]),t._v(" "),a("p",[t._v("创建 "),a("code",[t._v("workspace")]),t._v(" 仓库（当然，你也可以基于现有仓库进行改造），名字你随意，这里我以 "),a("code",[t._v("lxf_workspace")]),t._v(" 为例。")]),t._v(" "),a("p",[t._v("创建 "),a("code",[t._v("pubspec.yaml")]),t._v("，内容如下")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" lxf_workspace\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("publish_to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" none\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sdk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ^3.6.0\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dev_dependencies")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 与全局安装的保持一致")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("melos")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 7.0.0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev.8\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("workspace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" apps/app_a\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" packages/package_a\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" packages/package_a/example\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" packages/package_b\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" packages/package_b/example\n")])])]),a("p",[t._v("从 "),a("code",[t._v("Dart 3.11")]),t._v(" 开始支持 "),a("code",[t._v("globs")]),t._v(" 语法，可以让 "),a("code",[t._v("pubspec")]),t._v(" 更加干净，如下所示")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("workspace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" apps/"),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("**")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" packages/"),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("**")]),t._v("\n")])])]),a("p",[t._v("调整所有工程包位置，如壳工程存放至 "),a("code",[t._v("apps")]),t._v(" 目录，其它包存放至 "),a("code",[t._v("packages")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"工作区结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#工作区结构"}},[t._v("#")]),t._v(" 工作区结构")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n├── README.md\n├── apps\n│   └── app_a\n├── melos.yaml\n├── packages\n│   ├── package_a\n│   ├── package_b\n│   ├── package_c\n│   └── "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n├── pubspec.lock\n└── pubspec.yaml\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("文件(夹)")]),t._v(" "),a("th",[t._v("作用")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("apps")])]),t._v(" "),a("td",[t._v("存放壳工程，或其它 "),a("code",[t._v("app")]),t._v(" 工程")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("packages")])]),t._v(" "),a("td",[t._v("存放各个仓库的工程，如：业务工程，组件包")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("pubspec.yaml")])]),t._v(" "),a("td",[t._v("声明 "),a("code",[t._v("workspace")]),t._v("，重写依赖，定义 "),a("code",[t._v("Melos")]),t._v(" 脚本")])])])]),t._v(" "),a("h3",{attrs:{id:"调整-pubspec-yaml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调整-pubspec-yaml"}},[t._v("#")]),t._v(" 调整 pubspec.yaml")]),t._v(" "),a("p",[a("code",[t._v("lxf_workspace")]),t._v(" 中涉及到的包（即 "),a("code",[t._v("workspace")]),t._v(" 下声明的那些），其 "),a("code",[t._v("pubspec.yaml")]),t._v(" 都需要做如下两个调整")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("environment.sdk")]),t._v(" 需 "),a("code",[t._v(">=3.6.0")])]),t._v(" "),a("li",[t._v("新增 "),a("code",[t._v("resolution: workspace")])])]),t._v(" "),a("p",[t._v("如下所示")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pubspec.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sdk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('">=3.6.0 <4.0.0"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resolution")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" workspace\n")])])]),a("p",[t._v("注意，这些包可以有 "),a("code",[t._v("dependency_overrides")]),t._v("，但不可以同时对同一个包进行重写，否则会冲突！所以建议将这些重写统一放到 "),a("code",[t._v("lxf_workspace")]),t._v(" 的 "),a("code",[t._v("pubspec.yaml")]),t._v("中。")]),t._v(" "),a("h3",{attrs:{id:"启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动"}},[t._v("#")]),t._v(" 启动")]),t._v(" "),a("p",[t._v("执行 "),a("code",[t._v("melos bs")])]),t._v(" "),a("blockquote",[a("p",[t._v("注意：这里再强调一遍，"),a("code",[t._v("melos bs")]),t._v(" 不是应用 "),a("code",[t._v("Pub Workspaces")]),t._v(" 的必要流程，使用 "),a("code",[t._v("Melos")]),t._v(" 的主要原因是为了使用其脚本功能和 "),a("code",[t._v("Hook")]),t._v(" 来提效，如果你不需要这些，也可以直接使用 "),a("code",[t._v("flutter pub get")]),t._v("。")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('❯ melos bs\nmelos bootstrap\n  └> /Users/lxf/lxf_workspace\n\nRunning "flutter pub get" in workspace...\n  > SUCCESS\n\nGenerating IntelliJ IDE files...\n  > SUCCESS\n\n -> 5 packages bootstrapped\n')])])]),a("p",[t._v("根据上述的 "),a("code",[t._v("Pub Workspaces")]),t._v(" 的核心原则，它会将所有包的 "),a("code",[t._v("pubspec.lock")]),t._v(" 都删除，所有包都会新增 "),a("code",[t._v(".dart_tool/pub/workspace_ref.json")]),t._v(" 并指向根，即 "),a("code",[t._v("lxf_workspace")]),t._v(" 目录。")]),t._v(" "),a("p",[t._v("如果你需要更新依赖，则直接在 "),a("code",[t._v("lxf_workspace")]),t._v(" 目录下执行 "),a("code",[t._v("flutter pub upgrade")]),t._v(" 即可，这些跟原来的一样。")]),t._v(" "),a("p",[t._v("如果你想重写一些第三方库，可以在 "),a("code",[t._v("pubspec.yaml")]),t._v(" 中的 "),a("code",[t._v("dependency_overrides")]),t._v(" 进行重写")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pubspec.yaml")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dependency_overrides")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrollview_observer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ^1.26.2\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# chat_bottom_container:")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   path: packages/chat_bottom_container")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("workspace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n")])])]),a("p",[t._v("在完成这些调整后，后续的开发流程还是跟原先一样，只是现在统一在一个 "),a("code",[t._v("IDE")]),t._v(" 窗口中操作罢了，这里就不再赘述。")]),t._v(" "),a("h2",{attrs:{id:"六、最后"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、最后"}},[t._v("#")]),t._v(" 六、最后")]),t._v(" "),a("p",[t._v("以上便是基于将所有内容（"),a("code",[t._v("workspace")]),t._v("、"),a("code",[t._v("apps")]),t._v(" 和 "),a("code",[t._v("packages")]),t._v("）都上传至一个大型仓库，并统一管理的 "),a("code",[t._v("Monorepo")]),t._v(" 方案的实践。")]),t._v(" "),a("p",[t._v("而对于想继续多仓库管理工程包的我来说，还需要对该方案进行改造，因为我觉得分久必合，合久必分是迟早的事，再加上我也比较懒～")]),t._v(" "),a("p",[t._v("好了，下一篇来讲讲我的本地 "),a("code",[t._v("Monorepo")]),t._v(' 的 "拼好包" 方案和一些优化。')]),t._v(" "),a("h2",{attrs:{id:"资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#资料"}},[t._v("#")]),t._v(" 资料")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://dart.cn/tools/pub/workspaces",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://dart.cn/tools/pub/workspaces"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"melos.invertase.dev/~melos-latest"}},[t._v("melos.invertase.dev/~melos-latest")])])])])}),[],!1,null,null,null);a.default=_.exports}}]);