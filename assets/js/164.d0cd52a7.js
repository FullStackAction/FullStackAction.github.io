(window.webpackJsonp=window.webpackJsonp||[]).push([[164],{586:function(a,e,s){"use strict";s.r(e);var t=s(21),_=Object(t.a)({},(function(){var a=this,e=a._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h2",{attrs:{id:"一、前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、前言"}},[a._v("#")]),a._v(" 一、前言")]),a._v(" "),e("p",[a._v("在上一篇 "),e("RouterLink",{attrs:{to:"/pages/c10ea8/"}},[a._v("Flutter - Melos Pub workspaces 实践")]),a._v(" 中我们探讨了 "),e("code",[a._v("Monorepo")]),a._v(" 实践，但这与我们当前多仓库、多业务包的现状不符。我们希望在维持多仓库管理模式的同时，也能利用 "),e("code",[a._v("Melos")]),a._v(" 和 "),e("code",[a._v("Pub workspaces")]),a._v(" 的优势。")],1),a._v(" "),e("p",[a._v("本文的主题 —— “拼好包”，就是为解决这一问题而提出的方案。")]),a._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/LinXunFeng/local_pub_workspace",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://github.com/LinXunFeng/local_pub_workspace"),e("OutboundLink")],1)]),a._v(" "),e("h2",{attrs:{id:"二、调整"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、调整"}},[a._v("#")]),a._v(" 二、调整")]),a._v(" "),e("p",[a._v("延用上一篇的工作区 "),e("code",[a._v("lxf_workspace")]),a._v("，不同之处在于，我们会按需将其他独立仓库的 "),e("code",[a._v("app")]),a._v(" 工程和业务包通过 "),e("code",[a._v("Git")]),a._v("  拉取放置在 "),e("code",[a._v("apps")]),a._v(" 和 "),e("code",[a._v("packages")]),a._v(" 目录下，但这些文件仅存放于本地，并不会提交到工作区仓库。")]),a._v(" "),e("h3",{attrs:{id:"gitignore"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#gitignore"}},[a._v("#")]),a._v(" .gitignore")]),a._v(" "),e("p",[a._v("在 "),e("code",[a._v("apps")]),a._v(" 和 "),e("code",[a._v("packages")]),a._v(" 目录下都创建名为 "),e("code",[a._v(".gitkeep")]),a._v(" 的空白文件，并将如下内容添加至 "),e("code",[a._v(".gitignore")]),a._v("。")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("# .gitignore\n\n!apps/.gitkeep\n!packages/.gitkeep\n")])])]),e("p",[a._v("这样可保持这两个空目录同步至 "),e("code",[a._v("lxf_workspace")]),a._v(" 仓库，别人拉下来就不用再手动创建他们了。")]),a._v(" "),e("h3",{attrs:{id:"工作区结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#工作区结构"}},[a._v("#")]),a._v(" 工作区结构")]),a._v(" "),e("p",[a._v("这里以上一篇中的工作区仓库为例，结构如下")]),a._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n├── README.md\n├── analysis_options.yaml\n├── apps\n│   ├── .gitkeep\n│   └── app_a\n├── melos.yaml\n├── packages\n│   ├── .gitkeep\n│   ├── package_a\n│   ├── package_b\n│   ├── package_c\n│   └── "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(".\n├── pubspec.lock\n├── pubspec.yaml\n├── script\n│   └── apply_app_pubspec_overrides.sh\n└── tool\n    ├── README.md\n    ├── commands\n    │   ├── dependency_overrides.dart\n    │   ├── setup_workspace.dart\n    │   ├── update_analysis_options.dart\n    │   ├── update_app_pubspec_overrides.dart\n    │   ├── update_launch_json.dart\n    │   └── update_settings_json.dart\n    ├── core\n    │   └── workspace_manager.dart\n    └── main.dart\n")])])]),e("table",[e("thead",[e("tr",[e("th",[a._v("文件(夹)")]),a._v(" "),e("th",[a._v("作用")])])]),a._v(" "),e("tbody",[e("tr",[e("td",[e("code",[a._v("analysis_options.yaml")])]),a._v(" "),e("td",[e("code",[a._v("Dart")]),a._v(" 代码分析配置文件，主要用来减少不必要的分析")])]),a._v(" "),e("tr",[e("td",[e("code",[a._v("apps")])]),a._v(" "),e("td",[e("strong",[a._v("【本地】")]),a._v(" 存放壳工程，或其它 "),e("code",[a._v("app")]),a._v(" 工程")])]),a._v(" "),e("tr",[e("td",[e("code",[a._v("packages")])]),a._v(" "),e("td",[e("strong",[a._v("【本地】")]),a._v(" 存放各个仓库的工程，如：业务工程，组件库")])]),a._v(" "),e("tr",[e("td",[e("code",[a._v("pubspec.yaml")])]),a._v(" "),e("td",[a._v("声明 "),e("code",[a._v("workspace")]),a._v("，重写依赖，定义 "),e("code",[a._v("Melos")]),a._v(" 脚本")])]),a._v(" "),e("tr",[e("td",[e("code",[a._v("script")])]),a._v(" "),e("td",[a._v("存放了各种辅助脚本")])]),a._v(" "),e("tr",[e("td",[e("code",[a._v("tool")])]),a._v(" "),e("td",[a._v("存放了各种辅助命令")])])])]),a._v(" "),e("p",[a._v("在 "),e("code",[a._v("tool")]),a._v(" 目录下，存放了一些十分有用的辅助命令，基本上都是在 "),e("code",[a._v("melos bs")]),a._v(" 后自动执行的，无须手动操作。")]),a._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# pubspec.yaml")]),a._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("melos")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("scripts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("prepare")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" melos bootstrap\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("clean")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" melos clean\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("pub_upgrade")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("run")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" flutter pub upgrade\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新工作区的 launch.json 文件")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("update_launch_json")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" dart tool/main.dart update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("launch\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新工作区的 settings.json 文件")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("update_settings_json")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" dart tool/main.dart update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("settings\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新工作区的 analysis_options.yaml 文件")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("update_analysis_options_yaml")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" dart tool/main.dart update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("analysis\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新所有 app 工程的 pubspec_overrides.yaml 文件")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("update_app_pubspec_overrides")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" dart tool/main.dart update"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("pubspec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("overrides\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# dependency_overrides 本地仓库执行 flutter pub get")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deps_overrides_get")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" dart tool/main.dart dependency"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("overrides "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("get\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# dependency_overrides 本地仓库执行 flutter pub upgrade")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deps_overrides_upgrade")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" dart tool/main.dart dependency"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("overrides "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("upgrade\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 设置工作空间依赖")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("setup_workspace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" dart tool/main.dart setup"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("workspace\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("setup_workspace_no")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" dart tool/main.dart setup"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("workspace "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("no"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("workspace\n\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("command")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("bootstrap")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("hooks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 在 bootstrap 执行后执行")]),a._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("post")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("|")]),e("span",{pre:!0,attrs:{class:"token scalar string"}},[a._v('\n          echo "更新 VSCode settings.json 配置..."\n          melos run update_settings_json\n          echo "更新 VSCode launch.json 配置..."\n          melos run update_launch_json\n          echo "更新 analysis_options.yaml 配置..."\n          melos run update_analysis_options_yaml\n          # melos run deps_overrides_get\n          melos run deps_overrides_upgrade')]),a._v("\n")])])]),e("p",[a._v("注意，因为在研发过程中，我们只关心当前被集成的包，如本地 "),e("code",[a._v("packages")]),a._v(" 目录下有十几个包，但我的需求只需要我处理 "),e("code",[a._v("package_a")]),a._v("，则工作区的 "),e("code",[a._v("pubspec.yaml")]),a._v(" 需做如下调整")]),a._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# pubspec.yaml")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("workspace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" apps/app_a\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" packages/package_a\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" packages/package_a/example\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# - packages/package_b")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# - packages/package_b/example")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("...")]),a._v("\n")])])]),e("blockquote",[e("p",[a._v("建议把 "),e("code",[a._v("packages")]),a._v(" 下的业务包都列出来，这样大家拉下来后只需要做取消注释操作，而不需要自己手动添加。")])]),a._v(" "),e("p",[a._v("以下内容均以该配置进行说明！")]),a._v(" "),e("h2",{attrs:{id:"三、辅助命令与脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三、辅助命令与脚本"}},[a._v("#")]),a._v(" 三、辅助命令与脚本")]),a._v(" "),e("h3",{attrs:{id:"项目运行"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#项目运行"}},[a._v("#")]),a._v(" 项目运行")]),a._v(" "),e("p",[e("code",[a._v("VSCode")]),a._v(" 虽提供自动生成 "),e("code",[a._v("launch.json")]),a._v(" 的便捷功能（删除旧文件后点击"),e("code",[a._v("创建 launch.json 文件")]),a._v("），但对于包含多个 "),e("code",[a._v("Flutter")]),a._v(" 包的 "),e("code",[a._v("Monorepo")]),a._v(" 项目而言，这种自动生成方式会导致：")]),a._v(" "),e("ol",[e("li",[e("strong",[a._v("配置冗长混乱：")]),a._v("  生成的运行配置列表过于庞大。")]),a._v(" "),e("li",[e("strong",[a._v("项目难以区分：")]),a._v("  当多个包内存在同名 "),e("code",[a._v("example")]),a._v(" 目录时，调试选项会变得模糊不清，严重影响开发效率。")])]),a._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202510261428816.jpg",alt:""}})]),a._v(" "),e("p",[a._v("为解决上述问题，我实现了 "),e("code",[a._v("update-launch")]),a._v(" 命令，该命令旨在提供一个简洁、高效的调试配置管理方案：")]),a._v(" "),e("ol",[e("li",[e("strong",[a._v("智能解析：")]),a._v("  自动解析项目根目录 "),e("code",[a._v("pubspec.yaml")]),a._v(" 文件中的 "),e("code",[a._v("workspace")]),a._v(" 配置。")]),a._v(" "),e("li",[e("strong",[a._v("精准生成：")]),a._v("  为工作区内的每个 Flutter 包生成命名清晰、易于辨识的运行配置。生成时，优先为包的 "),e("code",[a._v("example")]),a._v(" 目录创建配置；若无 "),e("code",[a._v("example")]),a._v(" 目录，则直接为包本身创建配置。例如，只会保留 "),e("code",[a._v("apps/app_a")]),a._v(" 和 "),e("code",[a._v("packages/package_a/example")]),a._v(" 的配置，如果 "),e("code",[a._v("package_a")]),a._v(" 没有 "),e("code",[a._v("example")]),a._v("，则为 "),e("code",[a._v("packages/package_a")]),a._v("。")])]),a._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202510261428675.png",alt:""}})]),a._v(" "),e("p",[a._v("通过在 "),e("code",[a._v("melos")]),a._v(" 中设置钩子，"),e("code",[a._v("update-launch")]),a._v(" 脚本会在执行 "),e("code",[a._v("melos bs")]),a._v(" 命令后自动运行。这确保了 "),e("code",[a._v(".vscode/launch.json")]),a._v(" 文件始终保持动态更新，从而在 "),e("code",[a._v("VSCode")]),a._v(" 的“运行和调试”面板中呈现一个精简、有序且易于选择的调试选项列表，极大提升了 "),e("code",[a._v("Monorepo")]),a._v(" 环境下的开发体验。")]),a._v(" "),e("h3",{attrs:{id:"隐藏无用项目"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#隐藏无用项目"}},[a._v("#")]),a._v(" 隐藏无用项目")]),a._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202510261429196.png",alt:""}})]),a._v(" "),e("p",[a._v("为了保持工作区整洁，避免 "),e("code",[a._v("packages")]),a._v(" 目录下项目过多造成干扰，我们可以通过配置 "),e("code",[a._v(".vscode/settings.json")]),a._v(" 中的 "),e("code",[a._v("files.exclude")]),a._v(" 选项来隐藏当前开发任务不需要的包。例如，将 "),e("code",[a._v("package_b")]),a._v(" 的路径加入该配置即可在文件浏览器中隐藏它，从而让我们更专注于相关代码。")]),a._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[a._v('"files.exclude"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v('// "**/apps/app_a/**": true,')]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v('// "**/packages/package_a/**": true,')]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[a._v('"**/packages/package_b/**"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[a._v('"**/packages/package_c/**"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[a._v('"**/packages/package_d/**"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[a._v('"**/packages/package_e/**"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202510261429862.png",alt:""}})]),a._v(" "),e("p",[a._v("当项目包增多时，手动修改 "),e("code",[a._v("settings.json")]),a._v(" 切换文件可见性效率低下，而 "),e("code",[a._v("update-settings")]),a._v(" 命令可自动化此过程！")]),a._v(" "),e("p",[a._v("它会读取 "),e("code",[a._v("pubspec.yaml")]),a._v(" 的 "),e("code",[a._v("workspace")]),a._v(" 配置，并在 "),e("code",[a._v("settings.json")]),a._v(" 中动态注释/取消注释 "),e("code",[a._v("files.exclude")]),a._v(" 规则，只显示当前工作区所需项目。")]),a._v(" "),e("p",[a._v("该脚本已配置为在 "),e("code",[a._v("melos bs")]),a._v(" 命令后自动运行，无需手动干预。")]),a._v(" "),e("h3",{attrs:{id:"优化代码分析压力"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#优化代码分析压力"}},[a._v("#")]),a._v(" 优化代码分析压力")]),a._v(" "),e("p",[a._v("随着 "),e("code",[a._v("packages")]),a._v(" 数量的增加，即使在 "),e("code",[a._v("VSCode")]),a._v(" 中隐藏了不相关的项目，"),e("code",[a._v("Dart")]),a._v(" 分析器仍会分析所有代码，这会导致分析速度显著变慢，影响开发效率。")]),a._v(" "),e("p",[e("strong",[a._v("解决方案")]),a._v("：通过在 "),e("code",[a._v("analysis_options.yaml")]),a._v(" 文件中配置 "),e("code",[a._v("analyzer.exclude")]),a._v("，明确排除不需要分析的目录。")]),a._v(" "),e("p",[e("strong",[a._v("示例")]),a._v("：若要排除 "),e("code",[a._v("package_b")]),a._v("，可按如下方式配置：")]),a._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("analyzer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("exclude")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# - apps/app_a/**")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# - packages/package_a/**")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" packages/package_b/"),e("span",{pre:!0,attrs:{class:"token important"}},[a._v("**")]),a._v("\n")])])]),e("p",[a._v("为了简化此过程，我已实现自动化。")]),a._v(" "),e("p",[e("code",[a._v("update-analysis")]),a._v(" 脚本会在 "),e("code",[a._v("melos bs")]),a._v(" 执行后自动运行，根据当前工作区动态更新 "),e("code",[a._v("analysis_options.yaml")]),a._v(" 文件，确保分析器始终保持高效。")]),a._v(" "),e("h3",{attrs:{id:"打包"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#打包"}},[a._v("#")]),a._v(" 打包")]),a._v(" "),e("p",[e("code",[a._v("Monorepo")]),a._v(" 架构能有效提升代码复用和管理效率。然而，当项目采用多仓库、多业务包模式时，如何将 "),e("code",[a._v("Monorepo")]),a._v(" 的优势与现有工作流结合，并解决特定打包难题，是我们需要面对的挑战。")]),a._v(" "),e("blockquote",[e("p",[a._v("本文聚焦于 "),e("code",[a._v("app_a")]),a._v(" 的打包问题，并提出一套基于 "),e("code",[a._v("pubspec_overrides.yaml")]),a._v(" 的解决方案。")])]),a._v(" "),e("p",[e("code",[a._v("app_a")]),a._v(" 打包面临的挑战")]),a._v(" "),e("p",[a._v("在当前的多仓库 "),e("code",[a._v("Monorepo")]),a._v(" 环境下，"),e("code",[a._v("app_a")]),a._v(" 的打包流程面临两大核心挑战：")]),a._v(" "),e("ol",[e("li",[e("strong",[e("code",[a._v("Pub workspaces")]),a._v(" 限制与 "),e("code",[a._v("resolution: workspace")]),a._v(" 冲突")]),a._v("： "),e("code",[a._v("app_a")]),a._v(" 的 "),e("code",[a._v("pubspec.yaml")]),a._v(" 中声明了 "),e("code",[a._v("resolution: workspace")]),a._v("，这表示它依赖于工作区内的包。然而，当 "),e("code",[a._v("app_a")]),a._v(" 被单独拉取或在非 "),e("code",[a._v("Monorepo")]),a._v(" 环境下构建时，由于无法解析 "),e("code",[a._v("workspace")]),a._v(" 依赖，会导致依赖拉取失败。为了解决这个问题，在打包时需要将此配置注释掉或重写。")]),a._v(" "),e("li",[e("strong",[a._v("功能分支开发与 "),e("code",[a._v("Git")]),a._v(" 依赖管理")]),a._v("： "),e("code",[a._v("app_a")]),a._v(" 通常依赖于 "),e("code",[a._v("master")]),a._v(" 分支上的业务包，例如：")])]),a._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# app_a/pubspec.yaml")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("environment")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("sdk")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('">=3.6.0 <4.0.0"')]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("resolution")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" workspace\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("dependencies")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("package_a")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("git")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" git@code.gitlab.com"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("lxf/package_a.git\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ref")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" master\n")])])]),e("p",[a._v("当需要对 "),e("code",[a._v("package_a")]),a._v(" 进行功能开发时（例如在 "),e("code",[a._v("feature/拼好包分支")]),a._v(" 上），传统的做法是在 "),e("code",[a._v("app_a")]),a._v(" 的 "),e("code",[a._v("dependency_overrides")]),a._v(" 中重写 "),e("code",[a._v("package_a")]),a._v(" 的依赖，并提交到版本库。")]),a._v(" "),e("p",[a._v("然而，在 "),e("code",[a._v("app_a")]),a._v(" 和 "),e("code",[a._v("package_a")]),a._v(" 都处于 "),e("code",[a._v("workspace")]),a._v(" 下的 "),e("code",[a._v("Monorepo")]),a._v(" 结构中，这种直接重写会导致冲突和报错，无法正常打包。")]),a._v(" "),e("hr"),a._v(" "),e("p",[a._v("解决方案："),e("code",[a._v("pubspec_overrides.yaml")]),a._v(" 动态配置")]),a._v(" "),e("p",[a._v("为了解决上述挑战，我采用了基于 "),e("code",[a._v("pubspec_overrides.yaml")]),a._v(" 的动态配置方案，它将开发与打包时的依赖管理进行分离：")]),a._v(" "),e("p",[a._v("1、"),e("strong",[a._v("生成预备配置 ("),e("code",[a._v("update_app_pubspec_overrides")]),a._v(")")]),a._v(" ：")]),a._v(" "),e("p",[a._v("在开发阶段，通过执行 "),e("code",[a._v("update_app_pubspec_overrides")]),a._v(" 命令，为每个 "),e("code",[a._v("app")]),a._v(" 工程（例如 "),e("code",[a._v("app_a")]),a._v("）生成一个 "),e("code",[a._v("pubspec_overrides.yaml")]),a._v(" 文件。这个文件包含了所有打包所需的重写规则，例如修正 "),e("code",[a._v("resolution")]),a._v(" 配置、指定 "),e("code",[a._v("Git")]),a._v(" 分支依赖等。"),e("strong",[a._v("关键在于，这些规则在生成时全部被注释掉")]),a._v("。此文件会随需求分支一同提交到版本控制系统。")]),a._v(" "),e("p",[a._v("生成的 "),e("code",[a._v("pubspec_overrides.yaml")]),a._v(" 示例内容如下：")]),a._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# resolution:")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# dependency_overrides:")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# # ====== app 工程中的 dependency_overrides")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# # ====== workspace 和 dependency_overrides 项目的 git 依赖")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#   package_a:")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#     git:")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#       url: git@code.gitlab.com:lxf/package_a.git")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#       ref: feature/拼好包分支")]),a._v("\n")])])]),e("p",[a._v("该文件主要包含以下几类重写：")]),a._v(" "),e("ul",[e("li",[a._v("重写 "),e("code",[a._v("resolution:")]),a._v(" 配置。")]),a._v(" "),e("li",[a._v("同步 "),e("code",[a._v("app")]),a._v(" 工程下 "),e("code",[a._v("pubspec.yaml")]),a._v(" 中定义的 "),e("code",[a._v("dependency_overrides")]),a._v("。")]),a._v(" "),e("li",[a._v("同步工作区 "),e("code",[a._v("pubspec.yaml")]),a._v(" 中 "),e("code",[a._v("workspace")]),a._v(" 和 "),e("code",[a._v("dependency_overrides")]),a._v(" 部分的 "),e("code",[a._v("Git")]),a._v(" 依赖。")])]),a._v(" "),e("p",[a._v("2、"),e("strong",[a._v("打包时应用配置 ("),e("code",[a._v("apply_app_pubspec_overrides.sh")]),a._v(")")]),a._v(" ：")]),a._v(" "),e("p",[a._v("在 "),e("code",[a._v("Jenkins")]),a._v(" 打包流程开始前，执行 "),e("code",[a._v("apply_app_pubspec_overrides.sh")]),a._v(" 脚本。该脚本会"),e("strong",[a._v("自动取消 "),e("code",[a._v("pubspec_overrides.yaml")]),a._v(" 文件中的注释")]),a._v("，使其中定义的打包专用重写规则生效。这样，打包系统就能正确解析依赖，顺利完成构建。")]),a._v(" "),e("p",[a._v("当需求分支合并到 "),e("code",[a._v("master")]),a._v(" 后，"),e("code",[a._v("pubspec_overrides.yaml")]),a._v(" 文件应还原为初始的注释状态（例如只包含 "),e("code",[a._v("# resolution:")]),a._v("）。"),e("code",[a._v("update-app-pubspec-overrides --restore")]),a._v(" 提供了还原功能，建议通过 CI/CD 流程自动完成此还原操作。")]),a._v(" "),e("p",[a._v("当然，这里的打包只是个简单的解决思路，请结合自身情况处理即可。")]),a._v(" "),e("h2",{attrs:{id:"四、最后"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四、最后"}},[a._v("#")]),a._v(" 四、最后")]),a._v(" "),e("p",[a._v("通过 "),e("code",[a._v("pubspec_overrides.yaml")]),a._v(" 动态配置方案，我们实现了开发与打包流程的解耦，有效解决了 "),e("code",[a._v("app_a")]),a._v(" 在 "),e("code",[a._v("Monorepo")]),a._v(" 环境下的依赖管理和打包难题。")]),a._v(" "),e("p",[e("strong",[a._v("研发流程：")])]),a._v(" "),e("ol",[e("li",[a._v("更新 "),e("code",[a._v("workspace")]),a._v(" 配置，取消需求涉及的包的注释。")]),a._v(" "),e("li",[a._v("执行 "),e("code",[a._v("melos bs")]),a._v("，自动完成包依赖解析和配置更新。")]),a._v(" "),e("li",[a._v("专注于功能开发。")])]),a._v(" "),e("p",[e("strong",[a._v("打包流程：")])]),a._v(" "),e("ol",[e("li",[a._v("执行 "),e("code",[a._v("melos run update_app_pubspec_overrides")]),a._v("。")]),a._v(" "),e("li",[a._v("提交 "),e("code",[a._v("app")]),a._v(" 下更新的 "),e("code",[a._v("pubspec_overrides.yaml")]),a._v("。")]),a._v(" "),e("li",[a._v("触发 "),e("code",[a._v("Jenkins")]),a._v(" 打包，"),e("code",[a._v("apply_app_pubspec_overrides.sh")]),a._v(" 脚本将自动激活打包配置。")])]),a._v(" "),e("p",[a._v("好了，本篇到此结束，这两篇 "),e("code",[a._v("Monorepo")]),a._v(" 的应用只是结合我自身使用场景去阐述的，如有不同意见，以你的为准，欢迎在评论区留下你的见解。")])])}),[],!1,null,null,null);e.default=_.exports}}]);