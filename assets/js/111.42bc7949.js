(window.webpackJsonp=window.webpackJsonp||[]).push([[111],{519:function(t,a,e){"use strict";e.r(a);var s=e(21),_=Object(s.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[a("code",[t._v("Mach-O")]),t._v(" 是 "),a("code",[t._v("iOS/macOS")]),t._v(" 系统上应用程序的文件格式，了解 "),a("code",[t._v("Mach-O")]),t._v(" 文件的格式，有利于我们后续对应用进行静态分析和动态调试。")]),t._v(" "),a("h2",{attrs:{id:"分析-mach-o-文件的工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分析-mach-o-文件的工具"}},[t._v("#")]),t._v(" 分析 "),a("code",[t._v("Mach-O")]),t._v(" 文件的工具")]),t._v(" "),a("h3",{attrs:{id:"otool"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#otool"}},[t._v("#")]),t._v(" "),a("code",[t._v("otool")])]),t._v(" "),a("p",[t._v("此为命令行的方式，具体参数可以使用 "),a("code",[t._v("man")]),t._v(" 进行查看")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("man")]),t._v(" otool\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-h")]),t._v("     Display the Mach header.\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-l")]),t._v("     Display the load commands.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n")])])]),a("p",[t._v("其中 "),a("code",[t._v("-h")]),t._v(" 可查看 "),a("code",[t._v("Header")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("otool "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-h")]),t._v(" Mach-O文件\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261628505.png",alt:"otool -h"}})]),t._v(" "),a("p",[a("code",[t._v("-l")]),t._v(" 可查看 "),a("code",[t._v("load commands")]),t._v("，打印的内容太多就不展示了，有兴趣的可以自己打印看看")]),t._v(" "),a("h3",{attrs:{id:"machoview"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#machoview"}},[t._v("#")]),t._v(" "),a("code",[t._v("MachOView")])]),t._v(" "),a("p",[t._v("免费开源的 "),a("code",[t._v("Mach-O")]),t._v(" 文件分析工具")]),t._v(" "),a("ul",[a("li",[t._v("GitHub链接："),a("a",{attrs:{href:"https://github.com/gdbinit/MachOView",target:"_blank",rel:"noopener noreferrer"}},[t._v("gdbinit/MachOView"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("蓝奏云链接："),a("a",{attrs:{href:"https://linxunfeng.lanzoul.com/iinjCxuj8te",target:"_blank",rel:"noopener noreferrer"}},[t._v("MachOView.dmg"),a("OutboundLink")],1)])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261628293.png",alt:"MachOView"}})]),t._v(" "),a("h3",{attrs:{id:"_010-editor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_010-editor"}},[t._v("#")]),t._v(" "),a("code",[t._v("010 Editor")])]),t._v(" "),a("ul",[a("li",[t._v("官网链接： "),a("a",{attrs:{href:"https://www.sweetscape.com/download/010editor/",target:"_blank",rel:"noopener noreferrer"}},[t._v("010 Editor"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("MachO模板："),a("a",{attrs:{href:"https://github.com/strazzere/010Editor-stuff/blob/master/Templates/MachOTemplate.bt",target:"_blank",rel:"noopener noreferrer"}},[t._v("MachOTemplate.bt"),a("OutboundLink")],1)])]),t._v(" "),a("p",[a("code",[t._v("010 Editor")]),t._v(" 的模板功能很强大，收费产品，不过要分析 "),a("code",[t._v("ARM64")]),t._v(" 架构的 "),a("code",[t._v("Mach-O")]),t._v(" 程序，需要借助第三方模板。")]),t._v(" "),a("p",[t._v("菜单依次选择："),a("code",[t._v("Templates")]),t._v(" -> "),a("code",[t._v("View Installed Templates")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261629510.png",alt:"Add Template"}})]),t._v(" "),a("p",[t._v("点击 "),a("code",[t._v("Add")]),t._v(" 按钮，选择下载好的 "),a("code",[t._v("MachOTemplate.bt")]),t._v("，可以配置 "),a("code",[t._v("Name")]),t._v(" 和 "),a("code",[t._v("Category")]),t._v(" 等，然后点击 "),a("code",[t._v("OK")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261630329.png",alt:""}})]),t._v(" "),a("p",[t._v("回到程序，将 "),a("code",[t._v("Mach-O")]),t._v(" 插入到 "),a("code",[t._v("010 Editor")]),t._v("中，接着在 "),a("code",[t._v("Templates")]),t._v(" 菜单中选择刚才点击的模板")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261630148.png",alt:""}})]),t._v(" "),a("p",[t._v("分析结果如图所示\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261632164.png",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"mach-o-的结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mach-o-的结构"}},[t._v("#")]),t._v(" "),a("code",[t._v("Mach-O")]),t._v(" 的结构")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261632280.png",alt:"mach-o-structure-official"}})]),t._v(" "),a("p",[t._v("如上图所示，"),a("code",[t._v("Mach-O")]),t._v(" 文件由三部分组成")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("部分")]),t._v(" "),a("th",[t._v("作用")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Mach-O头部（"),a("code",[t._v("Header")]),t._v("）")]),t._v(" "),a("td",[t._v("保存了 "),a("code",[t._v("CPU")]),t._v(" 架构、大小端序、文件类型、加载命令数量等一些基本信息")])]),t._v(" "),a("tr",[a("td",[t._v("加载命令（"),a("code",[t._v("Load Commands")]),t._v("）")]),t._v(" "),a("td",[t._v("指定了文件的逻辑结构与文件在虚拟内存中的布局")])]),t._v(" "),a("tr",[a("td",[t._v("数据块（"),a("code",[t._v("Data")]),t._v("）")]),t._v(" "),a("td",[a("code",[t._v("Load Commands")]),t._v(" 中定义的 "),a("code",[t._v("Segment")]),t._v(" 的原始数据")])])])]),t._v(" "),a("h3",{attrs:{id:"header"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#header"}},[t._v("#")]),t._v(" "),a("code",[t._v("Header")])]),t._v(" "),a("blockquote",[a("p",[a("code",[t._v("Mach-o")]),t._v(" 头部（"),a("code",[t._v("Header")]),t._v("）保存了 "),a("code",[t._v("CPU")]),t._v(" 架构、大小端序、文件类型、加载命令数量等一些基本信息，用于校验 "),a("code",[t._v("Mach-O")]),t._v(" 文件的合法性和确定文件的运行环境。")])]),t._v(" "),a("p",[t._v("在 "),a("code",[t._v("Xcode")]),t._v(" 中按快捷键 "),a("code",[t._v("⌘ + Shift + o")]),t._v(" ，输入 "),a("code",[t._v("mach-o/loader.h")]),t._v("，即可找到头部的定义")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261635231.png",alt:"mach-o/loader.h"}})]),t._v(" "),a("p",[a("code",[t._v("32")]),t._v(" 位和 "),a("code",[t._v("64")]),t._v(" 位架构的 "),a("code",[t._v("CPU")]),t._v(" 分别使用 "),a("code",[t._v("mach_header")]),t._v(" 与 "),a("code",[t._v("mach_header_64")]),t._v(" 结构体来描述 "),a("code",[t._v("Mach-O")]),t._v(" 头部，本文所述内容均以 "),a("code",[t._v("64")]),t._v(" 位为主，定义如下：")]),t._v(" "),a("div",{staticClass:"language-c extra-class"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*\n * The 64-bit mach header appears at the very beginning of object files for\n * 64-bit architectures.\n */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("mach_header_64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("    magic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* mach magic number identifier */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("cpu_type_t")]),t._v("  cputype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* cpu specifier */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("cpu_subtype_t")]),t._v("  cpusubtype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* machine specifier */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("    filetype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* type of file */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("    ncmds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* number of load commands */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("    sizeofcmds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* the size of all the load commands */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("    flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* flags */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("    reserved"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* reserved */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Constant for the magic field of the mach_header_64 (64-bit architectures) */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("MH_MAGIC_64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xfeedfacf")]),t._v(" ")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* the 64-bit mach magic number */")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("MH_CIGAM_64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xcffaedfe")]),t._v(" ")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* NXSwapInt(MH_MAGIC_64) */")])]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("字段")]),t._v(" "),a("th",[t._v("作用")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("magic")])]),t._v(" "),a("td",[t._v("魔数（特征字段），用于标识当前设备是大端序还是小端序。"),a("br"),t._v("由于 "),a("code",[t._v("iOS")]),t._v(" 是小端序，所以其被定义常量 "),a("code",[t._v("MH_MAGIC_64")]),t._v("，即固定取值为 "),a("code",[t._v("0xfeedfacf")])])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("cputype")])]),t._v(" "),a("td",[t._v("标识 "),a("code",[t._v("CPU")]),t._v(" 架构，类型为 "),a("code",[t._v("cpu_type_t")]),t._v("，其定义于 "),a("code",[t._v("mach/machine.h")])])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("cpusubtype")])]),t._v(" "),a("td",[t._v("标具体的 "),a("code",[t._v("CPU")]),t._v(" 架构，区分不同版本的处理器，类型为 "),a("code",[t._v("cpusubtype")]),t._v("，其定义于 "),a("code",[t._v("mach/machine.h")])])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("filetype")])]),t._v(" "),a("td",[a("code",[t._v("Mach-O")]),t._v(" 文件类型（如：可执行文件、库文件等），可在 "),a("code",[t._v("mach-o/loader.h")]),t._v(" 中找到具体定义和取值。"),a("br"),t._v("常见的有 "),a("code",[t._v("MH_OBJECT")]),t._v("（中间目标文件）、"),a("code",[t._v("MH_EXECUTE")]),t._v("（可执行文件）、"),a("code",[t._v("MH_DYLIB")]),t._v("（动态链接库）、"),a("code",[t._v("MH_DYLINKER")]),t._v("（动态链接器）")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("ncmds")])]),t._v(" "),a("td",[a("code",[t._v("Load Commands")]),t._v(" 的数量")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("sizeofcmds")])]),t._v(" "),a("td",[a("code",[t._v("Load Commands")]),t._v(" 所占的总字节大小")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("flags")])]),t._v(" "),a("td",[t._v("一些标识信息，可在 "),a("code",[t._v("mach-o/loader.h")]),t._v(" 中找到具体定义和取值。"),a("br"),t._v("其中 "),a("code",[t._v("#define MH_PIE 0x200000")]),t._v(" 值得注意，只会在文件类型为 "),a("code",[t._v("MH_EXECUTE")]),t._v(" 时使用，表明开启 "),a("code",[t._v("ASLR")]),t._v("，用来增加程序安全性。")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("reserved")])]),t._v(" "),a("td",[t._v("系统保留字段")])])])]),t._v(" "),a("p",[t._v("注： "),a("code",[t._v("ASLR")]),t._v(" ，全称 "),a("code",[t._v("Address Space Layout Randomization")]),t._v("，地址空间布局随机化，顾名思义，每次启动程序，加载的地址都会随机变化，需要对代码地址进行计算修正才可正常访问。")]),t._v(" "),a("h3",{attrs:{id:"load-commands"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#load-commands"}},[t._v("#")]),t._v(" Load Commands")]),t._v(" "),a("blockquote",[a("p",[t._v("加载命令（"),a("code",[t._v("Load Commands")]),t._v("）紧跟 "),a("code",[t._v("Header")]),t._v("之后，指定了文件的逻辑结构与文件在虚拟内存中的布局，明确地告诉加载器如何处理二进制数据。有些命令由内核处理，有些由动态链接器("),a("code",[t._v("dyld")]),t._v(")处理。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261636453.png",alt:"Load Commands"}})]),t._v(" "),a("p",[a("code",[t._v("Load Commands")]),t._v(" 可以当作是多个 "),a("code",[t._v("command")]),t._v(" 的集合，每一个 "),a("code",[t._v("command")]),t._v(" 的类型 "),a("code",[t._v("cmd")]),t._v(" 都是以 "),a("code",[t._v("LC_")]),t._v(" 为前缀的常量，如 "),a("code",[t._v("LC_SEGMENT")]),t._v("。")]),t._v(" "),a("p",[t._v("在头文件 "),a("code",[t._v("mach-o/loader.h")]),t._v(" 中可以查看每个 "),a("code",[t._v("command")]),t._v(" 的定义，每个 "),a("code",[t._v("command")]),t._v(" 都拥有自己的独立结构，但是其结构的前两个字段固定为 "),a("code",[t._v("cmd")]),t._v(" 和 "),a("code",[t._v("cmdsize")])]),t._v(" "),a("div",{staticClass:"language-c extra-class"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("load_command")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" cmd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* type of load command */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" cmdsize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* total size of command in bytes */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("字段")]),t._v(" "),a("th",[t._v("作用")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("cmd")])]),t._v(" "),a("td",[t._v("当前 "),a("code",[t._v("Load Commands")]),t._v(" 的类型，如 "),a("code",[t._v("LC_SEGMENT")])])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("cmdsize")])]),t._v(" "),a("td",[t._v("当前 "),a("code",[t._v("Load Commands")]),t._v(" 的大小，保证其可被正确解析")])])])]),t._v(" "),a("p",[t._v("根据不同的命令类型（"),a("code",[t._v("cmd")]),t._v("），内核会使用不同的函数进行解析。")]),t._v(" "),a("p",[t._v("下面对几个重要的命令类型进行详解。")]),t._v(" "),a("h4",{attrs:{id:"lc-segment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lc-segment"}},[t._v("#")]),t._v(" "),a("code",[t._v("LC_SEGMENT")])]),t._v(" "),a("p",[a("code",[t._v("LC_SEGMENT")]),t._v(" 和 "),a("code",[t._v("LC_SEGMENT_64")]),t._v(" 为段加载命令，每个段都定义了一个虚拟内存区域，动态链接器负责把这个区域映射到进程地址空间。其结构定义如下所示：")]),t._v(" "),a("div",{staticClass:"language-c extra-class"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("segment_command_64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* for 64-bit architectures */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\tcmd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* LC_SEGMENT_64 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\tcmdsize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* includes sizeof section_64 structs */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v("\tsegname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* segment name */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint64_t")]),t._v("\tvmaddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* memory address of this segment */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint64_t")]),t._v("\tvmsize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* memory size of this segment */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint64_t")]),t._v("\tfileoff"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* file offset of this segment */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint64_t")]),t._v("\tfilesize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* amount to map from the file */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("vm_prot_t")]),t._v("\tmaxprot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* maximum VM protection */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("vm_prot_t")]),t._v("\tinitprot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* initial VM protection */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\tnsects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* number of sections in segment */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\tflags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* flags */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("字段")]),t._v(" "),a("th",[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("cmd")])]),t._v(" "),a("td",[t._v("当前 "),a("code",[t._v("command")]),t._v(" 的类型")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("cmdsize")])]),t._v(" "),a("td",[t._v("当前 "),a("code",[t._v("command")]),t._v(" 的大小")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("segname")])]),t._v(" "),a("td",[t._v("段名称，占16个字节")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("vmaddr")])]),t._v(" "),a("td",[t._v("段的虚拟内存地址")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("vmsize")])]),t._v(" "),a("td",[t._v("段的虚拟内存大小")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("fileoff")])]),t._v(" "),a("td",[t._v("段在文件中的偏移量")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("filesize")])]),t._v(" "),a("td",[t._v("段在文件中的大小")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("maxprot")])]),t._v(" "),a("td",[t._v("段页面的最高内存保护级别")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("initprot")])]),t._v(" "),a("td",[t._v("段页面的初始内存保护级别")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("nsects")])]),t._v(" "),a("td",[t._v("段中包含节的数量。一个段可以包含0个或多个节")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("flags")])]),t._v(" "),a("td",[t._v("段的标志信息（"),a("code",[t._v("SG_HIGHVM")]),t._v("、"),a("code",[t._v("SG_FVMLIB")]),t._v("等）")])])])]),t._v(" "),a("p",[t._v("系统从 "),a("code",[t._v("fileoff")]),t._v(" 处加载大小为 "),a("code",[t._v("filesize")]),t._v(" 的内容到虚拟内存 "),a("code",[t._v("vmaddr")]),t._v(" 处，大小为 "),a("code",[t._v("vmsize")]),t._v(", 段页面的权限由 "),a("code",[t._v("initprot")]),t._v(" 进行初始化，权限可被修改，但不可超过 "),a("code",[t._v("maxprot")]),t._v(" 的值。")]),t._v(" "),a("p",[t._v("上图中的四个段作用如下：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("段")]),t._v(" "),a("th",[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("__PAGEZERO")])]),t._v(" "),a("td",[t._v("静态链接器创建了 "),a("code",[t._v("__PAGEZERO")]),t._v(" 作为可执行文件的第一个段，该段在虚拟内存中的位置和大小皆为 "),a("code",[t._v("0")]),t._v("，不能读写、不能执行，用来处理空指针。")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("__TEXT")])]),t._v(" "),a("td",[t._v("包含了可执行的代码和其他一些只读数据。静态链接器设置该段的虚拟内存权限为可读、可执行，进程被允许执行这些代码，但不能修改。")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("__DATA")])]),t._v(" "),a("td",[t._v("包含了将会被更改的数据。静态链接器设置该段的虚拟内存权限为可读写。")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("__LINKEDIT")])]),t._v(" "),a("td",[t._v("包含了动态链接库的原始数据，如符号、字符串和重定位表条目等。")])])])]),t._v(" "),a("p",[a("code",[t._v("64")]),t._v(" 位的节("),a("code",[t._v("section")]),t._v(")结构定义：")]),t._v(" "),a("div",{staticClass:"language-c extra-class"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("section_64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* for 64-bit architectures */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v("\tsectname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* name of this section */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v("\tsegname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* segment this section goes in */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint64_t")]),t._v("\taddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* memory address of this section */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint64_t")]),t._v("\tsize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* size in bytes of this section */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\toffset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* file offset of this section */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\talign"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* section alignment (power of 2) */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\treloff"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* file offset of relocation entries */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\tnreloc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* number of relocation entries */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\tflags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* flags (section type and attributes)*/")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\treserved1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* reserved (for offset or index) */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\treserved2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* reserved (for count or sizeof) */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\treserved3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* reserved */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("段")]),t._v(" "),a("th",[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("sectname")])]),t._v(" "),a("td",[t._v("节的名称，占 "),a("code",[t._v("16")]),t._v(" 个字节")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("segname")])]),t._v(" "),a("td",[t._v("节指导的段名称，占 "),a("code",[t._v("16")]),t._v(" 个字节")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("addr")])]),t._v(" "),a("td",[t._v("节在内存中的起始位置")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("size")])]),t._v(" "),a("td",[t._v("节占用的内存大小")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("offset")])]),t._v(" "),a("td",[t._v("节的文件偏移地址")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("align")])]),t._v(" "),a("td",[t._v("节的字节对齐大小")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("reloff")])]),t._v(" "),a("td",[t._v("重定位入口的文件偏移")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("nreloc")])]),t._v(" "),a("td",[t._v("需要重定位的入口数量")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("flags")])]),t._v(" "),a("td",[t._v("节的类型和属性")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("reserved1/2/3")])]),t._v(" "),a("td",[t._v("系统保留字段")])])])]),t._v(" "),a("h4",{attrs:{id:"lc-load-dylib"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#lc-load-dylib"}},[t._v("#")]),t._v(" "),a("code",[t._v("LC_LOAD_DYLIB")])]),t._v(" "),a("p",[a("code",[t._v("LC_LOAD_DYLIB")]),t._v(" 指向程序依赖库的加载信息，可以使用 "),a("code",[t._v("MachOView")]),t._v(" 进行查看")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261637245.png",alt:"LC_LOAD_DYLIB"}})]),t._v(" "),a("p",[a("code",[t._v("LC_LOAD_DYLIB")]),t._v(" 的结构定义为 "),a("code",[t._v("dylib_command")])]),t._v(" "),a("div",{staticClass:"language-c extra-class"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("dylib")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("union")]),t._v(" lc_str  name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* library's path name */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* library's build time stamp */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" current_version"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* library's current version number */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" compatibility_version"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* library's compatibility vers number*/")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("dylib_command")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\t\tcmd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* LC_ID_DYLIB, LC_LOAD_{,WEAK_}DYLIB, LC_REEXPORT_DYLIB */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("\t\tcmdsize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* includes pathname string */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("dylib")]),t._v("\tdylib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* the library identification */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("字段")]),t._v(" "),a("th",[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("name")])]),t._v(" "),a("td",[t._v("依赖库的完整路径。动态链接器会使用此路径进行动态库加载")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("timestamp")])]),t._v(" "),a("td",[t._v("依赖库构建时的时间戳")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("current_version")])]),t._v(" "),a("td",[t._v("当前版本号")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("compatibility_version")])]),t._v(" "),a("td",[t._v("兼容版本号")])])])]),t._v(" "),a("p",[a("code",[t._v("LC_LOAD_WEAK_DYLIB")]),t._v(" 的结构也是 "),a("code",[t._v("dylib_command")]),t._v("，不同的是其声明的依赖库是可选的，即缺少声明的依赖库不会影响主程序的运行，而 "),a("code",[t._v("LC_LOAD_DYLIB")]),t._v(" 声明的依赖库如果找不到，加载器会放弃并结束进程。")]),t._v(" "),a("p",[t._v("可以使用 "),a("code",[t._v("otool")]),t._v(" 来查看有哪些依赖库")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("otool -arch arm64 -L LXFProtocolTool_Example\n\nLXFProtocolTool_Example:\n    /System/Library/Frameworks/Accelerate.framework/Accelerate (compatibility version 1.0.0, current version 4.0.0)\n    @rpath/Alamofire.framework/Alamofire (compatibility version 1.0.0, current version 1.0.0)\n    /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)\n    /usr/lib/swift/libswiftCoreMIDI.dylib (compatibility version 1.0.0, current version 5.0.0, weak)\n    ...\n")])])]),a("p",[t._v("除了 "),a("code",[t._v("/System/Library/")]),t._v(" 和 "),a("code",[t._v("/usr/lib")]),t._v(" 这些系统路径外，还可能会遇到 "),a("code",[t._v("@rpath")]),t._v("、"),a("code",[t._v("@executable_path")]),t._v(" 之类的路径")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("路径")]),t._v(" "),a("th",[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("@executable_path")])]),t._v(" "),a("td",[t._v("指可执行文件的目录")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("@rpath")])]),t._v(" "),a("td",[t._v("由 "),a("code",[t._v("LC_RPATH")]),t._v(" 加载指定指定，"),a("code",[t._v("iOS")]),t._v(" 上通常为应用自身 "),a("code",[t._v("framework")]),t._v(" 文件，默认为："),a("code",[t._v("@executable_path/Framework")])])])])]),t._v(" "),a("p",[t._v("这些路径可使用 "),a("code",[t._v("MacOS")]),t._v(" 上提供的 "),a("code",[t._v("install_name_tool")]),t._v(" 工具进行修改，注意：此操作对于未越狱平台注入动态库是必须掌握的！")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改依赖库路径")]),t._v("\ninstall_name_tool "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-change")]),t._v(" @rpath/Alamofire.framework/Alamofire @executable_path/Alamofire.framework/Alamofire LXFProtocolTool_Example\n")])])]),a("h2",{attrs:{id:"通用二进制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通用二进制"}},[t._v("#")]),t._v(" 通用二进制")]),t._v(" "),a("p",[a("code",[t._v("Universal Binary")]),t._v("格式文件（通用二进制，也称胖二进制），实际上只是将不同架构的的 "),a("code",[t._v("Mach-O")]),t._v(" 文件打包到一起，再在文件起始位置处加上 "),a("code",[t._v("fat_header")]),t._v(" 结构来说明所支持的架构和偏移地址信息，其结构如下图所示：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202112261638987.png",alt:""}})]),t._v(" "),a("p",[t._v("头文件 "),a("code",[t._v("mach-o/fat.h")]),t._v(" 中可查看通用二进制文件的定义：")]),t._v(" "),a("div",{staticClass:"language-c extra-class"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("FAT_MAGIC")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xcafebabe")])])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("FAT_CIGAM")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xbebafeca")]),t._v(" ")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* NXSwapLong(FAT_MAGIC) */")])]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("fat_header")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" magic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* FAT_MAGIC or FAT_MAGIC_64 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" nfat_arch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* number of structs that follow */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("字段")]),t._v(" "),a("th",[t._v("作用")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("magic")])]),t._v(" "),a("td",[t._v("魔数（特征字段），其被定义常量 "),a("code",[t._v("FAT_MAGIC")]),t._v("，即固定取值为 "),a("code",[t._v("0xcafebabe")])])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("nfat_arch")])]),t._v(" "),a("td",[t._v("标识 "),a("code",[t._v("Mach-O")]),t._v(" 文件包含的架构个数")])])])]),t._v(" "),a("p",[a("code",[t._v("fat_header")]),t._v(" 后紧跟 "),a("code",[t._v("fat_arch")]),t._v(" 结构，有多少架构就会有多少 "),a("code",[t._v("fat_arch")]),t._v("，用于描述对应的 "),a("code",[t._v("Mach-O")]),t._v("文件的具体信息")]),t._v(" "),a("div",{staticClass:"language-c extra-class"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("fat_arch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("cpu_type_t")]),t._v("  cputype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* cpu specifier (int) */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("cpu_subtype_t")]),t._v("    cpusubtype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* machine specifier (int) */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("    offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* file offset to this object file */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("    size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* size of this object file */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v("    align"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* alignment as a power of 2 */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("字段")]),t._v(" "),a("th",[t._v("作用")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("offset")])]),t._v(" "),a("td",[t._v("指定对应架构相对于文件开头的偏移量")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("size")])]),t._v(" "),a("td",[t._v("指定对应架构数据的大小")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("align")])]),t._v(" "),a("td",[t._v("指定数据的内存对齐边界，取舍为 "),a("code",[t._v("2")]),t._v(" 的 "),a("code",[t._v("N")]),t._v(" 次方")])])])]),t._v(" "),a("p",[a("code",[t._v("cputype")]),t._v(" 和 "),a("code",[t._v("cpusubtype")]),t._v(" 在前面已经提及过，这里就不赘述了")]),t._v(" "),a("h2",{attrs:{id:"资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#资料"}},[t._v("#")]),t._v(" 资料")]),t._v(" "),a("ul",[a("li",[t._v("xnu源码\n"),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/apple/darwin-xnu/",target:"_blank",rel:"noopener noreferrer"}},[t._v("github"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://opensource.apple.com/tarballs/xnu/",target:"_blank",rel:"noopener noreferrer"}},[t._v("opensource.apple.com"),a("OutboundLink")],1)])])]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/aidansteele/osx-abi-macho-file-format-reference",target:"_blank",rel:"noopener noreferrer"}},[t._v("《OS X ABI Mach-O File Format Reference》"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=_.exports}}]);