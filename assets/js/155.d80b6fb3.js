(window.webpackJsonp=window.webpackJsonp||[]).push([[155],{564:function(t,s,a){"use strict";a.r(s);var e=a(21),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"一、前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、前言"}},[t._v("#")]),t._v(" 一、前言")]),t._v(" "),s("p",[t._v("在之前发布的【"),s("RouterLink",{attrs:{to:"/pages/489f24/"}},[t._v("Flutter - iOS编译加速")]),t._v("】一文中，我们提到升级至 "),s("code",[t._v("Xcode16")]),t._v(" 之后，"),s("code",[t._v("iOS")]),t._v(" 的编译速度慢到令人发指，随后探索发现是 "),s("code",[t._v("xcrun cc snapshot_assembly.S snapshot_assembly.o")]),t._v(" 这一汇编耗时变长了。而就在几天前，有人在相关的 "),s("code",[t._v("issue")]),t._v(" 中留言了他篡改使用 "),s("code",[t._v("Xcode 15")]),t._v(" 的 "),s("code",[t._v("cc")]),t._v(" 来提升编译速度的步骤，详情可见 "),s("a",{attrs:{href:"https://github.com/dart-lang/sdk/issues/43299#issuecomment-2769408562",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/dart-lang/sdk/issues/43299#issuecomment-2769408562"),s("OutboundLink")],1)],1),t._v(" "),s("p",[t._v("我在他的基础上做了优化与封装，只需两句命令即可还原编译速度，在开始详细介绍之前，先展示一下两台构建机优化前后的编译时长记录。")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("构建机")]),t._v(" "),s("th",[t._v("优化前(min)")]),t._v(" "),s("th",[t._v("Release + 二进制依赖(min)")]),t._v(" "),s("th",[t._v("Release + 二进制依赖 + 还原编译速度(min)")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[s("code",[t._v("i7")])]),t._v(" "),s("td",[t._v("25+")]),t._v(" "),s("td",[t._v("14+")]),t._v(" "),s("td",[t._v("11+")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("M4")])]),t._v(" "),s("td",[t._v("16+")]),t._v(" "),s("td",[t._v("8+")]),t._v(" "),s("td",[t._v("4+")])])])]),t._v(" "),s("p",[s("code",[t._v("M4")]),t._v(" 只要四分多钟，真香～")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202504052007534.jpg",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"二、调整"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、调整"}},[t._v("#")]),t._v(" 二、调整")]),t._v(" "),s("p",[t._v("以下是他提供的修改步骤")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-r")]),t._v(" /Applications/Xcode-15.4.0.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain ~/Library/Developer/Toolchains\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" ~/Library/Developer/Toolchains\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" XcodeDefault.xctoolchain Xcode15.4.xctoolchain\n/usr/libexec/PlistBuddy "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Add CompatibilityVersion integer 2"')]),t._v(" Xcode15.4.xctoolchain/ToolchainInfo.plist\n/usr/libexec/PlistBuddy "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Set Identifier clang.Xcode15.4"')]),t._v(" Xcode15.4.xctoolchain/ToolchainInfo.plist\n")])])]),s("ol",[s("li",[t._v("将 "),s("code",[t._v("Xcode 15.4")]),t._v(" 内部的默认工具链复制到 "),s("code",[t._v("~/Library/Developer/Toolchains")]),t._v(" 目录。")]),t._v(" "),s("li",[t._v("将当前工作目录切换到 "),s("code",[t._v("~/Library/Developer/Toolchains")]),t._v(" 目录。")]),t._v(" "),s("li",[t._v("将复制过来的 "),s("code",[t._v("XcodeDefault.xctoolchain")]),t._v(" 重命名为 "),s("code",[t._v("Xcode15.4.xctoolchain")]),t._v("，方便区分。")]),t._v(" "),s("li",[t._v("修改 "),s("code",[t._v(".xctoolchain/ToolchainInfo.plist")]),t._v(" 文件，添加 "),s("code",[t._v("CompatibilityVersion")]),t._v("，并将其值设置为整数类型 "),s("code",[t._v("2")]),t._v("，修改 "),s("code",[t._v("Identifier")]),t._v(" 的值为 "),s("code",[t._v("clang.Xcode15.4")]),t._v("。")])]),t._v(" "),s("div",{staticClass:"language-diff extra-class"},[s("pre",{pre:!0,attrs:{class:"language-diff"}},[s("code",[s("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[s("span",{pre:!0,attrs:{class:"token prefix deleted"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v(" Future<RunResult> cc(List<String> args) => _run('cc', args);\n")])]),s("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[s("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v(" Future<RunResult> cc(List<String> args) => _run('--toolchain', <String>[\n")]),s("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v("   'clang.Xcode15.4',\n")]),s("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v("   'cc',\n")]),s("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v("   ...args,\n")]),s("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v(" ]);\n")])])])])]),s("p",[t._v("修改 "),s("code",[t._v("flutter_tools")]),t._v(" 源码，将 "),s("code",[t._v("cc")]),t._v(" 修改为 "),s("code",[t._v("--toolchain")]),t._v(" 来使用 "),s("code",[t._v("clang.Xcode15.4")]),t._v(" 下的 "),s("code",[t._v("cc")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"三、详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、详解"}},[t._v("#")]),t._v(" 三、详解")]),t._v(" "),s("p",[t._v("默认的工具链路径是 "),s("code",[t._v("Xcode")]),t._v(" 中的 "),s("code",[t._v("/Applications/Xcode.app/Contents/Developer/Toolchains")]),t._v("，不过也可以将工具链放到 "),s("code",[t._v("~/Library/Developer/Toolchains")]),t._v(" 目录下，这样就可以在不修改 "),s("code",[t._v("Xcode")]),t._v(" 应用本身的情况下，使用和管理不同的工具链版本。")]),t._v(" "),s("p",[t._v("接着是修改 "),s("code",[t._v(".xctoolchain/ToolchainInfo.plist")]),t._v(" 文件，里面可以设置的一些字段如下：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("字段")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("CFBundleIdentifier")]),t._v(" "),s("td",[t._v("唯一标识")])]),t._v(" "),s("tr",[s("td",[t._v("CompatibilityVersion")]),t._v(" "),s("td",[t._v("适配版本，适配 "),s("code",[t._v("Xcode")]),t._v(" 时必为 "),s("code",[t._v("2")])])]),t._v(" "),s("tr",[s("td",[t._v("DisplayName")]),t._v(" "),s("td",[t._v("【可选】显示名称")])]),t._v(" "),s("tr",[s("td",[t._v("ShortDisplayName")]),t._v(" "),s("td",[t._v("【可选】简短的显示名称")])])])]),t._v(" "),s("blockquote",[s("p",[t._v("注：在 "),s("code",[t._v("DisplayName")]),t._v(" 和 "),s("code",[t._v("ShortDisplayName")]),t._v(" 都不设置时，名字会显示为 "),s("code",[t._v("CFBundleIdentifier")])])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202504051821348.png",alt:""}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202504051822505.png",alt:""}})]),t._v(" "),s("p",[t._v("关于 "),s("code",[t._v("CompatibilityVersion")]),t._v(" 的说明，在网上基本是搜不到的，只有如下这个注释，"),s("code",[t._v("Xcode 8")]),t._v(" 及以上，使用 "),s("code",[t._v("2")]),t._v("，否则使用 "),s("code",[t._v("1")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# Xcode 8 requires CompatibilityVersion 2\nset(COMPAT_VERSION 2)\nif(XCODE_VERSION VERSION_LESS 8.0.0)\n  # Xcode 7.3 (the first version supporting external toolchains) requires\n  # CompatibilityVersion 1\n  set(COMPAT_VERSION 1)\nendif()\n")])])]),s("p",[t._v("摘自: "),s("a",{attrs:{href:"https://github.com/llvm/llvm-project/blob/main/llvm/tools/xcode-toolchain/CMakeLists.txt",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/llvm/llvm-project/blob/main/llvm/tools/xcode-toolchain/CMakeLists.txt"),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"四、改进"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、改进"}},[t._v("#")]),t._v(" 四、改进")]),t._v(" "),s("p",[t._v("直接修改 "),s("code",[t._v("flutter_tools")]),t._v(" 源码并写死 "),s("code",[t._v("clang.Xcode15.4")]),t._v(" 太过于粗暴，如果我们为了安全起见，只想打测试包的时候还原编译速度，而打上架包保持原样就不好调整了，所以这里我对他的修改进行了优化。")]),t._v(" "),s("p",[t._v("首先来介绍一下 "),s("code",[t._v("TOOLCHAINS")]),t._v(" 这个环境变量，它可以影响 "),s("code",[t._v("/usr/bin/")]),t._v(" 下的命令调用，如 "),s("code",[t._v("/usr/bin/xcrun")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202504051822168.png",alt:""}})]),t._v(" "),s("blockquote",[s("p",[t._v("注："),s("code",[t._v("Developer Directory")]),t._v(" 指 "),s("code",[t._v("/Applications/Xcode.app/Contents/Developer")]),t._v(" 或者 "),s("code",[t._v("/Library/Developer/CommandLineTools")]),t._v("，可以通过 "),s("code",[t._v("xcode-select --print-path")]),t._v(" 进行检查")])]),t._v(" "),s("p",[t._v("如果我们没有设置 "),s("code",[t._v("TOOLCHAINS")]),t._v("，根据上述流程图，在调用 "),s("code",[t._v("/usr/bin/xcrun")]),t._v(" 时，会根据 "),s("code",[t._v("Developer Directory")]),t._v(" 搜索该命令，如果找到同名命令，则执行该命令。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("xcrun "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--find")]),t._v(" cc\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# /Applications/Xcode-16.2.0.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/cc")]),t._v("\n")])])]),s("p",[t._v("如果我们将 "),s("code",[t._v("TOOLCHAINS")]),t._v(" 设置为 "),s("code",[t._v(".xctoolchain")]),t._v(" 的 "),s("code",[t._v("Identifier")]),t._v("，如: "),s("code",[t._v("clang.Xcode15.4")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("TOOLCHAINS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("clang.Xcode15.4\n")])])]),s("p",[t._v("那么根据上述流程图，则是在 "),s("code",[t._v("Xcode15.4.xctoolchain")]),t._v(" 中找到 "),s("code",[t._v("cc")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("xcrun "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--find")]),t._v(" cc\n/Users/lxf/Library/Developer/Toolchains/Xcode15.4.xctoolchain/usr/bin/cc\n")])])]),s("p",[t._v("根据这一特性，我做了如下调整：")]),t._v(" "),s("p",[t._v("调整 "),s("code",[t._v("cc")]),t._v(" 方法，当有配置 "),s("code",[t._v("CONDOR_TOOLCHAINS")]),t._v(" 环境变量时，将值取出并赋值给 "),s("code",[t._v("TOOLCHAINS")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-dart extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dart"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   Future<RunResult> cc(List<String> args) => _run('cc', args);")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Future")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RunResult")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" condorToolchains "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" platform"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("environment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CONDOR_TOOLCHAINS'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Map")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" environment "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("condorToolchains"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isNotEmpty"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"TOOLCHAINS"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" condorToolchains"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("_run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--find'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cc'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" environment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" environment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RunResult")]),t._v(" result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printStatus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\n[condor] find cc: ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token expression"}},[t._v("result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stdout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\\n'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("_run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cc'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" environment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" environment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("code",[t._v("_run")]),t._v(" 方法新增 "),s("code",[t._v("environment")]),t._v(" 参数，用于设置环境变量。")]),t._v(" "),s("div",{staticClass:"language-dart extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dart"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   Future<RunResult> _run(String command, List<String> args) {")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     return _processUtils.run(")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//       <String>[...xcrunCommand(), command, ...args],")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//       throwOnError: true,")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     );")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   }")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Future")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RunResult")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("_run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" command"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Map")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" environment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" _processUtils"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("xcrunCommand")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" command"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      throwOnError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      environment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" environment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),s("h2",{attrs:{id:"五、condor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#五、condor"}},[t._v("#")]),t._v(" 五、Condor")]),t._v(" "),s("p",[t._v("上述步骤还是比较繁琐的，所以这里我将其进行了封装，只需要执行两句命令即可。")]),t._v(" "),s("h3",{attrs:{id:"_1、安装与更新-condor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1、安装与更新-condor"}},[t._v("#")]),t._v(" 1、安装与更新 condor")]),t._v(" "),s("h4",{attrs:{id:"homebrew"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#homebrew"}},[t._v("#")]),t._v(" Homebrew")]),t._v(" "),s("p",[t._v("如果你是首次安装，则执行如下命令")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("brew tap LinXunFeng/tap "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" brew "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" condor\n")])])]),s("p",[t._v("如果不是首次安装，则需要执行如下命令进行更新")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("brew update "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" brew reinstall condor\n")])])]),s("h4",{attrs:{id:"pub-global"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pub-global"}},[t._v("#")]),t._v(" Pub Global")]),t._v(" "),s("p",[t._v("如果你习惯使用 "),s("code",[t._v("Pub")]),t._v("，或者你的电脑是 "),s("code",[t._v("Intel")]),t._v(" 芯，则可以执行如下命令进行安装或更新")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("dart pub global activate condor_cli\n")])])]),s("h3",{attrs:{id:"_2、拷贝-xctoolchain"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2、拷贝-xctoolchain"}},[t._v("#")]),t._v(" 2、拷贝 xctoolchain")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("condor optimize-build xctoolchain-copy "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--xcode")]),t._v(" Xcode-15.4.0\n")])])]),s("p",[s("code",[t._v("--xcode")]),t._v(" 参数请使用 "),s("code",[t._v("Xcode 15")]),t._v(" 在 "),s("code",[t._v("/Applications/")]),t._v(" 下的名字，如果你电脑上没有 "),s("code",[t._v("Xcode 15")]),t._v("，建议使用 https://github.com/XcodesOrg/XcodesApp 进行安装。")]),t._v(" "),s("p",[t._v("这一步会做如下几个操作")]),t._v(" "),s("ol",[s("li",[t._v("将 "),s("code",[t._v("/Applications/Xcode-15.4.0.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain")]),t._v(" 拷贝至 "),s("code",[t._v("~/Library/Developer/Toolchains/Xcode-15.4.0.xctoolchain")]),t._v("。")]),t._v(" "),s("li",[t._v("将 "),s("code",[t._v("Xcode-15.4.0.xctoolchain/ToolchainInfo.plist")]),t._v(" 中的 "),s("code",[t._v("Identifier")]),t._v(" 设置为 "),s("code",[t._v("Xcode-15.4.0")]),t._v("。")]),t._v(" "),s("li",[t._v("添加 "),s("code",[t._v("CompatibilityVersion")]),t._v(" 并设置为 "),s("code",[t._v("2")]),t._v("。")])]),t._v(" "),s("h3",{attrs:{id:"_3、cc-重写向"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3、cc-重写向"}},[t._v("#")]),t._v(" 3、cc 重写向")]),t._v(" "),s("p",[t._v("该命令会对 "),s("code",[t._v("flutter_tools")]),t._v(" 源码进行修改，使其具备重定向 "),s("code",[t._v("cc")]),t._v(" 的能力而已，在有配置 "),s("code",[t._v("CONDOR_TOOLCHAINS")]),t._v(" 环境变量时才会生效，否则则使用默认的 "),s("code",[t._v("cc")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用默认 flutter，则不需要传 flutter 参数")]),t._v("\ncondor optimize-build redirect-cc\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果你想指定 fvm 下的指定 Flutter 版本")]),t._v("\ncondor optimize-build redirect-cc "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--flutter")]),t._v(" fvm spawn "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.24")]),t._v(".5\n")])])]),s("h3",{attrs:{id:"_4、应用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4、应用"}},[t._v("#")]),t._v(" 4、应用")]),t._v(" "),s("p",[t._v("后续你只需要 "),s("code",[t._v("export CONDOR_TOOLCHAINS=Xcode-15.4.0")]),t._v(" 就可以在 "),s("code",[t._v("Xcode 16")]),t._v(" 上感受到 "),s("code",[t._v("Xcode 15")]),t._v(" 的编译速度了 🥳")]),t._v(" "),s("p",[t._v("如打包前 "),s("code",[t._v("export")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CONDOR_TOOLCHAINS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Xcode-15.4.0\nflutter clean\nflutter build ipa\n")])])]),s("p",[t._v("如果你想验证，可以加上 "),s("code",[t._v("--verbose")]),t._v("，并将输出保存到 "),s("code",[t._v("result.txt")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("flutter build ipa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--verbose")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" result.txt\n")])])]),s("p",[t._v("命令执行完毕后打开 "),s("code",[t._v("result.txt")]),t._v("，搜索 "),s("code",[t._v("condor")]),t._v(" 即可。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202504062017440.png",alt:""}})]),t._v(" "),s("p",[t._v("或者如果你不需要按需配置，也可以直接在 "),s("code",[t._v("Run Script")]),t._v(" 里设置 "),s("code",[t._v("CONDOR_TOOLCHAINS")]),t._v(" 环境变量。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202504062018216.png",alt:""}})]),t._v(" "),s("p",[t._v("验证也很简单，如下图所示，选择当前的 "),s("code",[t._v("Build")]),t._v(" 任务，搜索 "),s("code",[t._v("condor")]),t._v(" 即可。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202504062018365.png",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"六、是否有影响"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#六、是否有影响"}},[t._v("#")]),t._v(" 六、是否有影响")]),t._v(" "),s("p",[t._v("在 "),s("code",[t._v("Xcode")]),t._v(" 的工具链中，"),s("code",[t._v("cc")]),t._v(" 是 "),s("code",[t._v("clang")]),t._v(" 的替身")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202504051822973.png",alt:""}})]),t._v(" "),s("p",[t._v("而不同版本的 "),s("code",[t._v("clang")]),t._v(" 对同一份 "),s("code",[t._v(".S")]),t._v(" 进行汇编，还是有可能生成内容不一样的 "),s("code",[t._v(".o")]),t._v(" 的。不过我自己对比 "),s("code",[t._v("Xcode 16")]),t._v(" 和 "),s("code",[t._v("Xcode 15")]),t._v(" 生成的 "),s("code",[t._v(".o")]),t._v(" 并没有什么不同。")]),t._v(" "),s("p",[t._v("对比 "),s("code",[t._v(".o")]),t._v(" 文件，我们可以使用系统自带的 "),s("code",[t._v("cmp")]),t._v(" 命令，"),s("code",[t._v("cmp")]),t._v(" 是一个用于比较文件的命令行工具，它可以逐字节比较二进制文件。如下所示")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cmp")]),t._v(" /Users/lxf/cc15/snapshot_assembly.o /Users/lxf/cc16/snapshot_assembly.o\n")])])]),s("p",[s("code",[t._v("cmp")]),t._v(" 命令执行完成，退出代码为 "),s("code",[t._v("0")]),t._v("，并且没有输出。这表明 "),s("code",[t._v("cmp")]),t._v(" 命令没有发现两个文件之间有任何不同之处。因此可以证明这两个 "),s("code",[t._v(".o")]),t._v(" 文件的内容是相同的。")]),t._v(" "),s("p",[t._v("即，基于 "),s("code",[t._v("Xcode 16")]),t._v(" 来说并没有影响，这种方式生成的 "),s("code",[t._v(".o")]),t._v(" 可以用于上架包，如果还是不放心，可以在打上架包时，不设置 "),s("code",[t._v("CONDOR_TOOLCHAINS")]),t._v(" 环境变量即可。")]),t._v(" "),s("h2",{attrs:{id:"七、资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#七、资料"}},[t._v("#")]),t._v(" 七、资料")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://lvv.me/posts/2018/12/20_xcode_toolchain/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Change toolchain for Xcode"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://kanchuan.com/blog/153-xcode-toolchain",target:"_blank",rel:"noopener noreferrer"}},[t._v("Using a Custom Toolchain in Xcode"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/kateinoigakukun/zenn-contents/blob/master/articles/how-toolchain-works-macos.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("how-toolchain-works-macos"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/cntrump/extract-xcode-toolchain",target:"_blank",rel:"noopener noreferrer"}},[t._v("extract-xcode-toolchain"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);