(window.webpackJsonp=window.webpackJsonp||[]).push([[139],{484:function(t,e,s){"use strict";s.r(e);var a=s(15),r=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h2",{attrs:{id:"一、概述"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、概述"}},[t._v("#")]),t._v(" 一、概述")]),t._v(" "),e("p",[t._v("关于 "),e("code",[t._v("Shorebird")]),t._v(" 的初始化内容可以在上一篇《"),e("a",{attrs:{href:"/pages/a0e176"}},[t._v("Flutter - 混编项目集成Shorebird热更新🐦（安卓篇）")]),t._v("》中查看，这里就不再赘述了。")]),t._v(" "),e("p",[e("code",[t._v("Shorebird")]),t._v(" 官方文档上对于 "),e("code",[t._v("iOS")]),t._v(" 混编方案集成热更新的介绍不算详细，只能说点明了要点，指明了方向。")]),t._v(" "),e("p",[t._v("本文将根据实际的项目应用情况做出集成调整，并补充说明正确的补丁验证方案。")]),t._v(" "),e("h2",{attrs:{id:"二、踩坑"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、踩坑"}},[t._v("#")]),t._v(" 二、踩坑")]),t._v(" "),e("p",[e("code",[t._v("Shorebird")]),t._v(" 文档里指出需要我们使用类似 "),e("code",[t._v("Flutter")]),t._v(" 官方文档里 "),e("code",[t._v("Option B - Embed frameworks in Xcode")]),t._v(" 的方式去集成 "),e("code",[t._v("Flutter")]),t._v(" 模块。")]),t._v(" "),e("blockquote",[e("p",[t._v("关于 "),e("code",[t._v("Flutter")]),t._v(" 官方文档指出的各种集成方式可以查看: "),e("a",{attrs:{href:"https://docs.flutter.dev/add-to-app/ios/project-setup",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.flutter.dev/add-to-app/ios/project-setup"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("具体的步骤就是：")]),t._v(" "),e("ol",[e("li",[t._v("先注释掉原来的 "),e("code",[t._v("Option A")]),t._v(" 集成方式的相关配置代码")]),t._v(" "),e("li",[t._v("执行 "),e("code",[t._v("Shorebird Release")]),t._v(" 去构建对应的所有 "),e("code",[t._v("xcframework")]),t._v(" 文件。（"),e("code",[t._v("xcframework")]),t._v(" 文件包括了 "),e("code",[t._v("Flutter.xcframework")]),t._v(" 和 "),e("code",[t._v("App.xcframework")]),t._v("，以及插件依赖的原生第三方库对应的 "),e("code",[t._v("xcframework")]),t._v("）")]),t._v(" "),e("li",[t._v("将所有构建完成的 "),e("code",[t._v("xcframework")]),t._v(" 拖到 "),e("code",[t._v("Build Phases")]),t._v(" 中的 "),e("code",[t._v("Embed Frameworks")]),t._v(" 内。")]),t._v(" "),e("li",[t._v("将 "),e("code",[t._v("xcframework")]),t._v(" 的所在目录路径配置到 "),e("code",[t._v("Framework Search Paths")]),t._v("。")]),t._v(" "),e("li",[t._v("配置 "),e("code",[t._v("xcframework")]),t._v(" 的 "),e("code",[t._v("Embed")]),t._v(" 模式，静态库必须选 "),e("code",[t._v("Do Not Embed")]),t._v("，动态库必须选 "),e("code",[t._v("Embed & Sign")]),t._v("。")])]),t._v(" "),e("p",[t._v("因为 "),e("code",[t._v("Option A - Embed with CocoaPods and the Flutter SDK")]),t._v(" 的方式只需要简单的配置 "),e("code",[t._v("Podfile")]),t._v(" 就可以集成 "),e("code",[t._v("Flutter")]),t._v(" 模块，所以相信大家在一般情况下都是会选择 "),e("code",[t._v("Option A")]),t._v(" 的方式。很明显，要改成 "),e("code",[t._v("Option B")]),t._v(" 需要我们大改特改。")]),t._v(" "),e("p",[t._v("改成 "),e("code",[t._v("Option B")]),t._v(" 这种方式有以下几点问题：")]),t._v(" "),e("h3",{attrs:{id:"_1、vendored-frameworks-缺失"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1、vendored-frameworks-缺失"}},[t._v("#")]),t._v(" 1、"),e("code",[t._v("vendored_frameworks")]),t._v(" 缺失")]),t._v(" "),e("p",[t._v("如果你依赖的 "),e("code",[t._v("Flutter")]),t._v(" 插件依赖了原生第三方的二进制包，如 "),e("code",[t._v("realm")]),t._v("，在它的 "),e("code",[t._v("podspec")]),t._v(" 文件是这样声明的 "),e("code",[t._v("s.vendored_frameworks = 'realm_dart.xcframework'")]),t._v("，那你会发现在最终构建完成的 "),e("code",[t._v("xcframework")]),t._v(" 的目录里会缺少这些 "),e("code",[t._v("vendored_frameworks")]),t._v("。")]),t._v(" "),e("p",[t._v("相关的 "),e("code",[t._v("issue")]),t._v(": "),e("a",{attrs:{href:"https://github.com/flutter/flutter/issues/125530",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/flutter/flutter/issues/125530"),e("OutboundLink")],1),t._v("。")]),t._v(" "),e("p",[t._v("因为 "),e("code",[t._v("Option B")]),t._v(" 是二进制依赖，所以在编译的时候并不会报任何错误，等你 "),e("code",[t._v("App")]),t._v(" 运行起来进入一些相关场景，使用到了对应的第三方功能时就会直接来个找不到符号的错误，如：")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("Failed to lookup symbol "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'native_method_signature'")]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" dlsym"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0xa47e7c10, native_method_signature"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": symbol not found\n")])])]),e("p",[t._v("接着就是闪退，可想而知这得多吓人！")]),t._v(" "),e("h3",{attrs:{id:"_2、重复编译"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2、重复编译"}},[t._v("#")]),t._v(" 2、重复编译")]),t._v(" "),e("p",[e("code",[t._v("vendored_frameworks")]),t._v(" 缺失的问题我通过脚本解决了，但是还有另一个问题，这些 "),e("code",[t._v("xcframework")]),t._v(" 中也有可能出现涵盖你原来的原生工程里依赖的第三方包，比如，"),e("code",[t._v("Flutter")]),t._v(" 的插件用到了 "),e("code",[t._v("FMDB")]),t._v("，生成的 "),e("code",[t._v("xcframework")]),t._v(" 中就会包含 "),e("code",[t._v("FMDB.xcframework")]),t._v("，而你的原生工程本来就有依赖 "),e("code",[t._v("FMDB")]),t._v("，这个时候编译，"),e("code",[t._v("Xcode")]),t._v(" 就会告诉你重复了，编译不通过，报错内容如下：")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("Showing Recent Messages\nMultiple commands produce "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/Users/lxf/Library/Developer/Xcode/DerivedData/xxx.app/Frameworks/FMDB.framework'")]),t._v("\n")])])]),e("p",[t._v("如果是你，你选择留下哪个呢？")]),t._v(" "),e("ul",[e("li",[t._v("如果你选择了 "),e("code",[t._v("Flutter")]),t._v(" 帮你生成的 "),e("code",[t._v("FMDB.xcframework")]),t._v("，你就得去处理其它原生第三方依赖的 "),e("code",[t._v("pod 'FMDB'")]),t._v("，假如此时原生工程里的一些第三方库或私有库也依赖 "),e("code",[t._v("FMDB")]),t._v("，那你要处理这些库可就太麻烦了。")]),t._v(" "),e("li",[t._v("如果你选择使用 "),e("code",[t._v("pod 'FMDB'")]),t._v(" 的方式，那你只需要去判断原生工程里是否有对应的依赖，有的话就不再声明依赖，这种还好。")])]),t._v(" "),e("h3",{attrs:{id:"_3、静态库与动态库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3、静态库与动态库"}},[t._v("#")]),t._v(" 3、静态库与动态库")]),t._v(" "),e("p",[t._v("生成的 "),e("code",[t._v("xcframework")]),t._v(" 中，有些是静态库，有些是动态库")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202401211435264.png",alt:""}})]),t._v(" "),e("p",[t._v("如图所示，静态库必须选 "),e("code",[t._v("Do Not Embed")]),t._v("，动态库必须选 "),e("code",[t._v("Embed & Sign")]),t._v("。")]),t._v(" "),e("p",[t._v("如果你全选了 "),e("code",[t._v("Embed & Sign")]),t._v("，那么你就无法启动 "),e("code",[t._v("App")]),t._v(" 了，如下图所示")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202401211436641.png",alt:""}})]),t._v(" "),e("p",[t._v("该问题的相关 "),e("code",[t._v("issue")]),t._v(": https://github.com/flutter/flutter/issues/122183")]),t._v(" "),e("p",[t._v("所以为了避免这种情况，我们就必须得选对 "),e("code",[t._v("Embed")]),t._v(" 选项，可以使用 "),e("code",[t._v("file")]),t._v(" 命令去判断 "),e("code",[t._v("xcframework")]),t._v(" 是静态库还是动态库")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" FlutterPluginRegistrant.xcframework/ios-arm64/FlutterPluginRegistrant.framework/FlutterPluginRegistrant\nFlutterPluginRegistrant.xcframework/ios-arm64/FlutterPluginRegistrant.framework/FlutterPluginRegistrant: \ncurrent ar archive random library // 静态库\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" url_launcher_ios.xcframework/ios-arm64/url_launcher_ios.framework/url_launcher_ios\nurl_launcher_ios.xcframework/ios-arm64/url_launcher_ios.framework/url_launcher_ios: \nMach-O "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("-bit dynamically linked shared library arm64 // 动态库\n")])])]),e("p",[t._v("这部分判断逻辑只能交给脚本处理了，因为当数量起来后你就会体验到什么叫崩溃，别问我是怎么知道的 😭")]),t._v(" "),e("h3",{attrs:{id:"_4、直接崩溃"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4、直接崩溃"}},[t._v("#")]),t._v(" 4、直接崩溃")]),t._v(" "),e("p",[t._v("后面我直接用脚本判断 "),e("code",[t._v("Flutter")]),t._v(" 插件依赖了哪些原生第三方，将它们统一在原生工程内声明依赖，在一些情况下这也是很危险的，如 "),e("code",[t._v("connectivity_plus")]),t._v(" 这个 "),e("code",[t._v("Flutter")]),t._v(" 插件依赖了 "),e("code",[t._v("ReachabilitySwift")]),t._v("，你必须得使用 "),e("code",[t._v("Reachability.xcframework")]),t._v(" 二进制嵌入的方式，否则运行就崩~")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("dyld"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("31764")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": Symbol not found: _"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$s12ReachabilityAAC10ConnectionO4wifiyA2DmFWC")]),t._v("\n  Referenced from: "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("8142F86E-4C9C-3513-AD29-D3522FC6677F"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /Users/lxf/Library/Developer/Xcode/DerivedData/xxx/connectivity_plus.framework/connectivity_plus\n  Expected in:     "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("DA318000-9A97-35AD-87EA-7C5B635DE01"),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v(" /Users/lxf/Library/Developer/xxx.app/Frameworks/Reachability.framework/Reachability\n")])])]),e("h2",{attrs:{id:"三、分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三、分析"}},[t._v("#")]),t._v(" 三、分析")]),t._v(" "),e("p",[t._v("后来仔细想想，"),e("code",[t._v("Shorebird")]),t._v(" 的热更新是针对 "),e("code",[t._v("Dart")]),t._v(" 代码，跟原生无关，能不能按原来的 "),e("code",[t._v("Cocoapods")]),t._v(" 方式去集成 "),e("code",[t._v("Flutter.xcframework")]),t._v("，"),e("code",[t._v("App.xcframework")]),t._v(" 以及插件依赖的原生第三方库呢？")]),t._v(" "),e("p",[t._v("答案是可以的，来看看 "),e("code",[t._v("install_all_flutter_pods")]),t._v(" 方法")]),t._v(" "),e("div",{staticClass:"language-ruby extra-class"},[e("pre",{pre:!0,attrs:{class:"language-ruby"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token method-definition"}},[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install_all_flutter_pods")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flutter_application_path "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nil")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  flutter_application_path "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("File")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("join"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'..'")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'..'")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 生成 .ios/Flutter/Flutter.podspec")]),t._v("\n  install_flutter_engine_pod"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flutter_application_path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 集成 插件依赖的原生库 Pods")]),t._v("\n  install_flutter_plugin_pods"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flutter_application_path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 编译并集成 Flutter.xcframework 和 App.xcframework")]),t._v("\n  install_flutter_application_pod"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flutter_application_path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),e("h3",{attrs:{id:"_1、install-flutter-engine-pod"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1、install-flutter-engine-pod"}},[t._v("#")]),t._v(" 1、install_flutter_engine_pod")]),t._v(" "),e("p",[e("code",[t._v("install_flutter_engine_pod")]),t._v(" 生成的 "),e("code",[t._v("Flutter.podspec")]),t._v(" 是假的"),e("code",[t._v("podspec")]),t._v("，里面没啥实质内容，仅代表 "),e("code",[t._v("Flutter.xcframework")]),t._v("，为什么要这么做呢？因为一些 "),e("code",[t._v("Flutter")]),t._v(" 插件声明需要依赖 "),e("code",[t._v("Flutter")]),t._v("，如：")]),t._v(" "),e("div",{staticClass:"language-ruby extra-class"},[e("pre",{pre:!0,attrs:{class:"language-ruby"}},[e("code",[t._v("Pod"),e("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[t._v("::")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("s"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n  s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name             "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sqflite'")])]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dependency "),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Flutter'")])]),t._v("\n  s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dependency "),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'FMDB'")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'>= 2.7.5'")])]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),e("p",[t._v("如果没有这个 "),e("code",[t._v("Flutter.podspec")]),t._v("，那么执行 "),e("code",[t._v("pod install")]),t._v(" 就会从 "),e("code",[t._v("CocoaPods trunk")]),t._v(" 下载 "),e("code",[t._v("Flutter")]),t._v(" 了。")]),t._v(" "),e("h3",{attrs:{id:"_2、install-flutter-application-pod"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2、install-flutter-application-pod"}},[t._v("#")]),t._v(" 2、install_flutter_application_pod")]),t._v(" "),e("p",[e("code",[t._v("install_flutter_application_pod")]),t._v(" 会去编译 "),e("code",[t._v("Flutter.xcframework")]),t._v(" 和 "),e("code",[t._v("App.xcframework")]),t._v("，并将它们并集到我们的原生工程内。不过这两玩意我们用 "),e("code",[t._v("Shorebird Release")]),t._v(" 去生成了，所以这个方法我们用不上。")]),t._v(" "),e("p",[t._v("我们可以结合上述的 "),e("code",[t._v("Flutter.podspec")]),t._v(" 的作用，修改它内部的依赖声明，从而实现通过 "),e("code",[t._v("Cocoapods")]),t._v(" 的方式来集成 "),e("code",[t._v("Flutter.xcframework")]),t._v(" 和 "),e("code",[t._v("App.xcframework")]),t._v("。")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("Pod::Spec.new do |s|\ns.name             = 'Flutter'\ns.version          = '1.0.0'\ns.summary          = 'A UI toolkit for beautiful and fast apps.'\ns.homepage         = 'https://flutter.dev'\ns.license          = { :type => 'BSD' }\ns.author           = { 'Flutter Dev Team' => 'flutter-dev@googlegroups.com' }\ns.source           = { :git => 'https://github.com/flutter/engine', :tag => s.version.to_s }\ns.ios.deployment_target = '11.0'\n# Framework linking is handled by Flutter tooling, not CocoaPods.\n# Add a placeholder to satisfy `s.dependency 'Flutter'` plugin podspecs.\n#\n# 以上到这句都是原来的，将这句注释掉\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v(" # s.vendored_frameworks = 'path/to/nothing'\n")])]),t._v("# 新增下面这句，声明依赖当前目录下的 Flutter.xcframework 和 App.xcframework\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v(" s.vendored_frameworks = 'Flutter.xcframework', 'App.xcframework'\n")])]),t._v("end\n")])])]),e("p",[t._v("生成的所有 "),e("code",[t._v("xcframework")]),t._v(" 所在路径为: "),e("code",[t._v("xxx/flutter_module/build/ios/framework/Release")]),t._v("， 我们自己创建的 "),e("code",[t._v("Flutter.podspec")]),t._v(" 中的依赖是相对路径，所以该 "),e("code",[t._v("podspec")]),t._v(" 也是跟 "),e("code",[t._v("xcframework")]),t._v(" 放到一起，当然也可以根据你自己的习惯进行调整。")]),t._v(" "),e("h3",{attrs:{id:"_3、install-flutter-plugin-pods"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3、install-flutter-plugin-pods"}},[t._v("#")]),t._v(" 3、install_flutter_plugin_pods")]),t._v(" "),e("p",[e("code",[t._v("install_flutter_plugin_pods")]),t._v(" 会将 "),e("code",[t._v("Flutter")]),t._v(" 插件依赖的原生库集成到我们的原生工程，这正是我们需要的。")]),t._v(" "),e("p",[t._v("不过如果你直接将 "),e("code",[t._v("Podfile")]),t._v(" 中的 "),e("code",[t._v("install_flutter_application_pod")]),t._v(" 给替换成 "),e("code",[t._v("install_flutter_plugin_pods")]),t._v(" ，执行 "),e("code",[t._v("pod install")]),t._v(" 时是会报如下错误的：")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("pod "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Invalid "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),t._v("Podfile"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v(" file: undefined method `flutter_relative_path_from_podfile' "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#<Pod::Podfile:0x000000010e74c520 @defined_in_file=#<Pathname:/Users/lxf/xxx/Podfile>, @internal_hash={}, @root_target_definitions=[#<Pod::Podfile::TargetDefinition label=Pods>], @current_target_definition=#<Pod::Podfile::TargetDefinition label=Pods>>")]),t._v("\n\n  relative "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" flutter_relative_path_from_podfile"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("export_script_directory"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("p",[t._v("也就是找不到 "),e("code",[t._v("flutter_relative_path_from_podfile")]),t._v(" 方法，因为该方法在并不在你的 "),e("code",[t._v("Flutter")]),t._v(" 模块的 "),e("code",[t._v("podhelper.rb")]),t._v(" 中，而是在 "),e("code",[t._v("packages/flutter_tools/bin/podhelper.rb")]),t._v("。")]),t._v(" "),e("p",[t._v("至于为什么原来的 "),e("code",[t._v("install_all_flutter_pods")]),t._v(" 方法不会报错，是因为在该方法内先引用了 "),e("code",[t._v("flutter_tools/bin/podhelper.rb")]),t._v("。")]),t._v(" "),e("p",[t._v("关键代码如下：")]),t._v(" "),e("div",{staticClass:"language-ruby extra-class"},[e("pre",{pre:!0,attrs:{class:"language-ruby"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token method-definition"}},[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install_all_flutter_pods")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flutter_application_path "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nil")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 就是这句")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("require")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("File")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("expand_path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("File")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("join"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'packages'")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'flutter_tools'")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'bin'")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'podhelper'")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" flutter_root"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  flutter_application_path "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("File")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("join"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'..'")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string-literal"}},[e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'..'")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  install_flutter_engine_pod"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flutter_application_path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  install_flutter_plugin_pods"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flutter_application_path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  install_flutter_application_pod"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flutter_application_path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])])]),e("p",[t._v("所以我们可以如法炮制，在 "),e("code",[t._v("install_flutter_plugin_pods")]),t._v(" 方法中加入 "),e("code",[t._v("require")]),t._v(" 这一行代码，以解决上述错误。")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("def install_flutter_plugin_pods(flutter_application_path)\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v("  require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v(" flutter_application_path ||= File.join('..', '..')\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v(" ...\n")])]),t._v("end\n\n")])])]),e("p",[t._v("老是这么改也不是个办法，所以我提了个 "),e("code",[t._v("PR")]),t._v(": https://github.com/flutter/flutter/pull/141521")]),t._v(" "),e("blockquote",[e("p",[t._v("该 "),e("code",[t._v("PR")]),t._v(" 现已合并，应该会在 "),e("code",[t._v("3.16.9")]),t._v(" 及之后的版本中生效。")])]),t._v(" "),e("p",[t._v("经过验证，该方案是可行的，下面我们来看看如何调整原生工程和 "),e("code",[t._v("Shorebird")]),t._v(" 在 "),e("code",[t._v("iOS")]),t._v(" 混编下如何使用吧。")]),t._v(" "),e("h2",{attrs:{id:"四、原生工程调整"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四、原生工程调整"}},[t._v("#")]),t._v(" 四、原生工程调整")]),t._v(" "),e("p",[t._v("在 "),e("code",[t._v("Podfile")]),t._v(" 文件中，将 "),e("code",[t._v("Flutter")]),t._v(" 壳工程的源码依赖方式调整为二进制依赖")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[e("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[e("span",{pre:!0,attrs:{class:"token prefix deleted"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v(" install_all_flutter_pods(flutter_application_path)\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v(" # 源码集成\n")]),e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v(" # install_all_flutter_pods(flutter_application_path)\n")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v(" # 二进制集成\n")]),e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v(" pod 'Flutter', path: 'xxx/flutter_modules/build/ios/framework/Release'\n")]),e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v(" install_flutter_plugin_pods(flutter_application_path)\n")])])])])]),e("ol",[e("li",[t._v("声明 "),e("code",[t._v("Flutter")]),t._v(" 依赖，用于集成 "),e("code",[t._v("Flutter.xcframework")]),t._v(" 和 "),e("code",[t._v("App.xcframework")]),t._v("。")]),t._v(" "),e("li",[e("code",[t._v("Option A")]),t._v(" 方式所需要的代码统统保留，只需要将 "),e("code",[t._v("install_all_flutter_pods")]),t._v(" 替换为 "),e("code",[t._v("install_flutter_plugin_pods")]),t._v("，用于集成 "),e("code",[t._v("Flutter")]),t._v(" 插件所依赖的原生第三方库")])]),t._v(" "),e("h2",{attrs:{id:"五、创建-shorebird-release"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五、创建-shorebird-release"}},[t._v("#")]),t._v(" 五、创建 Shorebird Release")]),t._v(" "),e("p",[t._v("打发布包的时候操作，在 "),e("code",[t._v("Flutter")]),t._v(" 工程目录下执行")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" xx/xx/flutter_modules\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 7.0.0+2: 版本号+build版本号")]),t._v("\nshorebird release ios-framework-alpha --release-version "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("7.0")]),t._v(".0+2\n")])])]),e("blockquote",[e("p",[t._v("该命令内部会去执行 "),e("code",[t._v("flutter build ios-framework --no-debug --no-profile ...")]),t._v("，并且使用的是 "),e("code",[t._v("Shorebird")]),t._v(" 魔改的 "),e("code",[t._v("Flutter")]),t._v(" 引擎！")])]),t._v(" "),e("p",[t._v("版本号可以在如下图所示进行查看")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202401211436306.png",alt:""}})]),t._v(" "),e("p",[e("code",[t._v("ShoreBird")]),t._v(" 的内部逻辑会去以这个版本号组合，向服务器请求判断是否存在相应版本的相关补丁！")]),t._v(" "),e("p",[t._v("执行完成后，在 "),e("code",[t._v("Shorebird")]),t._v(" 控制台上可以看到相应的项")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202401211437609.png",alt:""}})]),t._v(" "),e("p",[t._v("在命令执行前，请确保不存在 "),e("code",[t._v("7.0.0+2")]),t._v(" 的 "),e("code",[t._v("Release")]),t._v("，如果有的话，请先删除")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202401211437151.png",alt:""}})]),t._v(" "),e("h2",{attrs:{id:"六、创建-shorebird-patch"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#六、创建-shorebird-patch"}},[t._v("#")]),t._v(" 六、创建 Shorebird Patch")]),t._v(" "),e("p",[t._v("紧急修复线上包的bug时操作，在 "),e("code",[t._v("Flutter")]),t._v(" 工程目录下执行")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("shorebird patch ios-framework-alpha --release-version "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("7.0")]),t._v(".0+2\n")])])]),e("p",[t._v("注：版本号与上述的 "),e("code",[t._v("release")]),t._v(" 命令中使用的要保持一致！")]),t._v(" "),e("p",[t._v("执行完成后，在 "),e("code",[t._v("Shorebird")]),t._v(" 控制台上点击对应的 "),e("code",[t._v("Release")]),t._v(" 项，进去后可以看到相应的补丁")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202401211437542.png",alt:""}})]),t._v(" "),e("p",[t._v("看看这个补丁大小，我们再来看看安卓的补丁大小")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20230813121546/image/202401211438158.png",alt:""}})]),t._v(" "),e("blockquote",[e("p",[t._v("一样的修改，安卓的补丁大小不到 "),e("code",[t._v("2 MB")]),t._v("，"),e("code",[t._v("iOS")]),t._v(" 的补丁大小高达 "),e("code",[t._v("54.83 MB")]),t._v(" 😂")])]),t._v(" "),e("h2",{attrs:{id:"七、热更新验证"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#七、热更新验证"}},[t._v("#")]),t._v(" 七、热更新验证")]),t._v(" "),e("blockquote",[e("p",[t._v("官方文档上就只是说重启 "),e("code",[t._v("App")]),t._v(" 查看补丁是否生效，并没有说明失败了该如果排查问题~")])]),t._v(" "),e("p",[t._v("1、在执行完 "),e("code",[t._v("shorebird release")]),t._v(" 命令并完成上述原生工程的调整后，将原生工程的编译模式调整为 "),e("code",[t._v("Release")]),t._v(" 进行编译。")]),t._v(" "),e("p",[t._v("此时会依赖的 "),e("code",[t._v("flutter_modules/build/ios/framework/Release")]),t._v(" 下的 "),e("code",[t._v("xcframework")]),t._v("，备份为 "),e("code",[t._v("Release_release")])]),t._v(" "),e("p",[t._v("2、关闭 "),e("code",[t._v("App")]),t._v("，打 "),e("code",[t._v("patch")]),t._v("，注意，此时 "),e("code",[t._v("flutter_modules/build/ios/framework/Release")]),t._v(" 下的内容会被清空并重新创建。")]),t._v(" "),e("p",[t._v("3、打 "),e("code",[t._v("patch")]),t._v(" 后，将 "),e("code",[t._v("Release_release")]),t._v(" 改回 "),e("code",[t._v("Release")]),t._v(" 用 "),e("code",[t._v("Xcode")]),t._v(" 重新运行 "),e("code",[t._v("App")]),t._v("，一切正常的话即可看到变化。")]),t._v(" "),e("p",[t._v("无论成功还是失败，"),e("code",[t._v("Xcode")]),t._v(" 的控制台都会有相应的输出")]),t._v(" "),e("p",[t._v("成功")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2024")]),t._v("-01-03 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":37:55.838328+0800 xxx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("623")]),t._v(":70498"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("VERBOSE0:shorebird.cc"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("151")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Shorebird updater: no active patch.\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2024")]),t._v("-01-03 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":37:55.838424+0800 xxx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("623")]),t._v(":70498"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("VERBOSE0:shorebird.cc"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("155")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Starting Shorebird update\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("00:00:00.002"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("1701cb000"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" INFO   Sending patch check request: PatchCheckRequest "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" app_id: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"')]),t._v(", channel: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stable"')]),t._v(", release_version: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"7.0.0+2"')]),t._v(", patch_number: None, platform: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ios"')]),t._v(", arch: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aarch64"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("00:00:30.871"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("1701cb000"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" INFO  Patch "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" successfully installed.\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("00:00:30.871"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("1701cb000"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" INFO   Update result: Update installed\n")])])]),e("p",[t._v("失败")]),t._v(" "),e("blockquote",[e("p",[t._v("可以搜索关键字 "),e("code",[t._v("PatchCheckRequest")]),t._v(" 定位")])]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2024")]),t._v("-01-03 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":37:55.838328+0800 xxx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("623")]),t._v(":70498"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("VERBOSE0:shorebird.cc"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("151")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Shorebird updater: no active patch.\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2024")]),t._v("-01-03 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":37:55.838424+0800 xxx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("623")]),t._v(":70498"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("VERBOSE0:shorebird.cc"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("155")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Starting Shorebird update\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("00:00:00.002"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("1701cb000"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" INFO   Sending patch check request: PatchCheckRequest "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" app_id: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"')]),t._v(", channel: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stable"')]),t._v(", release_version: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"7.0.0+2"')]),t._v(", patch_number: None, platform: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ios"')]),t._v(", arch: "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aarch64"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("00:00:30.871"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("1701cb000"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ERROR  Update failed: error decoding response body: operation timed out\nCaused by:\n    operation timed out\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("00:00:30.871"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("1701cb000"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" INFO   Update thread finished with status: Update had error\n")])])]),e("p",[t._v("该失败是因为国行机特有的网络权限导致的，开启 "),e("code",[t._v("Shorebird")]),t._v(" 的自动检查更新的话，会在网络权限被赋予前去请求，结果就是失败，所以需要关闭自动检查更新，使用 "),e("a",{attrs:{href:"https://pub.dev/packages/shorebird_code_push",target:"_blank",rel:"noopener noreferrer"}},[t._v("shorebird_code_push"),e("OutboundLink")],1),t._v(" 去延迟检查。")]),t._v(" "),e("h2",{attrs:{id:"八、脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#八、脚本"}},[t._v("#")]),t._v(" 八、脚本")]),t._v(" "),e("p",[t._v("由于我们日常研发还是使用的是源码依赖的方式，只会在打最终测试包时才需要去做上述的调整操作，所以这里用我比较熟悉的 "),e("code",[t._v("Python")]),t._v(" 去制作了简易的脚本，并结合 "),e("code",[t._v("Jenkins")]),t._v(" 来辅助完成这种万年不变的无聊步骤")]),t._v(" "),e("p",[t._v("脚本已上传至 "),e("code",[t._v("Github")]),t._v(": "),e("a",{attrs:{href:"https://github.com/LinXunFeng/script_box/tree/main/flutter",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/LinXunFeng/script_box/tree/main/flutter"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("看官可自取修改~")]),t._v(" "),e("h3",{attrs:{id:"switch-flutter-integrate-py"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#switch-flutter-integrate-py"}},[t._v("#")]),t._v(" switch_flutter_integrate.py")]),t._v(" "),e("blockquote",[e("p",[t._v("切换 "),e("code",[t._v("Flutter")]),t._v(" 项目的集成方式")])]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 二进制依赖")]),t._v("\npython switch_flutter_integrate.py "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'原生工程路径'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-m")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'binary'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ios'")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 源码依赖")]),t._v("\npython switch_flutter_integrate.py "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'原生工程路径'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-m")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'source'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ios'")]),t._v(" \n")])])]),e("h3",{attrs:{id:"shorebird-py"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#shorebird-py"}},[t._v("#")]),t._v(" shorebird.py")]),t._v(" "),e("blockquote",[e("p",[t._v("自动获取版本号，并执行 "),e("code",[t._v("Shorebird")]),t._v(" 相关命令")])]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# release")]),t._v("\npython shorebird.py "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'原生工程路径'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Flutter工程路径'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-m")]),t._v(" release "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" ios\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# patch")]),t._v("\npython shorebird.py "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'原生工程路径'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Flutter工程路径'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-m")]),t._v(" patch "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" ios\n")])])]),e("p",[t._v("需要注意的是，"),e("code",[t._v("xcodeproj")]),t._v(" 和 "),e("code",[t._v("target")]),t._v(" 的名字被我固定写成 "),e("code",[t._v("OCProject")]),t._v("，如下代码中高亮的那两行，大家请先将其修改为自己的工程名再使用 "),e("code",[t._v("shorebird.py")]),t._v("。")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("def handle_ios():\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v('   """\n')]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v("   处理iOS项目\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v('   """\n')]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v("   # 1. 读取主版本号\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v("   # 请将 OCProject 修改为你们自己的工程名\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v("    xcodeproj_path = os.path.join(project_path, 'OCProject.xcodeproj')\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v("   version = ReleaseVersionTool.fetch_project_version(\n")]),e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v("       xcodeproj_path=xcodeproj_path,\n")])]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[e("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v("        target_name='OCProject',\n")])]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[e("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),e("span",{pre:!0,attrs:{class:"token line"}},[t._v("   )\n")])])])])]),e("p",[t._v("由于我比较懒，就不改成通用的了 😏")]),t._v(" "),e("h2",{attrs:{id:"九、最后"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#九、最后"}},[t._v("#")]),t._v(" 九、最后")]),t._v(" "),e("p",[t._v("虽然 "),e("code",[t._v("iOS")]),t._v(" 的热更新能用，但也仅仅只是能用，应用于很简单的应用程序，运行起来没有太明显的卡顿感知，但是稍微大点就可以感知到了，卡到怀疑人生那种，相比安卓端的没有任何性能损耗，iOS端的还需要再等等，毕竟现在 "),e("code",[t._v("iOS")]),t._v(" 还是 "),e("code",[t._v("Alpha")]),t._v(" 版本，相信不久将来 "),e("code",[t._v("Shorebird")]),t._v(" 团队会解决该问题。")]),t._v(" "),e("p",[t._v("具体关于安卓和 "),e("code",[t._v("iOS")]),t._v(" 两端之间的实现区别可以在这个 "),e("code",[t._v("issue")]),t._v(" 中查看 "),e("a",{attrs:{href:"https://github.com/shorebirdtech/shorebird/issues/871",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/shorebirdtech/shorebird/issues/871"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("本篇到此结束，感谢大家的支持，我们下次再见！ 👋")])])}),[],!1,null,null,null);e.default=r.exports}}]);