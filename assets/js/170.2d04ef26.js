(window.webpackJsonp=window.webpackJsonp||[]).push([[170],{579:function(s,t,a){"use strict";a.r(t);var e=a(21),r=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143241.jpeg",alt:""}})]),s._v(" "),t("blockquote",[t("p",[s._v("私有仓库: 在本地（局域网）搭建的一个类似公共仓库的东西，我们可以将镜像提交到私有仓库中，供局域网内的其它人拉取使用。\n本文以 "),t("code",[s._v("Registry")]),s._v(" 为例，并在提供私有仓库的主机上操作")])]),s._v(" "),t("h2",{attrs:{id:"拉取私有仓库镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#拉取私有仓库镜像"}},[s._v("#")]),s._v(" 拉取私有仓库镜像")]),s._v(" "),t("p",[s._v("请先确保你当前拥有的镜像有 "),t("code",[s._v("registry")]),s._v(" "),t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143259.png",alt:""}}),s._v("\n如果没有，可以先拉取下来")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" image pull registry\n")])])]),t("h2",{attrs:{id:"设置私有仓库地址"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#设置私有仓库地址"}},[s._v("#")]),s._v(" 设置私有仓库地址")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/docker/daemon.json\n")])])]),t("p",[s._v("修改 "),t("code",[s._v("insecure-registries")]),s._v(" 的值，提供私有仓库的主机的ip地址和端口")]),s._v(" "),t("div",{staticClass:"language-json extra-class"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  ...\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"insecure-registries"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.1.234:5000"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  ...\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("Mac软件版\n"),t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143315.png",alt:""}}),s._v(" "),t("strong",[s._v("修改后重新启动 "),t("code",[s._v("docker")]),s._v(" 服务")])]),s._v(" "),t("h2",{attrs:{id:"运行私有仓库镜像资源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#运行私有仓库镜像资源"}},[s._v("#")]),s._v(" 运行私有仓库镜像资源")]),s._v(" "),t("p",[s._v("将 "),t("code",[s._v("registry")]),s._v(" 镜像生成一个容器并运行起来")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -p 5000:5000 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第一个是容器使用的端口，第二个是本地端口，这里是本地端口映射到把容器的端口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v(":5000 registry\n")])])]),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("~/lxf ❯ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v("\n❯ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v("\nCONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS         PORTS      NAMES\nf12ad7ae43ca   registry   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/entrypoint.sh /etc…"')]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" minutes ago   Up "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" minutes   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("/tcp   nostalgic_elion\n")])])]),t("p",[s._v("此时你可以访问如下地址，如果看到 "),t("code",[s._v("{}")]),s._v(" 就说明 "),t("code",[s._v("Registry")]),s._v(" 运行正常")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("http://192.168.1.234:5000/v2/\n")])])]),t("h2",{attrs:{id:"上传镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#上传镜像"}},[s._v("#")]),s._v(" 上传镜像")]),s._v(" "),t("p",[s._v("比如此时我要将 "),t("code",[s._v("ubuntu")]),s._v(" 这个镜像上传到私有仓库")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给ubuntu镜像打一个tag，命名需为 私有仓库主机ip:端口/镜像名:[版本号,不加默认为latest]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" tag ubuntu:latest "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.234:5000/ubuntu:v0.1\n")])])]),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143336.png",alt:""}}),s._v("\n开始上传镜像至本地的私有仓库中")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker push <registry_ip>:<registry_port>/<image_name>:<image_tag>")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" push "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.234:5000/ubuntu:v0.1\n")])])]),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143349.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"拉取镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#拉取镜像"}},[s._v("#")]),s._v(" 拉取镜像")]),s._v(" "),t("p",[s._v("先将本地的 "),t("code",[s._v("v0.1")]),s._v(" 删掉")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" rmi "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.234:5000/ubuntu:v0.1\n")])])]),t("p",[s._v("拉取私有仓库中 "),t("code",[s._v("ubuntu")]),s._v(" 的 "),t("code",[s._v("0.1")]),s._v(" 版本镜像")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker pull <registry_ip>:<registry_port>/<image_name>:<image_tag>")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" pull "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.234:5000/ubuntu:v0.1\n")])])]),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143403.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"搜索镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#搜索镜像"}},[s._v("#")]),s._v(" 搜索镜像")]),s._v(" "),t("p",[t("code",[s._v("Registry")]),s._v(" 不支持通过 "),t("code",[s._v("docker search")]),s._v(" 这种方式去搜索镜像，会报 "),t("code",[s._v("404")]),s._v(" 的错误\n"),t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143415.png",alt:""}}),s._v("\n需要使用 "),t("code",[s._v("V2 API")]),s._v(" 去查询")]),s._v(" "),t("h3",{attrs:{id:"列出仓库中所有的镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#列出仓库中所有的镜像"}},[s._v("#")]),s._v(" 列出仓库中所有的镜像")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.234:5000/v2/_catalog\n")])])]),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143430.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"列出指定镜像的所有标签"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#列出指定镜像的所有标签"}},[s._v("#")]),s._v(" 列出指定镜像的所有标签")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -X GET http://<registry_ip>:<registry_port>/v2/<image_name>/tags/list")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.234:5000/v2/lxf/tags/list\n")])])]),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143447.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"删除镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#删除镜像"}},[s._v("#")]),s._v(" 删除镜像")]),s._v(" "),t("p",[s._v("查找指定标签的镜像的 "),t("code",[s._v("digest")]),s._v(" ，再根据这个 "),t("code",[s._v("digest")]),s._v(" 来删除，以删除 "),t("code",[s._v("lxf:0.2")]),s._v(" 镜像为例")]),s._v(" "),t("p",[s._v("先执行命令找到该镜像的 "),t("code",[s._v("digest")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--silent")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Accept: application/vnd.docker.distribution.manifest.v2+json"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-X")]),s._v(" GET  http://192.168.1.234:5000/v2/lxf/manifests/0.2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" Docker-Content-Digest "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print ($3)}'")]),s._v("\n")])])]),t("p",[s._v("得到输出值")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("sha256:4e4bc990609ed865e07afc8427c30ffdddca5153fd4e82c20d8f0783a291e241\n")])])]),t("p",[s._v("根据 "),t("code",[s._v("digest")]),s._v(" 来删除镜像")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--silent")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Accept: application/vnd.docker.distribution.manifest.v2+json"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-X")]),s._v(" DELETE http://192.168.1.234:5000/v2/lxf/manifests/sha256:4e4bc990609ed865e07afc8427c30ffdddca5153fd4e82c20d8f0783a291e241\n")])])]),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143500.png",alt:""}}),s._v("\n这个时候只是删除镜像的元数据，并没有真正从硬盘上删除镜像，需要执行垃圾回收才行。")]),s._v(" "),t("h3",{attrs:{id:"删除失败"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#删除失败"}},[s._v("#")]),s._v(" 删除失败")]),s._v(" "),t("p",[s._v("遇到 "),t("code",[s._v("405 UNSUPPORTED")]),s._v(" 错误\n"),t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143512.png",alt:""}})]),s._v(" "),t("p",[s._v("需要在运行 "),t("code",[s._v("Registry")]),s._v(" 容器时设置"),t("code",[s._v("REGISTRY_STORAGE_DELETE_ENABLED")]),s._v(" 为 "),t("code",[s._v("true")])]),s._v(" "),t("p",[s._v("举例")]),s._v(" "),t("p",[t("code",[s._v("docker-compose.yaml")]),s._v("：设置环境变量")]),s._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("REGISTRY_STORAGE_DELETE_ENABLED")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n")])])]),t("p",[t("code",[s._v("docker run")]),s._v("：添加参数")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# -e REGISTRY_STORAGE_DELETE_ENABLED="true"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v(":5000 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REGISTRY_STORAGE_DELETE_ENABLED")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v(" registry\n")])])]),t("h2",{attrs:{id:"垃圾回收"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#垃圾回收"}},[s._v("#")]),s._v(" 垃圾回收")]),s._v(" "),t("blockquote",[t("p",[s._v("执行垃圾回收，上述删除的镜像才会真正从硬盘上移除")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" registry的容器名 /bin/registry garbage-collect /etc/docker/registry/config.yml\n")])])]),t("p",[t("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource/image/20210131143530.png",alt:""}})])])}),[],!1,null,null,null);t.default=r.exports}}]);