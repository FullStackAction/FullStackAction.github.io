(window.webpackJsonp=window.webpackJsonp||[]).push([[191],{601:function(t,e,s){"use strict";s.r(e);var v=s(21),a=Object(v.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h2",{attrs:{id:"一、场景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、场景"}},[t._v("#")]),t._v(" 一、场景")]),t._v(" "),e("p",[t._v("之前公司有个 TV 盒子项目，需要使用厂商提供的 adb 工具才能连接设备进行调试，厂商为了安全，就在 adb 工具里加了过期时间限制，现在 adb 工具过期了，问厂商要新的，不给，让我自己改电脑时间（内心 os：这么容易就绕过去了，当初还为了安全加过期时间？纯属恶心人）。今天，领导说还要再调试查查项目 bug，我静心一想，每次都这样改时间也不是个事儿，求人不如求己，既然厂商不给力，那我就自己来动手破解吧~")]),t._v(" "),e("h2",{attrs:{id:"二、实战"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、实战"}},[t._v("#")]),t._v(" 二、实战")]),t._v(" "),e("p",[t._v("此次所需工具/条件如下：")]),t._v(" "),e("ul",[e("li",[t._v("神器 IDA")]),t._v(" "),e("li",[t._v("厂商 adb 包")]),t._v(" "),e("li",[t._v("懂一点 adb 命令")]),t._v(" "),e("li",[t._v("懂一点汇编知识")])]),t._v(" "),e("h3",{attrs:{id:"_1、准备环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1、准备环境"}},[t._v("#")]),t._v(" 1、准备环境")]),t._v(" "),e("p",[t._v("【神器 IDA】，这个网上随便找一下就有了，这里不多赘述，有能力的请支持一下正版，良心软件。")]),t._v(" "),e("p",[t._v("【厂商 adb 包】是一个 zip 压缩包，解压后，只有 3 个文件：")]),t._v(" "),e("ul",[e("li",[t._v("adb.exe")]),t._v(" "),e("li",[t._v("AdbWinApi.dll")]),t._v(" "),e("li",[t._v("AdbWinUsbApi.dll")])]),t._v(" "),e("p",[t._v("在 windows 上，为了方便在 cmd 窗口使用 adb 命令，同时为了不与 AndroidStudio 自带的 adb 冲突，我将以上 3 个文件复制到 "),e("code",[t._v("xxx\\Android\\Sdk\\platform-tools")]),t._v(" 目录下进行覆盖。")]),t._v(" "),e("blockquote",[e("p",[t._v("注意：记得备份好该目录下原本的 3 个文件哦")])]),t._v(" "),e("h3",{attrs:{id:"_2、寻找切入点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2、寻找切入点"}},[t._v("#")]),t._v(" 2、寻找切入点")]),t._v(" "),e("p",[t._v("确定好 TV 盒子的 ip 地址，打开 cmd 窗口，使用 "),e("code",[t._v("adb connect xxx")]),t._v(" 连接盒子：")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("C:"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Users"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("GitLqr"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("adb connect "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.104\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("############")]),t._v("\n")])])]),e("p",[t._v("这里的 "),e("code",[t._v("############")]),t._v(" 是厂商 adb 在验证系统时间过期后输出的，当然，此时是无法成功连上 TV 盒子的。不过呢，这个字符串输出不就是一个很好的切入点吗！！接着我们用 IDA-32bit 打开 "),e("code",[t._v("adb.exe")]),t._v(" ：")]),t._v(" "),e("blockquote",[e("p",[t._v("注意：使用 IDA 64bit 还是 32bit 是根据具体要逆向的程序而定的，这里的 "),e("code",[t._v("adb.exe")]),t._v(" 是 32 位程序，所以用的是 IDA-32bit。")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212014408.png",alt:""}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212015449.png",alt:""}})]),t._v(" "),e("p",[t._v("选中 "),e("code",[t._v("adb.exe")]),t._v(' 文件后，点 "打开" ，之后一路点 "OK" 和 "Yes"：')]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212015834.png",alt:""}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212017754.png",alt:""}})]),t._v(" "),e("blockquote",[e("p",[t._v('注意：IDA 在加载文件的时候，中途可能会提示一些 Warning 警告，不管它，继续点 "OK" 或 "Yes"。')])]),t._v(" "),e("p",[t._v("当 IDA 加载成功后，就会看到如下界面了：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212017915.png",alt:""}})]),t._v(" "),e("p",[t._v("现在需要找到前面提到的 "),e("code",[t._v("############")]),t._v(' 字符串，通过 "View -> Open subviews ->Strings" 或 按"Shift+F12" 打开字符串窗口：')]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212017609.png",alt:""}})]),t._v(" "),e("p",[t._v("此时，在 IDA 的左侧会出现一个 Strings window (字符串窗口)：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212017176.png",alt:""}})]),t._v(" "),e("p",[t._v('通过快捷键 "ctrl + f" 打开搜索栏，输入 '),e("code",[t._v("############")]),t._v(" 后回车：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212018068.png",alt:""}})]),t._v(" "),e("p",[t._v("双击该搜索结果条目，在 IDA 右侧的 IDA View-A 窗口会跳转到该字符串所在的地址处。至此，切入点的指令位置就已经找到了。")]),t._v(" "),e("h3",{attrs:{id:"_3、理清逻辑"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3、理清逻辑"}},[t._v("#")]),t._v(" 3、理清逻辑")]),t._v(" "),e("p",[t._v("在找到切入点之后，接下来就需要理清这段指令的触发时机了。注意看，在 "),e("code",[t._v("004C58E9")]),t._v(" 地址处指令后面有一段蓝色字： "),e("code",[t._v("; DATA XREF: _adb_commandline+124B")]),t._v("，这段蓝色字的意思是该指令被 "),e("code",[t._v("_adb_commandline+124B")]),t._v(" 处引用，正合我意，我们的目的就是要看，这个指令是在哪里被引用和触发的。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212018631.png",alt:""}})]),t._v(" "),e("p",[t._v("双击蓝色字之后，IDA View-A 窗口内容会发现变化，从 Text View 转变成了 Graph View，记住这个指令块的地址 "),e("code",[t._v("loc_40C110")]),t._v("：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212018125.png",alt:""}})]),t._v(" "),e("p",[t._v("按下 ctrl 键，加鼠标滚轮，可以缩放这个 Graph View：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212041766.png",alt:""}})]),t._v(" "),e("p",[t._v("沿着 "),e("code",[t._v("loc_40C110")]),t._v(" 指令块头上的绿色线条，可以找到解决该指令块的唯一源头：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212018429.png",alt:""}})]),t._v(" "),e("p",[t._v("从这个图可以知道，该 "),e("code",[t._v("loc_40BC0B")]),t._v(" 指令块使用了 "),e("code",[t._v("cmp")]),t._v(" 汇编指令，比较 2 个值的大小关系，汇编指令 "),e("code",[t._v("jg")]),t._v(" 的意思是 "),e("code",[t._v("有符号大于则跳转")]),t._v("，所以当比较结果大于 0 时，就会跳转到 "),e("code",[t._v("loc_40C110")]),t._v(" 处，即输出 "),e("code",[t._v("############")]),t._v(" 字符串，否则，往右边红色线继续执行，进入正常的 adb 操作。至此，已经把切入点的触发逻辑搞清楚了。")]),t._v(" "),e("h3",{attrs:{id:"_3、逆向汇编代码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3、逆向汇编代码"}},[t._v("#")]),t._v(" 3、逆向汇编代码")]),t._v(" "),e("p",[t._v("在弄清楚触发逻辑之后，就得考虑破解方案了，我自个想到的有如下几种破解思路：")]),t._v(" "),e("ol",[e("li",[t._v("修改获取到的时间值（难，要找到获取时间的地址处）")]),t._v(" "),e("li",[t._v("修改比较结果（难，我不知道 ebp、buf、1Fh 都是些啥）")]),t._v(" "),e("li",[t._v("修改比较逻辑（易，只需要把 "),e("code",[t._v("jg")]),t._v(" 改成能执行到红色线的其它指令即可）")])]),t._v(" "),e("p",[t._v("综上，选用方案 3，因为 "),e("code",[t._v("JG")]),t._v(" 意为 "),e("code",[t._v("有符号大于则跳转")]),t._v("，那么相反的，使用 "),e("code",[t._v("为 0 则跳转")]),t._v(" 的 "),e("code",[t._v("JZ")]),t._v(" 或 "),e("code",[t._v("有符号小于则跳转")]),t._v(" 的 "),e("code",[t._v("JL")]),t._v("，都可以达到执行红色线的目的，这里我选用 "),e("code",[t._v("JZ")]),t._v(" 指令，这样，无论电脑时间如何修改，基本上都不可能触发。（但是，如果你硬是要抬杠，那就算你说的对）")]),t._v(" "),e("blockquote",[e("p",[t._v("汇编跳转指令说明："),e("a",{attrs:{href:"https://blog.csdn.net/wq57885/article/details/80700032",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://blog.csdn.net/wq57885/article/details/80700032"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v('接下来要真正开始修改指令码了，先把 Graph View 转成 Text View，右击指令块，点击 "Text view"：')]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212018328.png",alt:""}})]),t._v(" "),e("p",[t._v("将光标移动到 "),e("code",[t._v("jg")]),t._v(" 指令那行，即 "),e("code",[t._v("0040BC12")]),t._v("：")]),t._v(" "),e("blockquote",[e("p",[t._v("注意：鼠标左击一下，确定你光标就是在那里。")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212018537.png",alt:""}})]),t._v(" "),e("p",[t._v('通过 "Edit -> Patch program -> Assemble" 打开 Assemble instruction (汇编指令) 对话框：')]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212019212.png",alt:""}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212019061.png",alt:""}})]),t._v(" "),e("p",[t._v("直接把 "),e("code",[t._v("jg")]),t._v(" 改成 "),e("code",[t._v("jz")]),t._v(' ，然后，点击 "OK"：')]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212019532.png",alt:""}})]),t._v(" "),e("p",[t._v("此时，你会发现，"),e("code",[t._v("0040BC12")]),t._v(" 处的指令成功修改成功了，但还是会有个对话框出来问你，下一行 "),e("code",[t._v("0x40BC18")]),t._v(' 处你要不要也改了，因为不需要修改，所以点击 "Cancel" 或 直接叉掉就行了：')]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212019614.png",alt:""}})]),t._v(" "),e("p",[t._v("搞定，至此，汇编指令修改成功。")]),t._v(" "),e("h3",{attrs:{id:"_4、导出成品"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4、导出成品"}},[t._v("#")]),t._v(" 4、导出成品")]),t._v(" "),e("p",[t._v("不要以为直接 "),e("code",[t._v("ctrl + s")]),t._v(" 保存就可以了，到目前为止，我们在 IDA 里所做的一切，都没有修改到原 "),e("code",[t._v("adb.exe")]),t._v(' 文件，因为这是一个由 IDA 对原程序加载解析后得到的一个 IDA 工程，我们修改的也只是这个 IDA 工程里的代码，所以，我们还需要把工程进行导出，不过，IDA 很 dio，通过 "Edit -> Patch program -> Apply patches to input file..."，可以把修改过的汇编码直接应用到原文件上：')]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212019920.png",alt:""}})]),t._v(" "),e("p",[t._v('这里还可以指定应用的地址范围，不用管，直接点 "OK" 即可：')]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212019957.png",alt:""}})]),t._v(" "),e("p",[t._v('可能会遇到 "Permission denied" 警告，这是因为 adb 进程正在运行中，只需要把 adb 进程 kill 掉，再重复上述操作即可：')]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/FullStackAction/PicBed@resource20210320170901/image/202110212019424.png",alt:""}})]),t._v(" "),e("blockquote",[e("p",[t._v("注意：除了用 windows 自带的任务管理器，还可以使用 adb 命令 "),e("code",[t._v("adb kill-server")]),t._v(" 来杀掉 adb 进程哦。")])]),t._v(" "),e("p",[t._v("应用成功后，再来执行一次 adb 连接命令：")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("C:"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Users"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("GitLqr"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("adb kill-server\n\nC:"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Users"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("GitLqr"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("adb connect "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.104\n* daemon not running. starting it now on port "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5037")]),t._v(" *\n* daemon started successfully *\nconnected to "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.104:5555\n")])])]),e("p",[t._v("perfect~")])])}),[],!1,null,null,null);e.default=a.exports}}]);